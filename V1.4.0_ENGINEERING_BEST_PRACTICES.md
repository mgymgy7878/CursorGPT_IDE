# üîß v1.4.0 Engineering Best Practices - Kritik ƒ∞yile≈ütirmeler

**Ama√ß:** Kayan nokta hatalarƒ±, saat kaymalarƒ±, enum ka√ßaklarƒ± ve idempotency √ß√∂p birikiminden koruma  
**Durum:** Hemen uygulanabilir "quick wins"  
**Etki:** Y√ºksek (production stability & data accuracy)

---

## üí∞ 1. Para Birimi ve Hassasiyet (Kritik!)

### Sorun
`Float` kullanƒ±mƒ± finansal hesaplamalarda k√ºm√ºlatif hatalara yol a√ßar:
```typescript
// ‚ùå YANLI≈û
price: Float       // 0.1 + 0.2 = 0.30000000000000004
quantity: Float
commission: Float
```

### √á√∂z√ºm
**Prisma `Decimal` + PostgreSQL `NUMERIC(38, 18)`:**

```prisma
model Trade {
  id         String   @id @default(cuid())
  strategyId String
  strategy   Strategy @relation(fields: [strategyId], references: [id])
  symbol     String
  side       String   // buy, sell
  type       String   // market, limit
  
  // ‚úÖ DOƒûRU: Decimal for precise calculations
  price      Decimal  @db.Decimal(38, 18)
  quantity   Decimal  @db.Decimal(38, 18)
  commission Decimal  @db.Decimal(38, 18) @default(0)
  pnl        Decimal? @db.Decimal(38, 18)
  
  status     TradeStatus
  exchange   String
  createdAt  DateTime @default(now())
  filledAt   DateTime?
  clientOrderId String?
  
  @@index([strategyId, createdAt])
  @@index([symbol, exchange])
  @@unique([exchange, clientOrderId])
}

model Position {
  id        String   @id @default(cuid())
  strategyId String  // ‚úÖ ADD: Strategy ownership
  symbol    String
  side      String   // long, short
  quantity  Decimal  @db.Decimal(38, 18)
  avgPrice  Decimal  @db.Decimal(38, 18)
  exchange  String
  updatedAt DateTime @updatedAt
  
  // ‚úÖ IMPROVED: Prevent paper/real collision
  @@unique([strategyId, symbol, exchange])
}
```

**TypeScript Usage:**
```typescript
import { Decimal } from '@prisma/client/runtime/library';

// Calculations
const price = new Decimal('42000.123456789');
const quantity = new Decimal('0.001');
const total = price.mul(quantity); // Precise!

// Display
const formatted = total.toFixed(2); // "42.00"
```

**Benefits:**
- ‚úÖ Zero floating-point errors
- ‚úÖ Precise PnL calculations
- ‚úÖ Accurate risk limit checks
- ‚úÖ Regulatory compliance

---

## üè∑Ô∏è 2. Durum Alanlarƒ±nƒ± Enum'a Alƒ±n

### Sorun
String status'ler type-safe deƒüil:
```typescript
// ‚ùå Typo risk
status: "filed" // should be "filled"
```

### √á√∂z√ºm
**Prisma Enum:**

```prisma
enum TradeStatus {
  pending
  submitted
  filled
  settled
  cancelled
  rejected
  expired
}

enum StrategyStatus {
  draft
  active
  paused
  stopped
  archived
}

enum BacktestStatus {
  pending
  running
  completed
  failed
  cancelled
}

model Trade {
  // ...
  status TradeStatus @default(pending)
}

model Strategy {
  // ...
  status StrategyStatus @default(draft)
}

model Backtest {
  // ...
  status BacktestStatus @default(pending)
}
```

**Benefits:**
- ‚úÖ Type safety
- ‚úÖ IDE autocomplete
- ‚úÖ Migration diffs clear
- ‚úÖ Database constraints

---

## üîê 3. Benzersizlik & B√ºt√ºnl√ºk

### Position Uniqueness

```prisma
model Position {
  id        String   @id @default(cuid())
  strategyId String  // ‚úÖ Owner dimension
  symbol    String
  side      String
  quantity  Decimal  @db.Decimal(38, 18)
  avgPrice  Decimal  @db.Decimal(38, 18)
  exchange  String
  updatedAt DateTime @updatedAt
  
  // ‚úÖ CRITICAL: Prevent paper/real collision
  @@unique([strategyId, symbol, exchange])
  @@index([exchange, symbol]) // Query optimization
}
```

### Trade Uniqueness

```prisma
model Trade {
  // ...
  clientOrderId String? // Exchange order ID
  
  // ‚úÖ Prevent duplicate exchange orders
  @@unique([exchange, clientOrderId])
}
```

### Audit Hash (HMAC)

```typescript
// lib/audit/hash.ts
import crypto from 'crypto';

function canonicalJSON(obj: unknown): string {
  if (typeof obj !== 'object' || obj === null) {
    return JSON.stringify(obj);
  }
  
  const sorted = Object.keys(obj as any)
    .sort()
    .reduce((acc, key) => {
      acc[key] = (obj as any)[key];
      return acc;
    }, {} as any);
  
  return JSON.stringify(sorted);
}

export function hmacHash(payload: unknown): string {
  const secret = process.env.AUDIT_HMAC_SECRET;
  
  if (!secret) {
    throw new Error('AUDIT_HMAC_SECRET not configured');
  }
  
  return crypto
    .createHmac('sha256', secret)
    .update(canonicalJSON(payload))
    .digest('hex');
}

// Usage
await prisma.auditLog.create({
  data: {
    action: 'order_place',
    actor: userId,
    payload: { orderId, symbol, quantity },
    hash: hmacHash({ orderId, symbol, quantity, salt: Date.now() }),
    timestamp: new Date(),
  },
});
```

**Salt Rotation:**
```typescript
// Rotate every 90 days
const ROTATION_INTERVAL = 90 * 24 * 60 * 60 * 1000;
const lastRotation = await getLastSecretRotation('AUDIT_HMAC_SECRET');

if (Date.now() - lastRotation > ROTATION_INTERVAL) {
  // Alert for manual rotation
  console.warn('‚ö†Ô∏è AUDIT_HMAC_SECRET rotation overdue');
}
```

---

## ‚è±Ô∏è 4. Idempotency Saklama & TTL

### Problem
`AuditLog` i√ßinde idempotency kayƒ±tlarƒ± sƒ±nƒ±rsƒ±z b√ºy√ºr.

### √á√∂z√ºm
**Ayrƒ± Tablo + TTL + GC:**

```prisma
enum IdempotencyStatus {
  pending   // Request in progress (prevents race)
  completed // Request completed
  failed    // Request failed
}

model IdempotencyKey {
  key        String   @id
  status     IdempotencyStatus @default(pending)
  result     Json?
  createdAt  DateTime @default(now())
  ttlAt      DateTime // Auto-expire after 24-48h
  
  @@index([ttlAt]) // For efficient GC
  @@index([createdAt]) // For monitoring
}
```

**Implementation:**
```typescript
// services/executor/src/execution/idempotency.ts

const DEFAULT_TTL_HOURS = 48;

export async function ensureIdempotent<T>(
  key: string,
  fn: () => Promise<T>
): Promise<T> {
  const ttlAt = new Date(Date.now() + DEFAULT_TTL_HOURS * 60 * 60 * 1000);
  
  // Try to create record (prevents race conditions)
  try {
    await prisma.idempotencyKey.create({
      data: {
        key,
        status: 'pending',
        ttlAt,
      },
    });
  } catch (err) {
    // Key exists - check status
    const existing = await prisma.idempotencyKey.findUnique({
      where: { key },
    });
    
    if (!existing) throw new Error('Race condition in idempotency check');
    
    if (existing.status === 'pending') {
      throw new Error('Request already in progress');
    }
    
    if (existing.status === 'completed') {
      // Return cached result
      return existing.result as T;
    }
    
    if (existing.status === 'failed') {
      throw new Error('Previous request failed');
    }
  }
  
  try {
    // Execute function
    const result = await fn();
    
    // Update with result
    await prisma.idempotencyKey.update({
      where: { key },
      data: {
        status: 'completed',
        result: result as any,
      },
    });
    
    return result;
    
  } catch (err) {
    // Mark as failed
    await prisma.idempotencyKey.update({
      where: { key },
      data: {
        status: 'failed',
        result: { error: err.message } as any,
      },
    });
    
    throw err;
  }
}
```

**GC Cron:**
```typescript
// tools/cron/gc-idempotency.ts

export async function gcIdempotencyKeys() {
  const deleted = await prisma.idempotencyKey.deleteMany({
    where: {
      ttlAt: { lt: new Date() },
    },
  });
  
  console.log(`üóëÔ∏è Deleted ${deleted.count} expired idempotency keys`);
  
  // Metric
  setGauge('spark_idempotency_gc_total', deleted.count);
}

// Run every hour
setInterval(gcIdempotencyKeys, 60 * 60 * 1000);
```

---

## ‚öõÔ∏è 5. ƒ∞≈ülemler Atomik Olsun

### Problem
Order placement race conditions ve partial failures.

### √á√∂z√ºm
**Transaction with Isolation Level:**

```typescript
// services/executor/src/execution/orders.ts

export async function placeOrder(order: OrderRequest) {
  return await prisma.$transaction(
    async (tx) => {
      // 1. Lock strategy for update (prevents concurrent orders)
      const strategy = await tx.strategy.findUnique({
        where: { id: order.strategyId },
      });
      
      if (!strategy) {
        throw new Error('Strategy not found');
      }
      
      // 2. Risk checks (with current data)
      const riskCheck = await checkRiskLimits(order, tx);
      
      if (!riskCheck.pass) {
        // Log risk block
        await tx.auditLog.create({
          data: {
            action: 'risk_block',
            actor: 'system',
            payload: { order, reason: riskCheck.reason },
            hash: hmacHash({ order, reason: riskCheck.reason }),
            timestamp: new Date(),
          },
        });
        
        throw new Error(`Risk check failed: ${riskCheck.reason}`);
      }
      
      // 3. Create trade record
      const trade = await tx.trade.create({
        data: {
          strategyId: order.strategyId,
          symbol: order.symbol,
          side: order.side,
          type: order.type,
          price: new Decimal(order.price),
          quantity: new Decimal(order.quantity),
          status: 'pending',
          exchange: order.exchange,
        },
      });
      
      // 4. Audit log
      await tx.auditLog.create({
        data: {
          action: 'order_place',
          actor: order.userId,
          payload: { tradeId: trade.id, order },
          hash: hmacHash({ tradeId: trade.id, order }),
          timestamp: new Date(),
        },
      });
      
      return trade;
    },
    {
      isolationLevel: 'RepeatableRead', // or Serializable for highest safety
      maxWait: 5000,
      timeout: 10000,
    }
  );
}
```

**Row Locking:**
```typescript
// Prevent double-fill
const positions = await tx.position.findMany({
  where: { strategyId: order.strategyId },
  // ‚úÖ Lock rows for update
  // In Prisma, use raw query for FOR UPDATE
});

// Raw SQL alternative
await tx.$executeRaw`
  SELECT * FROM "Position" 
  WHERE "strategyId" = ${strategyId} 
  FOR UPDATE SKIP LOCKED
`;
```

---

## üïê 6. Saat Senkronu & Staleness

### Problem
Makine saati kaymasƒ± yalancƒ± staleness uyarƒ±larƒ±na yol a√ßar.

### √á√∂z√ºm
**Provider Timestamp Kullanƒ±mƒ±:**

```typescript
// lib/ws/btcturk.ts

export class BtcturkWS {
  private lastProviderTs = 0; // ‚úÖ Provider timestamp, not local time
  
  onMessage(msg: any) {
    // Extract provider timestamp
    const providerTs = msg.timestamp || msg.T || Date.now();
    this.lastProviderTs = providerTs;
    
    // Calculate staleness from provider time
    const now = Date.now();
    const staleness = (now - providerTs) / 1000;
    
    // Metrics
    setGauge('spark_ws_last_provider_ts', providerTs);
    setGauge('spark_ws_staleness_seconds', staleness);
    
    // ‚úÖ Also track clock skew
    const skew = Math.abs(now - providerTs);
    if (skew > 5000) { // >5s skew
      console.warn(`‚ö†Ô∏è Clock skew detected: ${skew}ms`);
      incCounter('spark_time_skew_warnings_total');
    }
    
    setGauge('spark_time_skew_seconds', skew / 1000);
  }
}
```

**NTP Check:**
```typescript
// tools/healthcheck/ntp.ts

export async function checkNTPSync(): Promise<boolean> {
  try {
    // Use well-known NTP servers
    const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
    const data = await response.json();
    
    const serverTime = new Date(data.datetime).getTime();
    const localTime = Date.now();
    const skew = Math.abs(serverTime - localTime);
    
    // Alert if skew > 1s
    if (skew > 1000) {
      console.error(`‚ùå NTP skew: ${skew}ms`);
      return false;
    }
    
    return true;
  } catch {
    return true; // Fail open
  }
}
```

**Prometheus Metric:**
```typescript
setGauge('spark_time_skew_seconds', skew / 1000);
```

---

## üìä 7. Prometheus Histogram Buckets

### Problem
Default buckets (.005, .01, .025, ...) finansal API'ler i√ßin uygun deƒüil.

### √á√∂z√ºm
**Ger√ßek√ßi Buckets:**

```typescript
// server/metrics.ts
import { Registry, Histogram } from 'prom-client';

const register = new Registry();

// ‚úÖ Realistic buckets for financial APIs (seconds)
const apiLatency = new Histogram({
  name: 'spark_api_latency_seconds',
  help: 'API request latency',
  labelNames: ['route', 'method', 'status'],
  buckets: [0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 5], // 10ms to 5s
  registers: [register],
});

// ‚úÖ Enable exemplars (for trace correlation)
apiLatency.observe(
  { route: '/api/exec/order', method: 'POST', status: '200' },
  duration,
  { traceId: req.headers['x-trace-id'] } // Exemplar
);
```

**Grafana Query:**
```promql
# P95 latency
histogram_quantile(0.95, 
  rate(spark_api_latency_seconds_bucket[5m])
)

# SLO burn rate
(1 - (
  sum(rate(spark_api_latency_seconds_bucket{le="0.2"}[1h]))
  /
  sum(rate(spark_api_latency_seconds_count[1h]))
)) > 0.01
```

---

## üõ°Ô∏è 8. Security Headers Takviyesi

### NGINX Configuration Enhancement

```nginx
# deploy/nginx/spark-security.conf
# Include this in main server block

# Security headers (applied to all responses)
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# ‚úÖ NEW: Content Security Policy
add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss: https:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;

# ‚úÖ NEW: HSTS (HTTPS only)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# ‚úÖ NEW: Cross-Origin Policies
add_header Cross-Origin-Resource-Policy "same-origin" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# ‚úÖ NEW: Permissions Policy (formerly Feature-Policy)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# NOTE: add_header inheritance trap!
# Child location{} blocks with add_header DO NOT inherit parent headers
# Solution: Use include file for common headers

# Common headers include
include /etc/nginx/includes/security-headers.conf;
```

**Separate Include File:**
```nginx
# /etc/nginx/includes/security-headers.conf
# Include this in every location{} that needs headers

add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; ..." always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;
```

**Usage:**
```nginx
location /api/ {
    include /etc/nginx/includes/security-headers.conf;
    
    # API-specific headers
    add_header Cache-Control "no-store" always;
    
    proxy_pass http://spark_web;
}
```

---

## üîí 9. KVKK/GDPR Hijyeni

### Audit Payload Masking

```typescript
// lib/audit/mask.ts

interface MaskOptions {
  mask?: string[];      // Fields to mask completely
  hash?: string[];      // Fields to hash
  truncate?: number;    // Max payload size
}

export function maskPayload(
  payload: any,
  options: MaskOptions = {}
): any {
  const { mask = ['password', 'apiKey', 'secret'], hash = ['email', 'phone'], truncate = 10000 } = options;
  
  const masked = { ...payload };
  
  // Mask sensitive fields
  for (const field of mask) {
    if (masked[field]) {
      masked[field] = '***MASKED***';
    }
  }
  
  // Hash PII
  for (const field of hash) {
    if (masked[field]) {
      masked[field] = crypto.createHash('sha256').update(String(masked[field])).digest('hex').slice(0, 16);
    }
  }
  
  // Truncate large payloads
  const json = JSON.stringify(masked);
  if (json.length > truncate) {
    return {
      ...masked,
      _truncated: true,
      _originalSize: json.length,
    };
  }
  
  return masked;
}

// Usage
await prisma.auditLog.create({
  data: {
    action: 'user_login',
    actor: userId,
    payload: maskPayload({ email, password, ip }, { mask: ['password'] }),
    hash: hmacHash({ userId, action: 'login', timestamp: Date.now() }),
    timestamp: new Date(),
  },
});
```

**Retention Policy:**
```typescript
// GC old audit logs (e.g., >1 year)
await prisma.auditLog.deleteMany({
  where: {
    timestamp: { lt: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) },
    action: { notIn: ['order_place', 'trade_fill'] }, // Keep trading logs longer
  },
});
```

---

## üå± 10. Seed Veriyi Ortam Ko≈üullu Yapƒ±n

### Problem
Seed data production'a sƒ±zabilir.

### √á√∂z√ºm
**Environment Guards:**

```typescript
// prisma/seed.ts

const ENV = process.env.NODE_ENV || 'development';

if (ENV === 'production') {
  console.log('‚ö†Ô∏è Skipping seed in production');
  process.exit(0);
}

if (ENV === 'test') {
  console.log('üß™ Running minimal seed for tests');
  await seedMinimal();
  process.exit(0);
}

// Full seed for development
console.log('üå± Running full seed for development');
await seedDevelopment();
```

**CI Configuration:**
```yaml
# .github/workflows/test.yml

- name: Run migrations
  run: pnpm exec prisma migrate deploy
  env:
    NODE_ENV: test
    
- name: Seed database
  run: pnpm exec prisma db seed
  env:
    NODE_ENV: test # Triggers minimal seed
```

**package.json:**
```json
{
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

---

## üß™ Test Mimarisi ƒ∞yile≈ütirmeleri

### Property-Based Testing

```typescript
// __tests__/risk.property.test.ts
import fc from 'fast-check';

test('Risk guards always respect limits (property-based)', () => {
  fc.assert(
    fc.asyncProperty(
      fc.record({
        price: fc.float({ min: 1, max: 100000 }),
        quantity: fc.float({ min: 0.0001, max: 100 }),
      }),
      async (order) => {
        const notional = order.price * order.quantity;
        const result = await checkNotionalLimit(order);
        
        // Invariant: notional > MAX should always fail
        if (notional > MAX_NOTIONAL) {
          expect(result.pass).toBe(false);
        }
      }
    ),
    { numRuns: 1000 }
  );
});
```

### Contract Tests

```typescript
// __tests__/binance.contract.test.ts

test('Binance signature matches official examples', () => {
  // Official test vectors from Binance docs
  const testCases = [
    {
      params: { symbol: 'LTCBTC', side: 'BUY', type: 'LIMIT', timeInForce: 'GTC', quantity: 1, price: 0.1, timestamp: 1499827319559 },
      secret: 'NhqPtmdSJYdKjVHjA7PZj4Mge3R5YNiP1e3UZjInClVN65XAbvqqM6A7H5fATj0j',
      expected: 'c8db56825ae71d6d79447849e617115f4a920fa2acdcab2b053c4b2838bd6b71',
    },
  ];
  
  for (const tc of testCases) {
    const signature = generateBinanceSignature(tc.params, tc.secret);
    expect(signature).toBe(tc.expected);
  }
});
```

### Backtest Look-Ahead Prevention

```typescript
// services/analytics/src/backtest/guards.ts

export function validateNoLookAhead(
  trades: Trade[],
  candles: Candle[]
): boolean {
  for (let i = 0; i < trades.length; i++) {
    const trade = trades[i];
    const candleIndex = candles.findIndex(c => c.timestamp >= trade.timestamp);
    
    if (candleIndex === -1) {
      throw new Error(`Trade at ${trade.timestamp} has no corresponding candle`);
    }
    
    // ‚úÖ Trade can only use data up to current candle
    const availableData = candles.slice(0, candleIndex + 1);
    
    // Verify trade price matches candle (within slippage)
    const candle = candles[candleIndex];
    const priceOk = 
      trade.price >= candle.low * 0.99 && 
      trade.price <= candle.high * 1.01;
    
    if (!priceOk) {
      throw new Error(`Look-ahead detected: trade price ${trade.price} outside candle range [${candle.low}, ${candle.high}]`);
    }
  }
  
  return true;
}
```

### Oracle Comparison (Enhanced)

```typescript
// __tests__/backtest.oracle.test.ts

test('Backtest matches Python oracle (trades + metrics)', async () => {
  const testData = loadOHLCV('btcusdt_2024_1h.json');
  
  // Run TS backtest
  const tsResult = await runBacktest({
    code: SMA_CROSSOVER,
    data: testData,
  });
  
  // Run Python oracle
  const oracleResult = execPythonOracle('sma_crossover', testData);
  
  // Compare metrics (tolerance 0.1%)
  expect(Math.abs(tsResult.sharpe - oracleResult.sharpe)).toBeLessThan(0.001);
  expect(Math.abs(tsResult.totalReturn - oracleResult.totalReturn)).toBeLessThan(0.001);
  
  // ‚úÖ NEW: Compare trade count
  expect(tsResult.trades.length).toBe(oracleResult.trades.length);
  
  // ‚úÖ NEW: Compare entry/exit timing (Jaccard similarity)
  const tsTimestamps = new Set(tsResult.trades.map(t => t.timestamp));
  const oracleTimestamps = new Set(oracleResult.trades.map(t => t.timestamp));
  
  const intersection = [...tsTimestamps].filter(t => oracleTimestamps.has(t)).length;
  const union = new Set([...tsTimestamps, ...oracleTimestamps]).size;
  const jaccard = intersection / union;
  
  expect(jaccard).toBeGreaterThan(0.95); // 95% timing match
});
```

### WebSocket Fuzz Testing

```typescript
// __tests__/ws.fuzz.test.ts

test('WebSocket handles malformed messages gracefully', () => {
  const malformedMessages = [
    '{', // Invalid JSON
    '{"price": "not a number"}', // Wrong type
    '{"timestamp": -1}', // Invalid timestamp
    '{"price": 1e308}', // Overflow
    Array(1e6).fill('x').join(''), // Huge message
    '', // Empty
    null,
  ];
  
  for (const msg of malformedMessages) {
    expect(() => {
      handleWebSocketMessage(msg);
    }).not.toThrow(); // Should handle gracefully
  }
});
```

---

## üìà SLO ‚Üí Error Budget ‚Üí √áalƒ±≈ütƒ±rma Disiplini

### Error Budget Policy

**30-Day Error Budget:**
```typescript
// lib/observability/errorBudget.ts

const SLO_TARGET = 0.999; // 99.9% uptime
const PERIOD_DAYS = 30;

export function calculateErrorBudget(): {
  total: number;
  consumed: number;
  remaining: number;
  percentage: number;
} {
  const totalMinutes = PERIOD_DAYS * 24 * 60;
  const allowedDowntime = totalMinutes * (1 - SLO_TARGET); // 43.2 minutes
  
  // Query actual downtime from metrics
  const downtime = getActualDowntime(PERIOD_DAYS);
  
  const consumed = downtime;
  const remaining = allowedDowntime - consumed;
  const percentage = (consumed / allowedDowntime) * 100;
  
  return {
    total: allowedDowntime,
    consumed,
    remaining,
    percentage,
  };
}

// Policy enforcement
export async function checkFeatureFreeze(): Promise<boolean> {
  const budget = calculateErrorBudget();
  
  // ‚úÖ If >75% budget consumed, freeze features
  if (budget.percentage > 75) {
    console.warn('üö® ERROR BUDGET CRITICAL: Feature freeze in effect');
    
    // Update status page
    await updateStatusPage({
      status: 'degraded',
      message: 'Error budget exhausted - only critical fixes allowed',
    });
    
    return true; // Freeze
  }
  
  return false; // OK
}
```

**Prometheus Alert:**
```yaml
- alert: ErrorBudgetCritical
  expr: |
    (1 - (
      sum(rate(http_requests_total{code!~"5.."}[30d]))
      /
      sum(rate(http_requests_total[30d]))
    )) > 0.001 * 0.75
  for: 1h
  labels:
    severity: critical
  annotations:
    summary: "Error budget 75% consumed - feature freeze"
    description: "Only critical bug fixes allowed until budget recovers"
```

---

## üß∞ CI/CD ƒ∞yile≈ütirmeleri

### Prisma Drift Guard

```yaml
# .github/workflows/database-check.yml

name: Database Drift Check

on:
  pull_request:
    paths:
      - 'prisma/**'
      - 'services/**/prisma/**'

jobs:
  drift-check:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: spark_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.18.3
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Apply migrations
        run: pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/spark_test
      
      - name: Check for drift
        run: |
          pnpm exec prisma migrate diff \
            --from-schema-datamodel prisma/schema.prisma \
            --to-url $DATABASE_URL \
            --exit-code
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/spark_test
```

### Ephemeral Test Database (Testcontainers)

```typescript
// __tests__/setup/testcontainers.ts
import { PostgreSqlContainer } from '@testcontainers/postgresql';
import { PrismaClient } from '@prisma/client';

let container: PostgreSqlContainer;
let prisma: PrismaClient;

beforeAll(async () => {
  // Start ephemeral Postgres
  container = await new PostgreSqlContainer('postgres:16-alpine')
    .withDatabase('test')
    .withUsername('test')
    .withPassword('test')
    .start();
  
  const DATABASE_URL = container.getConnectionUri();
  
  // Apply migrations
  process.env.DATABASE_URL = DATABASE_URL;
  const { execSync } = require('child_process');
  execSync('pnpm exec prisma migrate deploy', { stdio: 'inherit' });
  
  // Initialize client
  prisma = new PrismaClient({ datasources: { db: { url: DATABASE_URL } } });
}, 60000);

afterAll(async () => {
  await prisma.$disconnect();
  await container.stop();
});
```

### Dependency Audit Artifact

```yaml
# .github/workflows/dependency-audit.yml

- name: Audit dependencies
  run: |
    pnpm audit --json > evidence/pnpm_audit_$(date +%Y%m%d).json
    pnpm audit --audit-level high
  continue-on-error: true

- name: Upload audit results
  uses: actions/upload-artifact@v4
  with:
    name: dependency-audit
    path: evidence/pnpm_audit_*.json
```

---

## üì° BIST Entegrasyonu - Ger√ßek√ßilik Filtresi

### Provider SLA & Rate Limits

```typescript
// packages/marketdata-bist/src/config.ts

export const BIST_PROVIDERS = {
  official: {
    name: 'BIST Official API',
    baseUrl: 'https://api.borsaistanbul.com',
    rateLimit: '100 req/min',
    latency: '<100ms',
    cost: '$$$ (Commercial license)',
    sla: '99.9%',
    penalties: 'Contract penalties for overuse',
  },
  matriks: {
    name: 'Matriks Data',
    baseUrl: 'https://api.matriks.com.tr',
    rateLimit: '60 req/min',
    latency: '<200ms',
    cost: '$$ (Licensed)',
    sla: '99.5%',
    penalties: 'Throttling, temporary ban',
  },
  delayed: {
    name: 'Delayed Public Feed',
    baseUrl: 'https://publicdata.borsaistanbul.com',
    rateLimit: '30 req/min',
    latency: '15min delay',
    cost: 'Free',
    sla: 'Best effort',
    penalties: 'None',
  },
};
```

### Fallback Strategy

```typescript
// packages/marketdata-bist/src/fallback.ts

export async function fetchBISTWithFallback(symbols: string[]) {
  const provider = process.env.BIST_PROVIDER || 'official';
  
  try {
    // Primary provider
    const data = await fetchFromProvider(provider, symbols);
    
    // Update mode metric
    setGauge('spark_bist_mode', 1, { type: 'realtime' });
    
    return data;
    
  } catch (primaryError) {
    console.warn(`‚ö†Ô∏è Primary BIST provider failed: ${primaryError.message}`);
    
    // Fallback to delayed
    try {
      const data = await fetchFromProvider('delayed', symbols);
      
      // Update mode metric
      setGauge('spark_bist_mode', 1, { type: 'delayed' });
      
      // UI badge
      await updateUIStatus({
        bist: 'degraded',
        message: 'Using delayed feed (15min)',
      });
      
      return data;
      
    } catch (fallbackError) {
      // Last resort: mock data
      setGauge('spark_bist_mode', 1, { type: 'mock' });
      
      return generateMockData(symbols);
    }
  }
}
```

### Clock Skew & Provider Timestamp

```typescript
// packages/marketdata-bist/src/staleness.ts

interface BISTTicker {
  symbol: string;
  price: number;
  providerTimestamp: number; // ‚úÖ From provider, not local
  receivedAt: number;        // Local receive time
}

export function calculateStaleness(ticker: BISTTicker): number {
  const now = Date.now();
  
  // ‚úÖ Use provider timestamp
  const staleness = (now - ticker.providerTimestamp) / 1000;
  
  // Track clock skew
  const skew = Math.abs(ticker.receivedAt - ticker.providerTimestamp);
  if (skew > 5000) {
    console.warn(`‚ö†Ô∏è BIST clock skew: ${skew}ms`);
    incCounter('spark_bist_clock_skew_warnings_total');
  }
  
  setGauge('spark_bist_staleness_seconds', staleness);
  setGauge('spark_bist_provider_ts_seconds', ticker.providerTimestamp / 1000);
  
  return staleness;
}
```

### Tick Size Normalization

```typescript
// packages/marketdata-bist/src/tickSize.ts

const TICK_SIZES = {
  'THYAO': 0.01,   // 1 kuru≈ü
  'AKBNK': 0.01,
  'GARAN': 0.01,
  // ... more symbols
};

export function alignToTickSize(symbol: string, price: number): number {
  const tickSize = TICK_SIZES[symbol] || 0.01;
  return Math.round(price / tickSize) * tickSize;
}

// Usage in order placement
const alignedPrice = alignToTickSize(order.symbol, order.price);
```

---

## üè• Runbook ƒ∞yile≈ütirmeleri

### Kill Switch (Idempotent)

```typescript
// routes/tools/kill-switch.ts

export async function POST(req: Request) {
  const { state } = await req.json(); // 'open' | 'close'
  
  const isActive = state === 'open';
  
  // Idempotent update
  await prisma.auditLog.upsert({
    where: { action: 'kill_switch' },
    create: {
      action: 'kill_switch',
      actor: 'system',
      payload: { active: isActive, timestamp: Date.now() },
      hash: hmacHash({ action: 'kill_switch', active: isActive }),
      timestamp: new Date(),
    },
    update: {
      payload: { active: isActive, timestamp: Date.now() },
      hash: hmacHash({ action: 'kill_switch', active: isActive }),
      timestamp: new Date(),
    },
  });
  
  // Update metric
  setGauge('spark_risk_killswitch_active', isActive ? 1 : 0);
  
  return Response.json({ ok: true, killSwitch: isActive });
}
```

### Rollback in 90 Seconds

**RUNBOOK_EXCHANGE_OUTAGE.md:**
```markdown
## Rollback Procedure (90 seconds)

### Commands (copy-paste ready)
```bash
# 1. Enable circuit breaker (10s)
curl -X POST http://localhost:4001/api/circuit-breaker \
  -H 'Content-Type: application/json' \
  -d '{"exchange":"binance","state":"open"}'

# 2. Switch to paper mode (10s)
export PAPER_TRADING=true
pm2 restart spark-executor

# 3. Verify no real orders (20s)
curl http://localhost:4001/api/orders?status=pending | jq '.items | length'
# Expected: 0

# 4. Check paper mode active (10s)
curl http://localhost:4001/healthz | jq '.paperMode'
# Expected: true

# 5. Monitor for 40s
for i in {1..8}; do
  curl -s http://localhost:4001/api/healthz | jq '.executor.status'
  sleep 5
done
# Expected: All "UP"
```

### Recovery (when exchange recovers)
```bash
# 1. Close circuit breaker
curl -X POST http://localhost:4001/api/circuit-breaker \
  -d '{"exchange":"binance","state":"closed"}'

# 2. Wait for 5min stability
sleep 300

# 3. Disable paper mode
export PAPER_TRADING=false
pm2 restart spark-executor

# 4. Verify real mode
curl http://localhost:4001/healthz | jq '.paperMode'
# Expected: false
```
```

---

## üìê CSP/HSTS Drop-In NGINX Block

```nginx
# /etc/nginx/includes/security-headers.conf
# Include this in every location{} that needs full security

# Content Security Policy (strict)
add_header Content-Security-Policy "
  default-src 'self';
  base-uri 'self';
  img-src 'self' data: https:;
  script-src 'self' 'unsafe-eval';
  style-src 'self' 'unsafe-inline';
  connect-src 'self' wss: https:;
  font-src 'self' data:;
  object-src 'none';
  frame-ancestors 'none';
  upgrade-insecure-requests;
" always;

# HSTS (HTTPS only, 1 year, include subdomains, preload list)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Cross-Origin Policies
add_header Cross-Origin-Resource-Policy "same-origin" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Permissions Policy (disable risky features)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;

# Classic headers
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-XSS-Protection "1; mode=block" always;
```

**Usage in spark.conf:**
```nginx
server {
    # ...
    
    location / {
        include /etc/nginx/includes/security-headers.conf;
        proxy_pass http://spark_web;
    }
    
    location /api/ {
        include /etc/nginx/includes/security-headers.conf;
        
        # API-specific cache
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        
        proxy_pass http://spark_web;
    }
}
```

---

## üéØ Migration Guide: Float ‚Üí Decimal

### Step 1: Update Schema

```bash
# Before migration, backup!
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql
```

```prisma
// prisma/schema.prisma

model Trade {
  // Change from Float to Decimal
  price      Decimal  @db.Decimal(38, 18) // Was: Float
  quantity   Decimal  @db.Decimal(38, 18)
  commission Decimal  @db.Decimal(38, 18) @default(0)
  pnl        Decimal? @db.Decimal(38, 18)
}
```

### Step 2: Generate Migration

```bash
pnpm exec prisma migrate dev --name float_to_decimal
```

### Step 3: Update Code

```typescript
// Before
const total = trade.price * trade.quantity; // ‚ùå Float math

// After
import { Decimal } from '@prisma/client/runtime/library';

const total = new Decimal(trade.price).mul(trade.quantity); // ‚úÖ Precise

// Display
const formatted = total.toFixed(8); // Crypto needs 8 decimals
```

### Step 4: Test

```typescript
test('Decimal precision maintained', () => {
  const price = new Decimal('0.1');
  const quantity = new Decimal('0.2');
  const total = price.add(quantity);
  
  expect(total.toString()).toBe('0.3'); // ‚úÖ Exact
  expect(0.1 + 0.2).not.toBe(0.3);      // ‚ùå Float fails
});
```

---

## üéì √áƒ±karƒ±lan Dersler (Uygulamaya D√∂n√ºk)

### 1. Finansal Hesaplamalar
- **Her zaman `Decimal`** kullan (price, quantity, PnL)
- Float sadece display i√ßin (chart'larda)
- Database `NUMERIC(38, 18)` yeterli hassasiyet

### 2. Zaman Y√∂netimi
- **Provider timestamp** tercih et
- NTP sync kontrol et
- Clock skew metric'i izle
- Staleness hesaplamalarƒ±nƒ± g√ºvenilir yap

### 3. Idempotency
- **Ayrƒ± tablo** + TTL + GC
- Race condition √∂nleme (`pending` status)
- 24-48h TTL yeterli

### 4. G√ºvenlik
- **CSP/HSTS** zorunlu (production)
- add_header kalƒ±tƒ±mƒ±na dikkat
- Include dosyalarƒ± kullan

### 5. Testing
- **Property-based** tests (invariants)
- **Contract tests** (external APIs)
- **Oracle comparison** (trade count + timing)
- **Fuzz testing** (WebSocket)

---

## ‚úÖ Uygulama Checklist

**Hemen (Hafta 1):**
- [ ] Prisma schema'da `Decimal` + `enum` kullan
- [ ] Position uniqueness fix (`strategyId` ekle)
- [ ] IdempotencyKey tablosu + TTL
- [ ] Audit hash HMAC'e ge√ß

**Kƒ±sa Vade (Hafta 2-3):**
- [ ] Transaction isolation level set
- [ ] Provider timestamp tracking
- [ ] Error budget policy
- [ ] Prometheus histogram buckets

**Orta Vade (Hafta 4):**
- [ ] NGINX security headers include
- [ ] Testcontainers setup
- [ ] Oracle comparison tests
- [ ] Property-based tests

**Uzun Vade (v1.5):**
- [ ] Redis cache (file cache yerine)
- [ ] Distributed tracing (OpenTelemetry)
- [ ] Chaos engineering tests

---

## üìö Referanslar

**Decimal Precision:**
- [Prisma Decimal Type](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#decimal)
- [PostgreSQL NUMERIC](https://www.postgresql.org/docs/current/datatype-numeric.html)

**Security Headers:**
- [OWASP Secure Headers](https://owasp.org/www-project-secure-headers/)
- [Mozilla Observatory](https://observatory.mozilla.org/)

**Testing:**
- [fast-check (Property Testing)](https://github.com/dubzzz/fast-check)
- [Testcontainers](https://node.testcontainers.org/)

---

## üéâ Sonu√ß

Bu iyile≈ütirmelerle sistem:
- ‚úÖ Kayma hatalarƒ±ndan korunur
- ‚úÖ Saat kaymalarƒ±ndan etkilenmez
- ‚úÖ Enum ka√ßaklarƒ±nƒ± √∂nler
- ‚úÖ Idempotency √ß√∂p biriktirmez
- ‚úÖ Atomik i≈ülemler garantili
- ‚úÖ Production-grade g√ºvenlik

**Sonu√ß:** Sadece hƒ±zlƒ± deƒüil, **√∂l√ß√ºl√º, denetlenebilir ve geri d√∂nd√ºr√ºlebilir** bir platform.

---

*"√ñl√ß√ºl√º bir makine, sadece hƒ±zlƒ± deƒüil, g√ºvenilir ko≈üar."* ‚öôÔ∏è‚ú®

---

**Created:** 2025-10-24  
**Version:** 1.0.0  
**Maintainer:** AI Assistant (Claude 4.1 Opus)

