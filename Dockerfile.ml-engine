# Dockerfile for ML Engine Service (v1.8)
FROM node:22-alpine

WORKDIR /app

# Copy workspace files
COPY package.json pnpm-workspace.yaml tsconfig.base.json ./
COPY packages ./packages
COPY services/ml-engine ./services/ml-engine

# Install pnpm and dependencies
RUN npm install -g pnpm@10.14.0 && \
    pnpm install --frozen-lockfile && \
    cd packages/ml-core && pnpm build && \
    cd ../../services/ml-engine && pnpm build

# Expose ML Engine port
EXPOSE 4010

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:4010/ml/health',(r)=>{process.exit(r.statusCode===200?0:1)})"

# Start ML Engine
CMD ["node", "services/ml-engine/dist/index.js"]

