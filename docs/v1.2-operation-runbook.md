# v1.2 Operasyon Runbook - İlk 60 Dakika

## Canary Rampası (Risk Kontrollü)

### Hedef
Gerçek ACK ile P95 < 1000ms koru, hatada hızlı geri dönüş.

### Rampa Adımları (env/flag ile)

#### 1. TRADING_MODE=shadow (0-10 dk)
- Emir imzalanır ve ölçülür, borsaya gönderilmez
- Sadece latency ve imza doğrulaması
- **Hedef**: P95 < 500ms, error rate = 0%

#### 2. TRADING_MODE=trickle (10-30 dk)
- Sadece whitelist semboller (BTCUSDT, BTCTRY)
- Çok küçük notional (50 TRY max)
- **Hedef**: P95 < 800ms, error rate < 0.1%

#### 3. TRADING_MODE=live (30-60 dk)
- Tam devre; guard'lar ON
- Hacim artışı: 1% → 5% → 20%
- **Hedef**: P95 < 1000ms, error rate < 0.5%

### Hızlı Geri Dönüş Koşulları

#### Otomatik Kill-Switch (15 dk)
- P95 Place→ACK > 2s, 10dk (critical) → kill-switch ON + paper fallback
- Invalid Nonce oranı > %1 (5dk) → clock-drift düzelt; rate geçici 1'e düş

#### Manuel Müdahale
- 401/"Invalid Nonce" artışı → NTP/clock drift kontrolü (±5s tolerans)
- 429 artışı → concurrency=1'e düş, Retry-After'a tam uy
- BIST seans dışı işlem denemeleri → session guard kontrolü

## Operasyon Adımları

### 00-10 dk: Shadow Mode
```bash
# Environment setup
export TRADING_MODE=shadow
export KILL_SWITCH=false
export MAX_OPM=2
export MAX_NOTIONAL_TRY_S=50

# Start executor
cd services/executor && pnpm dev

# Monitor
curl http://127.0.0.1:4001/guardrails/status
curl http://127.0.0.1:4001/metrics | grep spark_place_ack_duration_seconds
```

**Kontrol Noktaları:**
- [ ] P95 < 500ms
- [ ] Error rate = 0%
- [ ] Imza doğrulaması başarılı
- [ ] Clock drift < 2s

### 10-30 dk: Trickle Mode
```bash
# Switch to trickle
export TRADING_MODE=trickle
export TRICKLE_SYMBOLS=BTCUSDT,BTCTRY
export TRICKLE_MAX_TRY=50

# Restart executor
# Monitor throughput ≤ 2 opm
```

**Kontrol Noktaları:**
- [ ] P95 < 800ms
- [ ] Error rate < 0.1%
- [ ] Sadece whitelist semboller
- [ ] Notional ≤ 50 TRY

### 30-60 dk: Live Mode (Hacim Artışı)
```bash
# Switch to live
export TRADING_MODE=live
export VOLUME_RAMP_PCT=1  # 1% → 5% → 20%

# Her 15 dk'da hacim artır
# 30-45 dk: 5%
# 45-60 dk: 20%
```

**Kontrol Noktaları:**
- [ ] P95 < 1000ms
- [ ] Error rate < 0.5%
- [ ] Feed→DB < 300ms
- [ ] Rate limit ihlali yok

## Monitoring Dashboard

### Grafana Panels
- **P95 Latency**: Place→ACK ve Feed→DB P95
- **Error Rates**: BTCTurk error types
- **Clock Drift**: Server vs local time
- **Session Status**: BIST open/closed
- **Rate Limits**: 429 responses
- **Throughput**: Orders per minute

### Alert Channels
- **Warning**: Slack #alerts
- **Critical**: PagerDuty + SMS
- **Info**: Email digest

## Fail Durumda

### Hızlı Geri Dönüş
1. `KILL_SWITCH=true` + `TRADING_MODE=paper`
2. Canlı emri anında kes
3. Paper fallback aktif

### Incident Response
1. Outage notu + artefakt topla
2. `evidence/incidents/<timestamp>/` klasörü
3. Root cause analysis
4. Post-mortem raporu

### Rollback Planı
```bash
# Emergency rollback
export KILL_SWITCH=true
export TRADING_MODE=paper
export MAX_OPM=1

# Restart services
# Collect evidence
mkdir -p evidence/incidents/$(date +%Y%m%d_%H%M%S)
```

## Success Criteria

### 60 Dakika Sonunda
- [ ] P95 Place→ACK < 1000ms (sürekli)
- [ ] P95 Feed→DB < 300ms
- [ ] Error rate < 0.5%
- [ ] Rate limit ihlali yok
- [ ] Clock drift < 2s
- [ ] Audit trail tam
- [ ] Metrics eksiksiz

### Go/No-Go Decision
- **Go**: Tüm kriterler yeşil → v1.2 production ready
- **No-Go**: Herhangi bir kriter kırmızı → rollback + investigation

## Environment Variables

```bash
# Trading Mode
TRADING_MODE=shadow  # shadow | trickle | live
KILL_SWITCH=false    # true | false

# Rate Limiting
MAX_OPM=30           # Max orders per minute
MAX_NOTIONAL_TRY_S=500  # Max notional per second

# Trickle Mode
TRICKLE_SYMBOLS=BTCUSDT,BTCTRY
TRICKLE_MAX_TRY=50

# SLO Thresholds
P95_PLACE_ACK_MS=1000
P95_FEED_DB_MS=300
NONCE_ERROR_RATE_MAX=0.01
RATE_LIMIT_BURST_MAX=0.05

# Clock Drift
CLOCK_DRIFT_MS=2000
```

## Post-60m Checklist

- [ ] All SLOs green
- [ ] Error rates acceptable
- [ ] Audit trail complete
- [ ] Metrics dashboard active
- [ ] Alert channels tested
- [ ] Runbook validated
- [ ] Team trained
- [ ] Documentation updated
