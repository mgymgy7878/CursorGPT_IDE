# v1.6 Executor Recovery Plan

## Overview
Phase 4b: Wire /backtest/run to real analytics engine with cache-first strategy and Prometheus metrics integration.

## Phase 4b - Step 1: /backtest/run Real Engine Integration

### Goal
Replace deterministic handler for `/backtest/run` with real compute path using:
- DuckDB BacktestCache (loadOrFetch) → Binance fallback
- Emit Prometheus metrics (latency, errors, cache hits)
- Keep other routes as-is (wfo/portfolio/optimize)

### Implementation

#### 1. Route Wiring
**File:** `services/executor/src/routes/backtest.ts`
- POST /backtest/run → real analytics engine
- Cache-first bar loading via DuckDB
- Lazy imports to avoid bootstrap cost
- Error handling with 500 + RUN_ENGINE_ERROR

#### 2. Prometheus Metrics
**File:** `services/executor/src/routes/util/run-metrics.ts` (NEW)
- `spark_backtest_run_jobs_total{exchange,timeframe}` - Counter
- `spark_backtest_run_errors_total` - Counter
- `spark_backtest_run_latency_ms` - Histogram (buckets: 50-10000ms)

#### 3. Market Data Loader
**File:** `services/marketdata/src/history/binance.ts`
- Added `loadBinanceHistory()` wrapper for cache integration
- Returns Candle format compatible with BacktestCache

### Test Commands

#### Dev Server
```powershell
pwsh -NoProfile -File .\scripts\port-clean-4001.ps1
$env:REAL_ROUTES="run,walkforward,portfolio,optimize"
$env:WFO_THRESHOLD="0.6"
$env:OPTIMIZER_MAX_COMBINATIONS="500"
$env:OPTIMIZER_MAX_CONCURRENCY="8"
cd services\executor
node dist\executor.mjs
```

#### Cold Test (Cache Miss)
```powershell
curl -s -X POST http://127.0.0.1:4001/backtest/run `
  -H "content-type: application/json" `
  -d "{\"symbol\":\"BTCUSDT\",\"timeframe\":\"1h\",\"start\":\"2024-01-01\",\"end\":\"2024-01-07\",\"useCache\":true}"
```

#### Warm Test (Cache Hit)
```powershell
# Same payload - expect significant speed-up
curl -s -X POST http://127.0.0.1:4001/backtest/run `
  -H "content-type: application/json" `
  -d "{\"symbol\":\"BTCUSDT\",\"timeframe\":\"1h\",\"start\":\"2024-01-01\",\"end\":\"2024-01-07\",\"useCache\":true}"
```

### Evidence Collection
```powershell
cd ..\..
$ts = Get-Date -Format 'yyyyMMdd_HHmmss'
ni -ItemType Directory -Path "evidence\canary\v1.6-phase4b-run\$ts" -Force | Out-Null
(Invoke-WebRequest http://127.0.0.1:4001/metrics).Content | Out-File "evidence\canary\v1.6-phase4b-run\$ts\metrics_snapshot.txt" -Encoding utf8
"cold_vs_warm tested" | Out-File "evidence\canary\v1.6-phase4b-run\$ts\notes.txt" -Encoding utf8
```

### Acceptance Criteria

#### Cold → Warm Performance
- Second call should show bars loaded from cache
- Warm latency significantly lower than cold

#### SLO Target
- Warm P95 < 1s (1k–5k bar range)

#### Metrics Validation
- `spark_backtest_run_jobs_total{exchange,timeframe}` incrementing
- `spark_backtest_run_latency_ms_*` histogram data present
- `spark_backtest_run_errors_total` incrementing on errors

#### Error Handling
- 500 status code + RUN_ENGINE_ERROR with clear message

### Risk & Rollback

#### Known Risks
1. **Binance rate-limit / network errors**: Cold run may slow down if cache miss
   - Mitigation: retry/backoff (Phase 4b-later)
2. **DuckDB lock**: Single connection limitation
   - Test with `useCache=false` if issues arise

#### Rollback Procedure (<1 min)
```powershell
# Remove "run" from REAL_ROUTES to restore mock handler
$env:REAL_ROUTES="walkforward,portfolio,optimize"
# Restart executor
```

### Audit Log
```json
{
  "action": "v16_phase4b_wire_run_engine",
  "params": {
    "route": "POST /backtest/run",
    "cache_mode": "duckdb-first",
    "metrics": [
      "spark_backtest_run_jobs_total",
      "spark_backtest_run_latency_ms",
      "spark_backtest_run_errors_total"
    ],
    "evidence_path": "evidence/canary/v1.6-phase4b-run/"
  },
  "dryRun": false,
  "confirm_required": false,
  "reason": "Controlled transition from deterministic handler to real compute layer"
}
```

## Next Steps
- Phase 4b step-2: Wire walkforward route
- Phase 4b step-3: Wire portfolio route
- Phase 4b step-4: Wire optimize route
- Grafana dashboard integration for metrics
