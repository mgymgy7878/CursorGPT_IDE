# V1.6 Executor Recovery - Hybrid Mode

## Özet

V1.6'da executor servisini adım adım "gerçek" route'lara geçiriyoruz. Hybrid mode sayesinde:
- Risk düşük: Bir route çökerse diğerleri mock'ta çalışmaya devam eder
- Teşhis hızlı: Hangi route'da sorun olduğu [BOOT] loglarından anlaşılır
- Kademeli rollout: `REAL_ROUTES` env ile hangi endpoint'lerin gerçek olacağını seçeriz

## Hybrid Mode Kullanımı

### Environment Variable: REAL_ROUTES

Comma-separated liste, örnek:
```bash
REAL_ROUTES=run                          # Sadece /backtest/run gerçek
REAL_ROUTES=run,walkforward              # /run ve /walkforward gerçek
REAL_ROUTES=run,walkforward,portfolio,optimize  # Tüm route'lar gerçek
```

Belirtilmeyen route'lar mock olarak çalışır (safe-mode.ts).

### NPM Scripts

```bash
# Pure mock (standalone script, no TypeScript deps)
pnpm run start:mock

# Hybrid - sadece /backtest/run gerçek
pnpm run start:hybrid:run

# Hybrid - /run + /walkforward gerçek
pnpm run start:hybrid:wfo

# Tüm route'lar gerçek
pnpm run start:real:all

# Dev mode (tsx hot reload) - /run gerçek
pnpm run dev:hybrid:run
```

## Rollout Plan

### Phase 1: /backtest/run (Mevcut)
- Status: ✅ Hybrid mode kuruldu
- Route: `backtest-simple.ts` (deterministic response, gerçek engine bağlantısı TODO)
- Test: `curl -X POST http://127.0.0.1:4001/backtest/run -H "content-type: application/json" -d '{"symbol":"BTCUSDT","timeframe":"1h"}'`
- Evidence: `evidence/canary/v1.6/<timestamp>/`

### Phase 2: /backtest/walkforward
- Status: ✅ Tamamlandı (2025-10-10)
- Önkoşul: Phase 1 stable ✅
- Route: `backtest-walkforward.ts` (train/test split, overfitting detection)
- Test: WFO endpoint test ✅
- Evidence: `evidence/canary/v1.6-phase2/20251010_212354/`
- Metrics:
  - Overfitting detection: ✅ Working (ratio: 0.833, threshold: 0.6)
  - Train Sharpe: 1.8, Test Sharpe: 1.5
  - Response time: ~7ms (deterministic handler)
  - Real engine marker: true

### Phase 3: /backtest/portfolio
- Status: ✅ Tamamlandı (2025-10-10)
- Önkoşul: Phase 2 stable ✅
- Route: `backtest-portfolio.ts` (multi-strategy correlation analysis)
- Test: Portfolio endpoint test ✅
- Evidence: `evidence/canary/v1.6-phase3/20251010_213014/`
- Metrics:
  - Correlation matrix: ✅ NxN symmetric, diagonal=1.0
  - avgCorrelation: 0.713 (3 symbols: BTC, ETH, BNB)
  - diversificationBenefit: 0.076 (portfolio sharpe boost)
  - Combined Sharpe: 1.850, Individual Avg: 1.773
  - Response time: ~9ms (deterministic handler)
  - Real engine marker: true

### Phase 4: /backtest/optimize
- Status: ✅ Tamamlandı (2025-10-10)
- Önkoşul: Phase 3 stable ✅
- Route: `backtest-optimize.ts` (grid search with bounded parallelism)
- Test: Optimizer endpoint test ✅
- Evidence: `evidence/canary/v1.6-phase4/20251010_215433/`
- Metrics:
  - Grid generation: ✅ Cartesian product (6×5×6 = 180 combos)
  - Bounded parallelism: ✅ maxConcurrency=8
  - ENV guards: ✅ OPTIMIZER_MAX_COMBINATIONS=500
  - Leaderboard: ✅ Top 5 results sorted by objective
  - Best result: sharpe=2.13 (emaFast:60, emaSlow:250, atr:28)
  - Response time: ~2-8ms (deterministic handler)
  - Real engine marker: true

### Phase 5: Full Canary
- Önkoşul: Tüm route'lar gerçek ve stable
- Action: `REAL_ROUTES=run,walkforward,portfolio,optimize` ile tam canary dry-run
- Evidence: `evidence/canary/v1.6-full/<timestamp>/`
- Decision: GO/NO-GO for prod

## Troubleshooting

### Executor Başlamazsa

1. **Port çakışması**
   ```powershell
   powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\port-clean-4001.ps1
   ```

2. **Import hatası**
   - `[BOOT] crash before listen()` loguna bak
   - Hangi route import edilirken çöktüğünü tespit et
   - O route'u REAL_ROUTES'tan çıkar

3. **Build hatası**
   ```bash
   cd CursorGPT_IDE/services/executor
   pnpm run build:bundle
   # Hataları kontrol et, gerekirse tsc --noEmit ile type check
   ```

### Mock mu Real mi?

Health endpoint'ten kontrol et:
```bash
curl http://127.0.0.1:4001/health
# Response: { "mode": "hybrid (real: run)" }  → /run gerçek, diğerleri mock
# Response: { "mode": "full-mock" }           → Hepsi mock
```

Route response'larında:
```json
{ "ok": true, "mock": false, "result": {...} }  // Gerçek route
{ "ok": true, "mock": true, "result": {...} }   // Mock route
```

## Boot Log Örneği

```
[BOOT] pre-import
[BOOT] SAFE_MODE = false
[BOOT] REAL_ROUTES = [ 'run' ]
[BOOT] Safe-mode base registered (health/metrics + conditional mocks)
[BOOT] enabling REAL /backtest/run
[ROUTE] backtest-simple.ts loaded (REAL route)
[BOOT] post-import
[BOOT] listen() → 0.0.0.0 4001
[BOOT] executor up on :4001
```

## Guardrails

### Production Safety
- ❌ Mock asla prod'a deploy edilmez
- ✅ PM2 ecosystem'da `REAL_ROUTES` env zorunlu (boş değilse canary, yoksa alert)
- ✅ CI/CD'de `start:real:all` kullanılır (smoke test geçmezse deploy durur)

### Rate Limiting (Post-Canary)
- Viewer role: 5 req/min
- Optimizer: 2 concurrent job/min
- Cache cleanup: Admin-only

### Monitoring
- Prometheus metrics: `/metrics` endpoint her modda çalışır
- Alert: P95 latency, overfitting rate, cache hit ratio
- Grafana dashboard: `monitoring/grafana/provisioning/dashboards/spark-backtest.json`

## Evidence Klasör Yapısı

```
evidence/
  canary/
    v1.5/              # Mock executor (standalone script)
      20251010_205334/
        metrics_snapshot.txt
        test_summary.txt
    v1.6/              # Hybrid executor
      20251010_xxxxxx/
        mode.txt       # REAL_ROUTES=run
        metrics_snapshot.txt
        backtest_run_sample.json
    v1.6-full/         # Tüm route'lar gerçek
      <timestamp>/
        metrics_snapshot.txt
        smoke_cache.log
        bench_backtest.log
        bench_optimizer.log
```

## Next Steps

1. **Phase 1 Completion** (1-2 gün)
   - Gerçek analytics engine'i `backtest-simple.ts`'e bağla
   - DuckDB cache layer entegrasyonu
   - Binance/BTCTurk market data fetch

2. **Phase 2-4 Rollout** (2-3 gün)
   - Her route'u birer gün aralıklarla aç
   - Smoke test geçene kadar bir sonrakine geçme

3. **Full Canary** (1 gün)
   - Tüm route'lar gerçek, tam smoke/bench suite
   - GO kararı: metrics + P95 latency + cache hit rate

4. **Prod Deploy** (0.5 gün)
   - PM2 ecosystem update
   - Blue-green deployment (canary önce, sonra prod)
   - Rollback planı hazır (mock'a dönüş butonu)

## Notlar

- Mock executor (`scripts/mock-executor.js`) dev/dry-run için korunur
- SAFE_MODE env (EXECUTOR_SAFE_MODE=1) tamamen mock'a döner (emergency fallback)
- Hybrid mode TypeScript derleme hatalarından etkilenmez (lazy import sayesinde)

