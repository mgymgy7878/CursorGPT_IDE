# v1.4 Sprint Plan - Historical & Backtest Engine

## 🎯 Sprint Hedefi
AI destekli stratejileri geriye dönük test edip (PnL, drawdown, risk) kanıt üretmek; tek veri modeliyle (OHLCV) çoklu borsayı beslemek.

## 📋 Milestone'lar (10 İş Günü)

### Gün 1–2: Datasource + Normalize
- [ ] Binance klines (1m, 5m, 1h) → normalize, gap-detect + backfill
- [ ] **Kabul**: binance:BTCUSDT:1m 180 gün, eksiksiz, checksum raporu

### Gün 3–4: Storage & İndeks  
- [ ] PostgreSQL tablo/partition + COPY bulk ingest; idempotent upsert
- [ ] **Kabul**: 10M+ satır ingest P95 < 6m, aynı veriyi yeniden yükleme → no-dup

### Gün 5–7: Backtest Core v1
- [ ] Bar-based engine, cash→order→fill sim; maker/taker fee, latency=0, slippage=bps
- [ ] **Kabul**: 3 referans strateji (SMA cross, RSI contrarian, Breakout) + deterministik sonuç (seed)

### Gün 8–9: Strategy API & CLI
- [ ] Strategy interface (TS): init(ctx), onBar(bar, ctx), onEnd(ctx)
- [ ] **Kabul**: CLI 3 stratejiyi koşturur, CSV/JSON çıktı üretir

### Gün 10: Rapor & Observability
- [ ] Prometheus: bt_runs_total, bt_runtime_ms, bt_trades_total, bt_max_dd, bt_sharpe
- [ ] **Kabul**: Web dashboard kartları + günlük ops raporunda backtest özeti

## 🏗️ Teknik Mimari

### Veri Modeli (OHLCV+)
```sql
ts BIGINT (ms) | exchange TEXT | symbol TEXT | tf TEXT | o,h,l,c NUMERIC | v BASE | qv QUOTE | n INT | vwap NUMERIC
PK: (exchange, symbol, tf, ts) — BRIN/TS index, table partition by exchange+tf
UTC zorunlu; inputlar local olsa dahi normalize edilir.
```

### Paketler
- `packages/marketdata`: historical loader + normalizer
- `packages/backtest`: event loop, fill simulator, slippage/fee modeli, metrics
- `apps/web-next`: Strategy Lab → Backtest UI
- `services/analytics`: Raporlayıcı (CSV/PDF özet, Prometheus push)

## 🚀 Hızlı Uygulama

### Bugün
- [ ] packages/marketdata iskeleti + Binance fetcher + normalize + CSV dumper
- [ ] Gap detection + backfill logic

### Yarın  
- [ ] packages/backtest core + 3 strateji + CLI iskeleti
- [ ] PostgreSQL load, partition & index, bulk ingest

### Ertesi
- [ ] Prometheus metrikleri + Grafana dashboard
- [ ] Günlük ops raporu entegrasyonu

## 📊 Kanıt Çıktıları

### marketdata:load
```
rows_inserted: 2,160,000
gaps_found: 0
checksum: a1b2c3d4e5f6
```

### backtest:exec
```json
{
  "total_return": 0.15,
  "cagr": 0.12,
  "max_drawdown": -0.08,
  "sharpe": 1.45,
  "win_rate": 0.65,
  "trades": 150
}
```

### Grafana Panel
- bt_runtime_ms P95
- bt_runs_total{status}
- bt_max_dd

## 🔧 Komutlar

```bash
# Market data fetch
pnpm --filter marketdata run fetch:binance

# Backtest execution
pnpm --filter backtest run exec \
  --strategy sma_cross --symbol BTCUSDT --tf 1m \
  --from 2025-06-01 --to 2025-09-30 \
  --initial 10000 --fee-bps 10 --slippage-bps 5

# Web UI
pnpm --filter web-next run dev
```

## ✅ Definition of Done

- [ ] Binance Spot 1m/5m/1h history 180 gün (BTCUSDT, ETHUSDT)
- [ ] Backtest 3 referans strateji + CLI + JSON/CSV çıktı
- [ ] Prometheus metrikleri ve dashboard
- [ ] Günlük raporda backtest bölümü: son 24h koşular ve en iyi 3 sonuç
- [ ] Dokümantasyon: RUNBOOK.md + örnek komutlar

## 🎯 Risk & Guardrails

- **Veri kalitesi**: gap-detect + backfill; missing >0.1% ise run FAILED
- **Hesaplama deterministikliği**: random seeding zorunlu; rapora seed yaz
- **Ücret/Slippage**: default konservatif; override edilirse rapor notunda görünür
- **RBAC**: Backtest yalnızca read-only veritabanını kullanır; canlı trade'e etkisi yok
