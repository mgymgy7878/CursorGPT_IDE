# v1.4 Sprint Plan - Historical & Backtest Engine

## ğŸ¯ Sprint Hedefi
AI destekli stratejileri geriye dÃ¶nÃ¼k test edip (PnL, drawdown, risk) kanÄ±t Ã¼retmek; tek veri modeliyle (OHLCV) Ã§oklu borsayÄ± beslemek.

## ğŸ“‹ Milestone'lar (10 Ä°ÅŸ GÃ¼nÃ¼)

### GÃ¼n 1â€“2: Datasource + Normalize
- [ ] Binance klines (1m, 5m, 1h) â†’ normalize, gap-detect + backfill
- [ ] **Kabul**: binance:BTCUSDT:1m 180 gÃ¼n, eksiksiz, checksum raporu

### GÃ¼n 3â€“4: Storage & Ä°ndeks  
- [ ] PostgreSQL tablo/partition + COPY bulk ingest; idempotent upsert
- [ ] **Kabul**: 10M+ satÄ±r ingest P95 < 6m, aynÄ± veriyi yeniden yÃ¼kleme â†’ no-dup

### GÃ¼n 5â€“7: Backtest Core v1
- [ ] Bar-based engine, cashâ†’orderâ†’fill sim; maker/taker fee, latency=0, slippage=bps
- [ ] **Kabul**: 3 referans strateji (SMA cross, RSI contrarian, Breakout) + deterministik sonuÃ§ (seed)

### GÃ¼n 8â€“9: Strategy API & CLI
- [ ] Strategy interface (TS): init(ctx), onBar(bar, ctx), onEnd(ctx)
- [ ] **Kabul**: CLI 3 stratejiyi koÅŸturur, CSV/JSON Ã§Ä±ktÄ± Ã¼retir

### GÃ¼n 10: Rapor & Observability
- [ ] Prometheus: bt_runs_total, bt_runtime_ms, bt_trades_total, bt_max_dd, bt_sharpe
- [ ] **Kabul**: Web dashboard kartlarÄ± + gÃ¼nlÃ¼k ops raporunda backtest Ã¶zeti

## ğŸ—ï¸ Teknik Mimari

### Veri Modeli (OHLCV+)
```sql
ts BIGINT (ms) | exchange TEXT | symbol TEXT | tf TEXT | o,h,l,c NUMERIC | v BASE | qv QUOTE | n INT | vwap NUMERIC
PK: (exchange, symbol, tf, ts) â€” BRIN/TS index, table partition by exchange+tf
UTC zorunlu; inputlar local olsa dahi normalize edilir.
```

### Paketler
- `packages/marketdata`: historical loader + normalizer
- `packages/backtest`: event loop, fill simulator, slippage/fee modeli, metrics
- `apps/web-next`: Strategy Lab â†’ Backtest UI
- `services/analytics`: RaporlayÄ±cÄ± (CSV/PDF Ã¶zet, Prometheus push)

## ğŸš€ HÄ±zlÄ± Uygulama

### BugÃ¼n
- [ ] packages/marketdata iskeleti + Binance fetcher + normalize + CSV dumper
- [ ] Gap detection + backfill logic

### YarÄ±n  
- [ ] packages/backtest core + 3 strateji + CLI iskeleti
- [ ] PostgreSQL load, partition & index, bulk ingest

### Ertesi
- [ ] Prometheus metrikleri + Grafana dashboard
- [ ] GÃ¼nlÃ¼k ops raporu entegrasyonu

## ğŸ“Š KanÄ±t Ã‡Ä±ktÄ±larÄ±

### marketdata:load
```
rows_inserted: 2,160,000
gaps_found: 0
checksum: a1b2c3d4e5f6
```

### backtest:exec
```json
{
  "total_return": 0.15,
  "cagr": 0.12,
  "max_drawdown": -0.08,
  "sharpe": 1.45,
  "win_rate": 0.65,
  "trades": 150
}
```

### Grafana Panel
- bt_runtime_ms P95
- bt_runs_total{status}
- bt_max_dd

## ğŸ”§ Komutlar

```bash
# Market data fetch
pnpm --filter marketdata run fetch:binance

# Backtest execution
pnpm --filter backtest run exec \
  --strategy sma_cross --symbol BTCUSDT --tf 1m \
  --from 2025-06-01 --to 2025-09-30 \
  --initial 10000 --fee-bps 10 --slippage-bps 5

# Web UI
pnpm --filter web-next run dev
```

## âœ… Definition of Done

- [ ] Binance Spot 1m/5m/1h history 180 gÃ¼n (BTCUSDT, ETHUSDT)
- [ ] Backtest 3 referans strateji + CLI + JSON/CSV Ã§Ä±ktÄ±
- [ ] Prometheus metrikleri ve dashboard
- [ ] GÃ¼nlÃ¼k raporda backtest bÃ¶lÃ¼mÃ¼: son 24h koÅŸular ve en iyi 3 sonuÃ§
- [ ] DokÃ¼mantasyon: RUNBOOK.md + Ã¶rnek komutlar

## ğŸ¯ Risk & Guardrails

- **Veri kalitesi**: gap-detect + backfill; missing >0.1% ise run FAILED
- **Hesaplama deterministikliÄŸi**: random seeding zorunlu; rapora seed yaz
- **Ãœcret/Slippage**: default konservatif; override edilirse rapor notunda gÃ¶rÃ¼nÃ¼r
- **RBAC**: Backtest yalnÄ±zca read-only veritabanÄ±nÄ± kullanÄ±r; canlÄ± trade'e etkisi yok
