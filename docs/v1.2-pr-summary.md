# v1.2 BTCTurk+BIST Rampa - PR Özeti

## 6 Maddelik Özet (Kopyalanabilir)

### 1. BTCTurk+BIST Rampa (v1.2-ramp)
- **İmza/Nonce**: HMAC-SHA256 + Base64 signing, nonce, timestamp
- **Rate-limit**: Axios interceptor, Retry-After, concurrency kontrolü
- **Clock-drift**: Server time query, local offset, ±5s tolerans
- **Seans guard**: BIST weekdays 09:30-18:00, half-days 12:50, holidays

### 2. Guardrails (Prod Emniyeti)
- **Kill-switch**: Global KILL_SWITCH env, anında emir kesme
- **Rate caps**: MAX_OPM=30, MAX_NOTIONAL_TRY_S=500
- **Whitelist**: Trickle mode'da sadece BTCUSDT,BTCTRY
- **Paper fallback**: TRADING_MODE=paper otomatik devreye girme

### 3. Metrikler (Observability)
- **Place→ACK**: spark_place_ack_duration_seconds histogram
- **Feed→DB**: spark_feed_to_db_seconds histogram
- **Error tracking**: spark_exchange_errors_total, spark_http_requests_total
- **System metrics**: spark_kill_switch_active, spark_trading_mode

### 4. Alerting (SLO Monitoring)
- **P95 Warning**: Place→ACK > 1.2s, 10m
- **P95 Critical**: Place→ACK > 2s, 10m → kill-switch
- **429 Bursts**: Rate limit > 0.05/s, 3m
- **Nonce Errors**: Invalid Nonce > 1%, 5m

### 5. CI/Smoke (Quality Gates)
- **Version tag**: v1.2-ramp doğrulaması
- **Exchange metrics**: Place→ACK, Feed→DB count > 0
- **Balances dry-smoke**: BTCTurk auth/headers testi
- **Guardrails status**: Mode, kill-switch, rate limits

### 6. Runbook (Operasyonel)
- **Go/No-Go**: P95 < 1000ms, error rate < 0.5%
- **Rollback**: Kill-switch + paper fallback
- **Kanıt paketleri**: evidence/incidents/<timestamp>/
- **60m checklist**: Shadow→Trickle→Live ramp

## Teknik Detaylar

### Yeni Dosyalar
- `services/executor/src/guardrails.ts` - Runtime sertleştirme
- `services/executor/src/validation.ts` - Precision & minQty
- `services/executor/src/audit.ts` - Veri bütünlüğü
- `services/executor/src/routes/guardrails.ts` - Guardrails API
- `services/executor/src/routes/audit.ts` - Audit API
- `ops/prometheus/spark-production.rules.yml` - Production alerts
- `docs/v1.2-operation-runbook.md` - Operasyonel runbook
- `apps/web-next/components/dashboard/StabilityBadge.tsx` - UI stability
- `apps/web-next/app/api/stability/route.ts` - Stability API

### Güncellenen Dosyalar
- `tools/smoke.mjs` - Exchange metrics, guardrails, audit checks
- `apps/web-next/components/dashboard/DashboardClientDock.tsx` - Stability badge

### Environment Variables
```bash
# Trading Mode
TRADING_MODE=shadow  # shadow | trickle | live
KILL_SWITCH=false    # true | false

# Rate Limiting
MAX_OPM=30
MAX_NOTIONAL_TRY_S=500

# Trickle Mode
TRICKLE_SYMBOLS=BTCUSDT,BTCTRY
TRICKLE_MAX_TRY=50

# SLO Thresholds
P95_PLACE_ACK_MS=1000
P95_FEED_DB_MS=300
NONCE_ERROR_RATE_MAX=0.01
RATE_LIMIT_BURST_MAX=0.05

# Clock Drift
CLOCK_DRIFT_MS=2000
```

## Test Senaryoları

### Happy Path
1. **Auth Smoke**: `GET /btcturk/balances` → 200 + success:true
2. **Paper Order**: `POST /place` → 200 + dryRun:true
3. **Metrics**: Place→ACK count artışı
4. **BIST Guard**: Seans dışı → 403 + Market closed

### Error Scenarios
1. **Invalid Nonce**: 401 → clock-drift düzelt
2. **Rate Limit**: 429 → concurrency düş
3. **P95 Critical**: > 2s → kill-switch ON
4. **Session Guard**: BIST kapalı → 403

## Monitoring

### Grafana Panels
- P95 Latency (Place→ACK, Feed→DB)
- Error Rates (Nonce, 429, 5xx)
- Clock Drift
- Session Status
- Rate Limits
- Throughput

### Alert Channels
- Warning: Slack #alerts
- Critical: PagerDuty + SMS
- Info: Email digest

## Rollback Plan

### Hızlı Geri Dönüş
1. `KILL_SWITCH=true` + `TRADING_MODE=paper`
2. Canlı emri anında kes
3. Paper fallback aktif

### Incident Response
1. Outage notu + artefakt topla
2. `evidence/incidents/<timestamp>/` klasörü
3. Root cause analysis
4. Post-mortem raporu

## Success Criteria

### 60 Dakika Sonunda
- [ ] P95 Place→ACK < 1000ms (sürekli)
- [ ] P95 Feed→DB < 300ms
- [ ] Error rate < 0.5%
- [ ] Rate limit ihlali yok
- [ ] Clock drift < 2s
- [ ] Audit trail tam
- [ ] Metrics eksiksiz

### Go/No-Go Decision
- **Go**: Tüm kriterler yeşil → v1.2 production ready
- **No-Go**: Herhangi bir kriter kırmızı → rollback + investigation

## Sonraki Adımlar (v1.3)

### Guardrails+Optimization
- GC/heap profil (60 dk soak)
- prom-client objesi reuse
- HTTP keep-alive + dnsResolve: 'ipv4first'
- P95 kartına P50/P99 toggle

### Performance
- Connection pooling
- Request batching
- Metric aggregation
- Cache optimization

Sistem "görüyor + ölçüyor + kanıtlıyor"; şimdi güvenli hızlanma zamanı.
