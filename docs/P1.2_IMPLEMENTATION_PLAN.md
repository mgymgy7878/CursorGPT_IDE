# P1.2 Implementation Plan — Kalıcılık + Ölçek

## Durum: P1.1 Tamamlandı ✅

P1.1 ile "başlat → izle → sonuç al" döngüsü tamamlandı. Şimdi P1.2 ile kalıcılık ve ölçeklenebilirlik ekleniyor.

---

## 0. Mini Güvenlik / Determinism Sanity-Check ✅

### 0.1 Circular Reference Detection

- ✅ `stableStringify` artık circular reference'ları tespit ediyor
- ✅ `[Circular]` sentinel döndürüyor (stack overflow önleniyor)
- ✅ WeakSet ile memory-safe tracking

### 0.2 Token Logging Audit

- ✅ Token asla raw string olarak log'lanmıyor
- ✅ Sadece `tokenHash` (SHA256 substring) audit'te saklanıyor
- ✅ `getTokenHash()` fonksiyonu token'ı hash'e çeviriyor
- ✅ Evidence exporter'da sadece hash var
- ✅ `route.ts`'de `confirmationToken` sadece evidence tracking için okunuyor (log'lanmıyor)
- ✅ `backtestLifecycle.ts`'de token sadece return ediliyor (UI'ya gönderiliyor, log'lanmıyor)
- ✅ `console.log` veya `logger` ile token log'lanmıyor (grep doğrulandı)

---

## 1. ConfirmationTokenStore → Redis/DB Migration

### 1.1 Redis Yaklaşımı (Önerilen)

**Key Pattern:**

```
copilot:ctok:<tokenHash>
```

**Value (JSON):**

```json
{
  "paramsHash": "sha256...",
  "createdAt": 1234567890,
  "expiresAt": 1234567890
}
```

**Operations:**

1. **Create (SET NX PX):**

   ```lua
   SET copilot:ctok:<tokenHash> <json> NX PX <ttlMs>
   ```

2. **Consume (Atomik Lua Script):**

   ```lua
   local key = KEYS[1]
   local value = redis.call('GET', key)
   if value then
     redis.call('DEL', key)
     return value
   end
   return nil
   ```

   **Error Semantics:**
   - `nil` dönerse → `TOKEN_INVALID` (token hash bulunamadı)
   - Value dönerse → consume başarılı, paramsHash döner
   - TTL dolmuşsa → Redis otomatik siler, `nil` döner → `TOKEN_EXPIRED`

**Dosya Değişiklikleri:**

- `packages/ai-core/src/audit/ConfirmationTokenStore.ts` → Redis client entegrasyonu
- Yeni: `packages/ai-core/src/audit/RedisTokenStore.ts` (Redis implementation)
- `packages/ai-core/src/tools/backtestLifecycle.ts` → Redis store kullanımı

**Error Codes:**

- `TOKEN_EXPIRED` (TTL dolmuş)
- `TOKEN_USED` (zaten consume edilmiş)
- `TOKEN_INVALID` (token hash bulunamadı)

### 1.2 Postgres Yaklaşımı (Redis yoksa)

**Tablo:**

```sql
CREATE TABLE copilot_confirmation_tokens (
  token_hash VARCHAR(64) PRIMARY KEY,
  params_hash VARCHAR(64) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_expires_at ON copilot_confirmation_tokens(expires_at);
```

**Consume (Atomik):**

```sql
UPDATE copilot_confirmation_tokens
SET used_at = NOW()
WHERE token_hash = $1
  AND used_at IS NULL
  AND expires_at > NOW()
RETURNING params_hash;
```

**Error Semantics:**

- 0 row affected → `TOKEN_INVALID` (hash bulunamadı) veya `TOKEN_EXPIRED` (expires_at < NOW())
- `used_at IS NOT NULL` → `TOKEN_USED` (zaten consume edilmiş)
- 1 row affected → consume başarılı, params_hash döner

**Dosya Değişiklikleri:**

- Yeni: `packages/ai-core/src/audit/PostgresTokenStore.ts`
- Prisma schema güncellemesi

---

## 2. Full Backtest Result Retrieval

### 2.1 Seçenek A: DB JSONB + Pagination

**Tablo:**

```sql
CREATE TABLE backtest_results (
  job_id VARCHAR(255) PRIMARY KEY,
  result_jsonb JSONB NOT NULL,
  result_hash VARCHAR(64) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_result_hash ON backtest_results(result_hash);
```

**API Endpoints:**

- `GET /api/backtest/jobs/:jobId/result?part=equity&cursor=...`
- `GET /api/backtest/jobs/:jobId/result?part=trades&cursor=...`
- `GET /api/backtest/jobs/:jobId/result?part=metrics`

**Dosya Değişiklikleri:**

- Yeni: `apps/web-next/src/app/api/backtest/jobs/[jobId]/result/route.ts`
- Prisma schema: `BacktestResult` model

### 2.2 Seçenek B: S3/MinIO + Presigned URL

**Storage:**

- Key: `backtest-results/<jobId>.json.gz`
- Metadata: `resultHash`, `createdAt`

**API Endpoint:**

- `GET /api/backtest/jobs/:jobId/result/download` → presigned URL döner

**Dosya Değişiklikleri:**

- Yeni: `packages/ai-core/src/storage/S3BacktestStorage.ts`
- Yeni: `apps/web-next/src/app/api/backtest/jobs/[jobId]/result/download/route.ts`

**Kırmızı Çizgi:**

- Full sonuç tek response'ta dev JSON olarak dönmez
- Parça parça (pagination) veya download (presigned URL)

---

## 3. Observability (Prometheus Metrikleri)

### 3.1 Counter Metrikleri

```typescript
// packages/ai-core/src/metrics/copilotMetrics.ts

copilot_job_poll_total{status="done|failed|timeout|aborted"}
copilot_job_poll_abort_total
copilot_token_consume_fail_total{reason="expired|used|invalid"}
copilot_result_truncated_total{reason="trades|equity|metrics"}
```

### 3.2 Histogram Metrikleri

```typescript
copilot_tool_exec_ms{tool="getRuntimeHealth|getMarketSnapshot|..."}
copilot_job_poll_latency_ms
```

### 3.3 Gauge Metrikleri

```typescript
copilot_active_polls;
```

**Dosya Değişiklikleri:**

- Yeni: `packages/ai-core/src/metrics/copilotMetrics.ts`
- `apps/web-next/src/app/api/copilot/chat/route.ts` → metrik kayıtları
- `packages/ai-core/src/tools/backtestResult.ts` → truncation metrikleri
- `packages/ai-core/src/audit/ConfirmationTokenStore.ts` → token consume metrikleri

**Endpoint:**

- `GET /api/public/metrics` → Prometheus format

---

## 4. Smoke/Regression Test Güncellemesi

### 4.1 TTL Testi (Hızlandırılmış)

```powershell
# tools/copilot-smoke-test.ps1
$env:TOKEN_TTL_MS = "10000" # 10 saniye
# ... TTL testi artık 10 saniye içinde tamamlanır
```

### 4.2 Replay Testi

```powershell
# Test 12: Token replay
# 1. startBacktest → token al
# 2. confirmBacktest(token) → başarılı
# 3. confirmBacktest(token) → TOKEN_USED beklenir
```

### 4.3 Evidence Güncellemesi

- `errorCodes` içinde `TOKEN_EXPIRED`, `TOKEN_USED`, `TOKEN_INVALID` raporlanmalı
- `tools/copilot-smoke-test.ps1` → yeni error code kontrolleri

---

## P1.2 "Done" Kriteri

✅ **Restart atsan bile tokenlar doğru TTL ile yaşasın/ölsün**
✅ **Replay mümkün olmasın (atomik consume)**
✅ **Full result güvenli şekilde alınabilsin (pagination veya download)**
✅ **Bütün bunlar metriklere yansısın (Prometheus)**

---

## Dosya Bazlı Checklist

### Redis Token Store

- [ ] `packages/ai-core/src/audit/RedisTokenStore.ts` (yeni)
- [ ] `packages/ai-core/src/audit/ConfirmationTokenStore.ts` → Redis adapter
- [ ] `packages/ai-core/src/tools/backtestLifecycle.ts` → Redis store kullanımı
- [ ] Error codes: `TOKEN_EXPIRED`, `TOKEN_USED`, `TOKEN_INVALID`

### Full Result Retrieval

- [ ] Seçenek A: `apps/web-next/src/app/api/backtest/jobs/[jobId]/result/route.ts` (pagination)
- [ ] Seçenek B: `packages/ai-core/src/storage/S3BacktestStorage.ts` + download endpoint
- [ ] Prisma schema: `BacktestResult` model (Seçenek A için)

### Observability

- [ ] `packages/ai-core/src/metrics/copilotMetrics.ts` (yeni)
- [ ] `apps/web-next/src/app/api/copilot/chat/route.ts` → metrik kayıtları
- [ ] `packages/ai-core/src/tools/backtestResult.ts` → truncation metrikleri
- [ ] `packages/ai-core/src/audit/ConfirmationTokenStore.ts` → token metrikleri
- [ ] `apps/web-next/src/app/api/public/metrics/route.ts` → Prometheus export

### Smoke Test

- [ ] `tools/copilot-smoke-test.ps1` → TTL testi (TOKEN_TTL_MS=10000)
- [ ] `tools/copilot-smoke-test.ps1` → Replay testi (TOKEN_USED)
- [ ] Evidence kontrolü → yeni error codes

---

## 5. Live Data Layer (UI'dan Bağımsız Canlı Veri Katmanı)

**Detaylı Plan:** `docs/LIVE_DATA_LAYER_ARCHITECTURE.md`
**Minimum Patch Plan:** `docs/P1.2_LIVE_LAYER_MINIMUM_PATCH.md`

**Özet:**

- Veri düzlemi (Data Plane) ile görünüm düzlemini (View Plane) ayır
- Tek tip envelope formatı (v, event, channel, seq, ts, ok, errorCode, data)
- Transport: WS (market), SSE (copilot), polling (jobs) - hepsi aynı envelope
- Backend: Normalizer + PubSub (Redis) + Gateway
- Client: LiveClient + Store (Zustand) + Selectors
- UI: sadece hooks kullanır (usePrice, useCandles, useCopilotStream, useJob)

**P1.2 Kritik Noktalar:**

- **Paket sınırı:** `@spark/live-core` (React yok) + `@spark/live-react` (React var)
- **Channel allowlist + auth:** Kullanıcı/rol bazlı channel izinleri
- **Event contract runtime doğrulama:** Zod schema (gateway çıkışında + client girişinde)
- **Staleness semantiği:** Tek yerde hesaplama (`computeStaleness`)
- **Backpressure:** Drop oldest + warn event (max 100-200 event/channel)
- **Migration:** Önce Copilot'u Live Layer'a taşı (en düşük risk)

**P1.2 Adımları:**

- [ ] Paket oluşturma: `@spark/live-core` + `@spark/live-react`
- [ ] Envelope + Zod validation
- [ ] LiveClient (SSE adapter)
- [ ] Staleness (tek yerde hesaplama)
- [ ] Backpressure (drop oldest + warn)
- [ ] Store + hooks (`useCopilotStream`)
- [ ] Copilot migration (SSE → envelope, CopilotDock → hook)
- [ ] StatusBar → Live status indicators
- [ ] Güvenlik: Channel allowlist + rate limit
- [ ] Smoke test: "UI parsing yok" + "backpressure_drop event"

---

## Notlar

- **Token Hash Lookup:** Raw token asla saklanmaz, sadece hash
- **Atomik Consume:** Redis Lua script veya Postgres UPDATE ... RETURNING
- **Full Result:** Tek response'ta dev JSON yok, pagination veya download
- **Metrikler:** Evidence ile birleşince "kanıt + metrik" çifti oluşur
- **Live Data Layer:** UI refactor'lar veri akışını bozmaz (platform katmanı)
