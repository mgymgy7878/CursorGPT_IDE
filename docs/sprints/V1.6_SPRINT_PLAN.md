# V1.6 Sprint Plan - Advanced Optimization & Live Streams

**Sprint Ba≈ülangƒ±√ß**: TBD (Post-V1.5 Deployment)  
**Tahmini S√ºre**: 1 hafta (7 g√ºn)  
**√ñncelik**: Y√ºksek  
**Baƒüƒ±mlƒ±lƒ±klar**: V1.5 (Backtest Optimization) ‚úÖ Tamamlandƒ±  

---

## üéØ Sprint Hedefleri

V1.5'te olu≈üturulan **optimization loop**'u production ortamƒ±na ta≈üƒ±mak ve ger√ßek zamanlƒ± akƒ±≈ülarla entegre etmek:

1. **Intelligent Optimization**: Genetic/Bayesian algorithms (vs brute-force grid)
2. **Cost Modeling**: Rebalance costs (fee+slippage) ile ger√ßek portf√∂y sim√ºlasyonu
3. **UX Enhancements**: Scenario presets + one-click WFO validation
4. **Live Integration**: Paper signals from optimized params
5. **Export@Scale**: Imzalƒ± CSV/JSON export (10k+ satƒ±r)

---

## üìã G√∂revler

### 1. Genetic/Bayesian Optimizer (Y√ºksek √ñncelik)

**Problem**: Grid search 500+ kombinasyon i√ßin yava≈ü (>45s)

**√á√∂z√ºm**: Intelligent search algorithms

#### 1a. Genetic Algorithm

**Approach**:
- Population: 50 param sets
- Selection: Top 10 (elitism)
- Crossover: 2-point
- Mutation: 10% rate
- Generations: 20

**Expected**: 500 combos ‚Üí 1000 evals (2x better coverage, 10x faster)

**Implementation**:
```typescript
// services/analytics/src/backtest/genetic-optimizer.ts
export function runGeneticOptimization(
  candles: any[],
  backtestFn: Function,
  paramBounds: { emaFast: [min, max], ... },
  config: { populationSize, generations, mutationRate }
): OptimizationResult
```

#### 1b. Bayesian Optimization

**Approach**:
- Surrogate model: Gaussian Process
- Acquisition: Expected Improvement
- Iterations: 50

**Expected**: Find optimum in ~50 evaluations (vs 500 grid)

**Libraries**: `gaussian-process-optimization` or custom MVP

**Effort**: 2 days

---

### 2. Rebalance Maliyet Modeli (Orta √ñncelik)

**Problem**: Portf√∂y rebalance modu sadece "none" destekliyor

**√á√∂z√ºm**: Daily/weekly rebalance + fee/slippage modelleme

**Implementation**:
```typescript
type RebalanceCost = {
  feeBps: number;           // 10 bps = 0.1%
  slippageBps: number;      // 5 bps = 0.05%
  minTrade: number;         // $50 minimum (dust √∂nleme)
};

function rebalancePortfolio(
  currentWeights: number[],
  targetWeights: number[],
  portfolioValue: number,
  costs: RebalanceCost
): {
  newWeights: number[];
  totalCost: number;
  trades: Array<{ symbol: string; size: number; cost: number }>;
}
```

**Config**:
```json
{
  "rebalance": "daily",
  "rebalanceCosts": {
    "feeBps": 10,
    "slippageBps": 5,
    "minTrade": 50
  }
}
```

**Metrics**:
- `spark_portfolio_rebalance_cost_total` (Counter)
- `spark_portfolio_rebalance_trades_total` (Counter)

**Effort**: 1 day

---

### 3. UI Scenario Presets (Orta √ñncelik)

**Problem**: Kullanƒ±cƒ±lar her seferinde aynƒ± parametreleri giriyor

**√á√∂z√ºm**: localStorage ile preset save/load

**Features**:
a. **Save Preset**
```typescript
function savePreset(name: string) {
  const preset = {
    name,
    symbol,
    timeframe,
    start,
    end,
    strategy: { emaFast: 20, emaSlow: 50 }
  };
  
  const existing = JSON.parse(localStorage.getItem('backtest_presets') || '[]');
  localStorage.setItem('backtest_presets', JSON.stringify([...existing, preset]));
}
```

b. **One-Click WFO Validation**
```tsx
<button onClick={async () => {
  const wfo = await fetch('/api/backtest/walkforward', {
    method: 'POST',
    body: JSON.stringify({ ...optimResult.bestParams })
  }).then(r => r.json());
  
  if (wfo.result.overfitting.detected) {
    alert('‚ö†Ô∏è Overfitting! Try 2nd best params.');
  } else {
    alert('‚úÖ Valid! Deploy ready.');
  }
}}>
  üîç WFO ile Doƒürula
</button>
```

**Effort**: 4 hours

---

### 4. Live Paper Signals (Y√ºksek √ñncelik)

**Problem**: Optimized params manuel olarak strategy'ye kopyalanƒ±yor

**√á√∂z√ºm**: Auto-generate paper signals from optimized params

**Flow**:
1. User runs optimizer ‚Üí gets best params
2. Click "üî¥ Paper Sinyalleri Ba≈ülat"
3. Backend creates paper strategy instance
4. WebSocket stream: Real-time signals (no execution)
5. User monitors performance before going live

**Implementation**:
```typescript
// services/executor/src/routes/paper-signals.ts
app.post('/paper/start', async (req) => {
  const { symbol, params } = req.body;
  const strategyId = createPaperStrategy(symbol, params);
  
  // Start WebSocket stream
  startSignalStream(strategyId);
  
  return { ok: true, strategyId, streamUrl: `/ws/paper/${strategyId}` };
});
```

**WebSocket Message**:
```json
{
  "type": "signal",
  "timestamp": 1696950000000,
  "symbol": "BTCUSDT",
  "side": "BUY",
  "reason": "EMA crossup",
  "params": { "emaFast": 20, "emaSlow": 50 },
  "price": 45000,
  "confidence": 0.85
}
```

**Effort**: 1 day

---

### 5. Export@Scale (Orta √ñncelik)

**Problem**: B√ºy√ºk backtest sonu√ßlarƒ± browser'da g√∂r√ºnt√ºlenemez

**√á√∂z√ºm**: CSV/JSON export with signing

**Features**:
- Export backtest results (equity curve, trades)
- Export optimization leaderboard
- Export portfolio correlation matrix
- Signed exports (SHA256 hash + timestamp)

**Implementation**:
```typescript
app.post('/backtest/export', async (req) => {
  const { jobId, format } = req.body;
  const result = getJobResult(jobId);
  
  if (format === 'csv') {
    const csv = convertToCSV(result);
    const signature = crypto.createHash('sha256').update(csv).digest('hex');
    
    return {
      ok: true,
      data: csv,
      signature,
      timestamp: Date.now()
    };
  }
});
```

**Effort**: 1 day

---

## üóìÔ∏è Sprint Timeline

| G√ºn | G√∂rev | Deliverable |
|-----|-------|-------------|
| **1-2** | Genetic + Bayesian optimizer | Intelligent search working |
| **3** | Rebalance cost model | Daily/weekly modes |
| **4** | UI presets + WFO one-click | UX enhancements |
| **5** | Paper signals (WebSocket) | Live stream working |
| **6** | Export@Scale | Signed CSV/JSON |
| **7** | Testing + docs | Final report |

---

## üéØ Success Criteria

### Performance
- ‚úÖ Genetic optimizer: 50 evals finds optimum (vs 500 grid)
- ‚úÖ Bayesian: 30-50 evals (vs 200+ grid)
- ‚úÖ P95 latency korunuyor (<8s)

### Features
- ‚úÖ Rebalance cost tracking √ßalƒ±≈üƒ±yor
- ‚úÖ UI presets save/load working
- ‚úÖ One-click WFO validation
- ‚úÖ Paper signals streaming (WebSocket)
- ‚úÖ Export with signature

### Quality
- ‚úÖ Docs updated (5 new guides)
- ‚úÖ Tests passing (automated)
- ‚úÖ No regressions (V1.5 features intact)

---

## üì¶ Estimated Deliverables

- **New Files**: ~20
- **Updated Files**: ~5
- **Code Lines**: ~2,000
- **New Metrics**: ~10
- **New Endpoints**: ~5
- **Documentation**: ~1,500 lines

---

**Sprint Plan Date**: 10 Ekim 2025  
**Author**: Cursor (Claude 3.5 Sonnet)  
**Sprint**: V1.6 - Advanced Optimization & Live Streams

