# V1.5 Sprint Kickoff - Streams & Observability (Backtest Optimization)

**BaÅŸlangÄ±Ã§ Tarihi**: 10 Ekim 2025  
**BaÄŸÄ±mlÄ±lÄ±k**: V1.4 (H1 Backtest Engine) âœ… TamamlandÄ±  
**Durum**: ğŸš€ BAÅLATILDI  
**Tahmini SÃ¼re**: 5 gÃ¼n  

---

## ğŸ¯ Sprint Vizyonu

> "V1.4'te oluÅŸturulan backtest MVP'sini Ã¼retim-seviyesine Ã§Ä±karmak:  
> 10x performans artÄ±ÅŸÄ± + walk-forward validation + gÃ¶rsel analytics + optimization API"

### Neden V1.5?

V1.4 ile Spark'Ä±n strateji dÃ¶ngÃ¼sÃ¼nÃ¼n **Ã¼Ã§te biri** kapandÄ±:
```
âœ… (1) Veri AkÄ±ÅŸÄ± (Portfolio + Market Data)
âœ… (2) Strateji Analizi (Backtest Engine)
ğŸ”œ (3) Ã–ÄŸrenme & Optimizasyon (V1.5)
```

V1.5, sistemin **Ã¶ÄŸrenme ve optimizasyon** kÄ±smÄ±nÄ± aÃ§Ä±yor. Bu sprint sonunda:
- Backtest sonuÃ§larÄ± **10x daha hÄ±zlÄ±** (DuckDB cache)
- Stratejiler **overfitting'e karÅŸÄ± korunmuÅŸ** (walk-forward)
- Performans **gÃ¶rsel olarak analiz edilebilir** (equity charts)
- Parametre optimizasyonu **otomatik** (grid search API)

---

## ğŸ“Š Sprint Scope

### 1. DuckDB/Parquet Cache (ğŸ”¥ YÃ¼ksek Ã–ncelik)

**Problem**: Her backtest iÃ§in tarihsel veri tekrar Ã§ekiliyor (Binance API)  
**Ã‡Ã¶zÃ¼m**: Persistent local cache ile 10x hÄ±z artÄ±ÅŸÄ±

**Implementation**:
- `services/analytics/src/backtest/cache.ts` - DuckDB interface
- `services/analytics/src/backtest/duckdb-init.sql` - Schema
- Cache hit/miss metrics (Prometheus)

**Acceptance**: 
- First run: ~5s (API fetch)
- Cached run: < 100ms (local read)
- Auto-cleanup (30 gÃ¼n retention)

**Estimated**: 1 gÃ¼n

---

### 2. Walk-Forward Optimization (ğŸ”¥ YÃ¼ksek Ã–ncelik)

**Problem**: Backtest sonuÃ§larÄ± geÃ§miÅŸe bakarak optimize edilmiÅŸ olabilir (overfitting)  
**Ã‡Ã¶zÃ¼m**: Train/validate/test split + rolling window

**Implementation**:
- `services/analytics/src/backtest/walk-forward.ts`
- 60% train / 20% validate / 20% test
- Out-of-sample Sharpe ratio reporting

**Acceptance**:
- Train/val/test metrikleri ayrÄ± raporlanÄ±yor
- Overfitting warning (train >> test)

**Estimated**: 1.5 gÃ¼n

---

### 3. Multi-Asset Backtests (âš¡ Orta Ã–ncelik)

**Problem**: Tek-asset testleri portfÃ¶y diversification'Ä± gÃ¶stermiyor  
**Ã‡Ã¶zÃ¼m**: Portfolio-level backtest (2-10 assets)

**Implementation**:
- `services/analytics/src/backtest/portfolio.ts`
- Korelasyon matrisi
- Diversification benefit metrics

**Acceptance**:
- 2-10 asset destekleniyor
- Correlation matrix raporu

**Estimated**: 1 gÃ¼n

---

### 4. UI Charts & Visualization (âš¡ Orta Ã–ncelik)

**Components**:
a. **Equity Curve Chart** (Recharts)
   - Interactive line chart
   - Hover tooltips
   - Responsive design

b. **Trade Breakdown Table**
   - Entry/exit details
   - PnL per trade (color-coded)
   - CSV export

**Files**:
- `apps/web-next/src/components/backtest/EquityCurve.tsx`
- `apps/web-next/src/components/backtest/TradeTable.tsx`

**Acceptance**:
- Charts render < 500ms
- Mobile-friendly

**Estimated**: 1 gÃ¼n

---

### 5. Optimization API (ğŸ”¥ YÃ¼ksek Ã–ncelik)

**Endpoint**: `POST /api/exec/optimize`

**Features**:
- Grid search (cartesian product)
- Best params by objective (sharpe/pnl/winrate)
- Prometheus metric: `spark_optimization_runs_total`

**Implementation**:
- `services/analytics/src/backtest/optimize.ts`
- `services/executor/src/routes/optimize.ts` (UPDATE)

**Acceptance**:
- 36 combinations < 30s
- Best params returned

**Estimated**: 1 gÃ¼n

---

### 6. Performance Testing (ğŸ“Š Orta Ã–ncelik)

**Benchmarks**:
- P95 latency (1k bar): < 500ms
- P95 latency (50k bar): < 8s
- Memory per job: < 100MB

**Deliverable**:
- `services/analytics/tests/performance/backtest.test.ts`
- `docs/sprints/V1.5_PERFORMANCE_RESULTS.md`

**Estimated**: 0.5 gÃ¼n

---

## ğŸ—“ï¸ Sprint Timeline

| GÃ¼n | GÃ¶revi | Deliverable | Durum |
|-----|--------|-------------|-------|
| **1** | DuckDB cache impl | Cache working + metrics | ğŸš€ BaÅŸlÄ±yor |
| **2** | Walk-forward impl | Train/test split OK | â³ Bekliyor |
| **3** | Multi-asset + Optimize API | Portfolio + grid search | â³ Bekliyor |
| **4** | UI charts + tables | Equity curve + breakdown | â³ Bekliyor |
| **5** | Performance tests + docs | Benchmarks + final report | â³ Bekliyor |

---

## ğŸ¯ Sprint Goals (OKRs)

### Objective 1: Performance Excellence
- **KR1**: Cache hit ratio > 80% (1 hafta iÃ§inde)
- **KR2**: P95 latency < 8s (50k bar)
- **KR3**: Throughput 100 backtest/hour

### Objective 2: Reliability & Validation
- **KR1**: Walk-forward implemented (train/val/test)
- **KR2**: Overfitting detection > 90% accuracy
- **KR3**: Multi-asset correlation < 0.7 (diversification)

### Objective 3: Developer Experience
- **KR1**: UI charts < 500ms render time
- **KR2**: Optimization API < 30s (36 runs)
- **KR3**: Docs coverage > 90%

---

## ğŸš§ Riskler

| Risk | OlasÄ±lÄ±k | Etki | Mitigasyon |
|------|----------|------|------------|
| DuckDB entegrasyonu | Orta | YÃ¼ksek | Fallback to in-memory (v1.4) |
| Optimization timeout | DÃ¼ÅŸÃ¼k | Orta | Async job + SSE stream |
| UI performance (large datasets) | Orta | DÃ¼ÅŸÃ¼k | Downsampling (max 500 pts) |

---

## ğŸ“¦ Dependencies

### NPM Packages
```json
{
  "duckdb": "^0.9.0",
  "recharts": "^2.10.0",
  "papaparse": "^5.4.0"
}
```

### System Requirements
- DuckDB binary (auto-installed)
- Disk space: 1GB (cache)

---

## âœ… Definition of Done

Sprint V1.5 tamamlanmÄ±ÅŸ sayÄ±lÄ±r eÄŸer:

1. âœ… DuckDB cache Ã§alÄ±ÅŸÄ±yor (hit ratio > 50%)
2. âœ… Walk-forward validation implemented
3. âœ… Multi-asset backtest (2+ assets)
4. âœ… Equity curve chart rendered
5. âœ… Trade breakdown table working
6. âœ… Optimization API endpoint live
7. âœ… Performance benchmarks passed
8. âœ… Docs updated (guide + API ref)
9. âœ… No critical bugs
10. âœ… Prometheus metrics > 10 new counters

---

## ğŸ”— Ä°lgili DokÃ¼mantasyon

- **V1.4 Completion**: `docs/sprints/V1.4_COMPLETION_REPORT.md`
- **V1.5 Plan**: `docs/sprints/V1.5_SPRINT_PLAN.md`
- **Backtest Guide**: `docs/backtest/H1_BACKTEST_ENGINE_GUIDE.md`

---

## ğŸš€ Ä°lk AdÄ±m: DuckDB Cache

**Hemen ÅŸimdi baÅŸlÄ±yoruz!**

### Task 1.1: DuckDB Setup
```bash
cd services/analytics
pnpm add duckdb
```

### Task 1.2: Create Cache Layer
- File: `src/backtest/cache.ts`
- Schema: klines table (symbol, tf, t, o, h, l, c, v)
- Methods: `getOrFetch()`, `insert()`, `cleanup()`

### Task 1.3: Integration
- Update `backtest-simple.ts` to use cache
- Add Prometheus metrics (hit/miss)

**BaÅŸlÄ±yoruz! ğŸš€**

---

**Sprint Kickoff Tarihi**: 10 Ekim 2025  
**Lead**: Cursor (Claude 3.5 Sonnet)  
**Team**: Spark Platform Dev Team  
**Status**: ğŸ”¥ ACTIVE

