# V1.5 Sprint Kickoff - Streams & Observability (Backtest Optimization)

**Başlangıç Tarihi**: 10 Ekim 2025  
**Bağımlılık**: V1.4 (H1 Backtest Engine) ✅ Tamamlandı  
**Durum**: 🚀 BAŞLATILDI  
**Tahmini Süre**: 5 gün  

---

## 🎯 Sprint Vizyonu

> "V1.4'te oluşturulan backtest MVP'sini üretim-seviyesine çıkarmak:  
> 10x performans artışı + walk-forward validation + görsel analytics + optimization API"

### Neden V1.5?

V1.4 ile Spark'ın strateji döngüsünün **üçte biri** kapandı:
```
✅ (1) Veri Akışı (Portfolio + Market Data)
✅ (2) Strateji Analizi (Backtest Engine)
🔜 (3) Öğrenme & Optimizasyon (V1.5)
```

V1.5, sistemin **öğrenme ve optimizasyon** kısmını açıyor. Bu sprint sonunda:
- Backtest sonuçları **10x daha hızlı** (DuckDB cache)
- Stratejiler **overfitting'e karşı korunmuş** (walk-forward)
- Performans **görsel olarak analiz edilebilir** (equity charts)
- Parametre optimizasyonu **otomatik** (grid search API)

---

## 📊 Sprint Scope

### 1. DuckDB/Parquet Cache (🔥 Yüksek Öncelik)

**Problem**: Her backtest için tarihsel veri tekrar çekiliyor (Binance API)  
**Çözüm**: Persistent local cache ile 10x hız artışı

**Implementation**:
- `services/analytics/src/backtest/cache.ts` - DuckDB interface
- `services/analytics/src/backtest/duckdb-init.sql` - Schema
- Cache hit/miss metrics (Prometheus)

**Acceptance**: 
- First run: ~5s (API fetch)
- Cached run: < 100ms (local read)
- Auto-cleanup (30 gün retention)

**Estimated**: 1 gün

---

### 2. Walk-Forward Optimization (🔥 Yüksek Öncelik)

**Problem**: Backtest sonuçları geçmişe bakarak optimize edilmiş olabilir (overfitting)  
**Çözüm**: Train/validate/test split + rolling window

**Implementation**:
- `services/analytics/src/backtest/walk-forward.ts`
- 60% train / 20% validate / 20% test
- Out-of-sample Sharpe ratio reporting

**Acceptance**:
- Train/val/test metrikleri ayrı raporlanıyor
- Overfitting warning (train >> test)

**Estimated**: 1.5 gün

---

### 3. Multi-Asset Backtests (⚡ Orta Öncelik)

**Problem**: Tek-asset testleri portföy diversification'ı göstermiyor  
**Çözüm**: Portfolio-level backtest (2-10 assets)

**Implementation**:
- `services/analytics/src/backtest/portfolio.ts`
- Korelasyon matrisi
- Diversification benefit metrics

**Acceptance**:
- 2-10 asset destekleniyor
- Correlation matrix raporu

**Estimated**: 1 gün

---

### 4. UI Charts & Visualization (⚡ Orta Öncelik)

**Components**:
a. **Equity Curve Chart** (Recharts)
   - Interactive line chart
   - Hover tooltips
   - Responsive design

b. **Trade Breakdown Table**
   - Entry/exit details
   - PnL per trade (color-coded)
   - CSV export

**Files**:
- `apps/web-next/src/components/backtest/EquityCurve.tsx`
- `apps/web-next/src/components/backtest/TradeTable.tsx`

**Acceptance**:
- Charts render < 500ms
- Mobile-friendly

**Estimated**: 1 gün

---

### 5. Optimization API (🔥 Yüksek Öncelik)

**Endpoint**: `POST /api/exec/optimize`

**Features**:
- Grid search (cartesian product)
- Best params by objective (sharpe/pnl/winrate)
- Prometheus metric: `spark_optimization_runs_total`

**Implementation**:
- `services/analytics/src/backtest/optimize.ts`
- `services/executor/src/routes/optimize.ts` (UPDATE)

**Acceptance**:
- 36 combinations < 30s
- Best params returned

**Estimated**: 1 gün

---

### 6. Performance Testing (📊 Orta Öncelik)

**Benchmarks**:
- P95 latency (1k bar): < 500ms
- P95 latency (50k bar): < 8s
- Memory per job: < 100MB

**Deliverable**:
- `services/analytics/tests/performance/backtest.test.ts`
- `docs/sprints/V1.5_PERFORMANCE_RESULTS.md`

**Estimated**: 0.5 gün

---

## 🗓️ Sprint Timeline

| Gün | Görevi | Deliverable | Durum |
|-----|--------|-------------|-------|
| **1** | DuckDB cache impl | Cache working + metrics | 🚀 Başlıyor |
| **2** | Walk-forward impl | Train/test split OK | ⏳ Bekliyor |
| **3** | Multi-asset + Optimize API | Portfolio + grid search | ⏳ Bekliyor |
| **4** | UI charts + tables | Equity curve + breakdown | ⏳ Bekliyor |
| **5** | Performance tests + docs | Benchmarks + final report | ⏳ Bekliyor |

---

## 🎯 Sprint Goals (OKRs)

### Objective 1: Performance Excellence
- **KR1**: Cache hit ratio > 80% (1 hafta içinde)
- **KR2**: P95 latency < 8s (50k bar)
- **KR3**: Throughput 100 backtest/hour

### Objective 2: Reliability & Validation
- **KR1**: Walk-forward implemented (train/val/test)
- **KR2**: Overfitting detection > 90% accuracy
- **KR3**: Multi-asset correlation < 0.7 (diversification)

### Objective 3: Developer Experience
- **KR1**: UI charts < 500ms render time
- **KR2**: Optimization API < 30s (36 runs)
- **KR3**: Docs coverage > 90%

---

## 🚧 Riskler

| Risk | Olasılık | Etki | Mitigasyon |
|------|----------|------|------------|
| DuckDB entegrasyonu | Orta | Yüksek | Fallback to in-memory (v1.4) |
| Optimization timeout | Düşük | Orta | Async job + SSE stream |
| UI performance (large datasets) | Orta | Düşük | Downsampling (max 500 pts) |

---

## 📦 Dependencies

### NPM Packages
```json
{
  "duckdb": "^0.9.0",
  "recharts": "^2.10.0",
  "papaparse": "^5.4.0"
}
```

### System Requirements
- DuckDB binary (auto-installed)
- Disk space: 1GB (cache)

---

## ✅ Definition of Done

Sprint V1.5 tamamlanmış sayılır eğer:

1. ✅ DuckDB cache çalışıyor (hit ratio > 50%)
2. ✅ Walk-forward validation implemented
3. ✅ Multi-asset backtest (2+ assets)
4. ✅ Equity curve chart rendered
5. ✅ Trade breakdown table working
6. ✅ Optimization API endpoint live
7. ✅ Performance benchmarks passed
8. ✅ Docs updated (guide + API ref)
9. ✅ No critical bugs
10. ✅ Prometheus metrics > 10 new counters

---

## 🔗 İlgili Dokümantasyon

- **V1.4 Completion**: `docs/sprints/V1.4_COMPLETION_REPORT.md`
- **V1.5 Plan**: `docs/sprints/V1.5_SPRINT_PLAN.md`
- **Backtest Guide**: `docs/backtest/H1_BACKTEST_ENGINE_GUIDE.md`

---

## 🚀 İlk Adım: DuckDB Cache

**Hemen şimdi başlıyoruz!**

### Task 1.1: DuckDB Setup
```bash
cd services/analytics
pnpm add duckdb
```

### Task 1.2: Create Cache Layer
- File: `src/backtest/cache.ts`
- Schema: klines table (symbol, tf, t, o, h, l, c, v)
- Methods: `getOrFetch()`, `insert()`, `cleanup()`

### Task 1.3: Integration
- Update `backtest-simple.ts` to use cache
- Add Prometheus metrics (hit/miss)

**Başlıyoruz! 🚀**

---

**Sprint Kickoff Tarihi**: 10 Ekim 2025  
**Lead**: Cursor (Claude 3.5 Sonnet)  
**Team**: Spark Platform Dev Team  
**Status**: 🔥 ACTIVE

