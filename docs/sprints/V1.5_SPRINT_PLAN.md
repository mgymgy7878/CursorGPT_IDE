# V1.5 Sprint Plan - Backtest Optimization & Visualization

**Sprint BaÅŸlangÄ±Ã§**: TBD  
**Tahmini SÃ¼re**: 5 gÃ¼n  
**Ã–ncelik**: Orta-YÃ¼ksek  
**BaÄŸÄ±mlÄ±lÄ±klar**: V1.4 (H1 Backtest Engine) âœ… TamamlandÄ±

---

## ðŸŽ¯ Sprint Hedefleri

V1.4'te oluÅŸturulan **backtest engine MVP**'sini Ã¼retim-seviyesine Ã§Ä±karmak:

1. **Performance**: DuckDB/Parquet cache ile 10x hÄ±z artÄ±ÅŸÄ±
2. **Reliability**: Walk-forward validation ile overfitting Ã¶nleme
3. **Scale**: Multi-asset portfÃ¶y backtestleri
4. **UX**: GÃ¶rsel equity curve + trade breakdown
5. **Automation**: Grid search optimization API

---

## ðŸ“‹ GÃ¶revler

### 1. DuckDB/Parquet Cache (YÃ¼ksek Ã–ncelik)

**Problem**: Åžu anda her backtest iÃ§in tarihsel veri tekrar Ã§ekiliyor (Binance API).

**Ã‡Ã¶zÃ¼m**: Persistent local cache

**Implementation**:
```typescript
// services/analytics/src/backtest/cache.ts
import duckdb from "duckdb";

class BacktestCache {
  async getOrFetch(symbol, timeframe, start, end) {
    // 1. DuckDB query
    const cached = await db.query(`
      SELECT * FROM klines 
      WHERE symbol=? AND tf=? AND t BETWEEN ? AND ?
    `);
    
    // 2. If missing, fetch from Binance
    if (cached.length < expected) {
      const fresh = await fetchBinance(...);
      await db.insert("klines", fresh);
    }
    
    return cached;
  }
}
```

**Dosyalar**:
- `services/analytics/src/backtest/cache.ts` (NEW)
- `services/analytics/src/backtest/duckdb-init.sql` (NEW)
- `services/executor/src/routes/backtest-simple.ts` (UPDATE - cache integration)

**Acceptance**:
- âœ… First run: ~5s (Binance fetch)
- âœ… Cached run: < 100ms (DuckDB read)
- âœ… Auto-cleanup (30 gÃ¼n eski data silinir)

**Estimated**: 1 gÃ¼n

---

### 2. Walk-Forward Optimization (YÃ¼ksek Ã–ncelik)

**Problem**: Backtest sonuÃ§larÄ± "overfitted" olabilir (geÃ§miÅŸe bakarak parametre ayarÄ±).

**Ã‡Ã¶zÃ¼m**: Train/test split + rolling window

**Implementation**:
```typescript
// Walk-forward: 60% train, 20% validate, 20% test
function walkForward(bars, config) {
  const trainSize = Math.floor(bars.length * 0.6);
  const valSize = Math.floor(bars.length * 0.2);
  
  // 1. Train period â†’ optimize params
  const bestParams = optimize(bars.slice(0, trainSize), config);
  
  // 2. Validation â†’ check stability
  const valResult = backtest(bars.slice(trainSize, trainSize+valSize), bestParams);
  
  // 3. Test â†’ final score
  const testResult = backtest(bars.slice(trainSize+valSize), bestParams);
  
  return { train, val, test, params: bestParams };
}
```

**Dosyalar**:
- `services/analytics/src/backtest/walk-forward.ts` (NEW)
- `services/executor/src/routes/backtest-simple.ts` (UPDATE - mode param)

**Acceptance**:
- âœ… Train/Val/Test ayrÄ±mÄ± Ã§alÄ±ÅŸÄ±yor
- âœ… Out-of-sample Sharpe raporlanÄ±yor
- âœ… Overfitting warning (train >> test performance)

**Estimated**: 1.5 gÃ¼n

---

### 3. Multi-Asset Backtests (Orta Ã–ncelik)

**Problem**: Tek-asset testleri portfÃ¶y etkisini gÃ¶stermiyor.

**Ã‡Ã¶zÃ¼m**: Portfolio-level backtest

**Implementation**:
```typescript
// Multi-asset: eÅŸit aÄŸÄ±rlÄ±klÄ± portfÃ¶y
function backtestPortfolio(assets: { symbol, bars }[], config) {
  const positions = new Map(); // symbol â†’ pos
  const equity = [10000];
  
  for (let i = 0; i < maxBars; i++) {
    // Her asset iÃ§in sinyal hesapla
    assets.forEach(a => {
      const signal = getSignal(a.bars[i], config);
      updatePosition(positions, a.symbol, signal);
    });
    
    // Portfolio value
    const value = calculatePortfolioValue(positions, assets, i);
    equity.push(value);
  }
  
  return { equity, positions, metrics };
}
```

**Dosyalar**:
- `services/analytics/src/backtest/portfolio.ts` (NEW)
- `apps/web-next/src/app/backtest-lab/page.tsx` (UPDATE - multi-symbol input)

**Acceptance**:
- âœ… 2-10 asset destekleniyor
- âœ… Korelasyon matrisi raporu
- âœ… Diversification benefit hesaplanÄ±yor

**Estimated**: 1 gÃ¼n

---

### 4. UI Enhancements (Orta Ã–ncelik)

#### 4a. Equity Curve Chart

**Library**: Recharts

**Component**:
```tsx
// apps/web-next/src/components/backtest/EquityCurve.tsx
import { LineChart, Line, XAxis, YAxis } from "recharts";

export function EquityCurve({ timestamps, equity }) {
  const data = timestamps.map((t, i) => ({ 
    date: new Date(t).toLocaleDateString(), 
    value: equity[i] 
  }));
  
  return (
    <LineChart data={data}>
      <Line dataKey="value" stroke="#10b981" />
      <XAxis dataKey="date" />
      <YAxis />
    </LineChart>
  );
}
```

**Dosyalar**:
- `apps/web-next/src/components/backtest/EquityCurve.tsx` (NEW)
- `apps/web-next/src/app/backtest-lab/page.tsx` (UPDATE - chart import)

**Acceptance**:
- âœ… Equity curve gÃ¶rselleÅŸtirildi
- âœ… Hover tooltip (date + value)
- âœ… Responsive (mobile uyumlu)

**Estimated**: 0.5 gÃ¼n

#### 4b. Trade Breakdown Table

**Component**:
```tsx
// apps/web-next/src/components/backtest/TradeTable.tsx
export function TradeTable({ trades }) {
  return (
    <table>
      <thead>
        <tr><th>Date</th><th>Type</th><th>Entry</th><th>Exit</th><th>PnL</th></tr>
      </thead>
      <tbody>
        {trades.map(t => (
          <tr key={t.id}>
            <td>{formatDate(t.entryTime)}</td>
            <td>{t.side}</td>
            <td>${t.entryPrice}</td>
            <td>${t.exitPrice}</td>
            <td className={t.pnl > 0 ? "text-green" : "text-red"}>
              ${t.pnl.toFixed(2)}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}
```

**Dosyalar**:
- `apps/web-next/src/components/backtest/TradeTable.tsx` (NEW)
- `services/analytics/src/backtest/engine.ts` (UPDATE - trade logging)

**Acceptance**:
- âœ… Her trade detayÄ± gÃ¶rÃ¼lÃ¼yor
- âœ… Win/loss renk kodlu
- âœ… CSV export butonu

**Estimated**: 0.5 gÃ¼n

---

### 5. Optimization API (YÃ¼ksek Ã–ncelik)

**Endpoint**: `POST /api/exec/optimize`

**Request**:
```json
{
  "symbol": "BTCUSDT",
  "timeframe": "15m",
  "start": "2024-01-01",
  "end": "2024-03-01",
  "exchange": "binance",
  "paramSpace": {
    "emaFast": [10, 15, 20, 25],
    "emaSlow": [40, 50, 60],
    "atrMult": [1.5, 2.0, 2.5]
  },
  "objective": "sharpe"
}
```

**Response**:
```json
{
  "ok": true,
  "bestParams": { "emaFast": 20, "emaSlow": 50, "atrMult": 2 },
  "bestScore": 1.85,
  "allResults": [ ... ],
  "totalRuns": 36
}
```

**Implementation**:
```typescript
// Grid search
function optimizeGrid(bars, paramSpace, objective) {
  const results = [];
  
  // Cartesian product
  for (const emaFast of paramSpace.emaFast) {
    for (const emaSlow of paramSpace.emaSlow) {
      for (const atrMult of paramSpace.atrMult) {
        const config = { indicators: { emaFast, emaSlow }, exit: { atrMult } };
        const res = runBacktest(bars, config);
        results.push({ params: config, score: res[objective] });
      }
    }
  }
  
  return results.sort((a,b) => b.score - a.score)[0];
}
```

**Dosyalar**:
- `services/analytics/src/backtest/optimize.ts` (NEW)
- `services/executor/src/routes/optimize.ts` (UPDATE - /optimize endpoint)

**Acceptance**:
- âœ… Grid search Ã§alÄ±ÅŸÄ±yor (36 kombinasyon < 30s)
- âœ… Best params dÃ¶ndÃ¼rÃ¼lÃ¼yor
- âœ… Prometheus metric: `spark_optimization_runs_total`

**Estimated**: 1 gÃ¼n

---

### 6. Performance Testing (Orta Ã–ncelik)

**Hedefler** (plan.txt'den):
- P95 latency (1k bar): < 500ms
- P95 latency (50k bar): < 8s
- Memory per job: < 100MB

**Test Suite**:
```typescript
// tests/performance/backtest.test.ts
describe("Backtest Performance", () => {
  it("1k bars < 500ms", async () => {
    const start = Date.now();
    await backtest(bars1k, config);
    expect(Date.now() - start).toBeLessThan(500);
  });
  
  it("50k bars < 8s", async () => {
    const start = Date.now();
    await backtest(bars50k, config);
    expect(Date.now() - start).toBeLessThan(8000);
  });
});
```

**Dosyalar**:
- `services/analytics/tests/performance/backtest.test.ts` (NEW)
- `docs/sprints/V1.5_PERFORMANCE_RESULTS.md` (NEW)

**Acceptance**:
- âœ… TÃ¼m testler geÃ§iyor
- âœ… SonuÃ§lar dokÃ¼mante edilmiÅŸ

**Estimated**: 0.5 gÃ¼n

---

## ðŸ“Š Sprint Zaman Ã‡izelgesi

| GÃ¼n | GÃ¶revler | Deliverable |
|-----|----------|-------------|
| 1 | DuckDB cache setup | Cache Ã§alÄ±ÅŸÄ±yor |
| 2 | Walk-forward impl | Train/test split OK |
| 3 | Multi-asset + Optimize API | Portfolio backtest + grid search |
| 4 | UI charts + table | Equity curve + trade table |
| 5 | Performance tests + docs | Final report |

---

## ðŸŽ¯ Kabul Kriterleri

| Ã–zellik | Ã–lÃ§Ã¼m | Hedef | Test |
|---------|-------|-------|------|
| Cache hit ratio | % | > 80% | Metrics |
| Walk-forward | Ã‡alÄ±ÅŸÄ±yor | âœ… | Unit test |
| Multi-asset | 10 asset | âœ… | Integration |
| Equity chart | Rendered | âœ… | UI test |
| Optimize API | < 30s (36 runs) | âœ… | Performance |
| P95 latency (50k) | ms | < 8000 | Benchmark |

---

## ðŸš§ Riskler & Mitigasyon

### Risk 1: DuckDB Entegrasyonu
- **OlasÄ±lÄ±k**: Orta
- **Etki**: YÃ¼ksek (cache olmadan yavaÅŸ)
- **Mitigasyon**: Fallback to in-memory (v1.4 behavior)

### Risk 2: Optimization Timeout
- **OlasÄ±lÄ±k**: DÃ¼ÅŸÃ¼k
- **Etki**: Orta (kullanÄ±cÄ± deneyimi kÃ¶tÃ¼)
- **Mitigasyon**: Async job + SSE progress stream

### Risk 3: UI Performans (Large Charts)
- **OlasÄ±lÄ±k**: Orta
- **Etki**: DÃ¼ÅŸÃ¼k (yavaÅŸ render)
- **Mitigasyon**: Downsampling (max 500 points)

---

## ðŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar

### Yeni NPM Paketleri
```json
{
  "duckdb": "^0.9.0",
  "recharts": "^2.10.0",
  "papaparse": "^5.4.0"  // CSV export
}
```

### Sistem Gereksinimleri
- DuckDB binary (auto-installed)
- Disk space: 1GB (cache iÃ§in)

---

## ðŸ”œ Post-Sprint (V1.6+)

EÄŸer V1.5 baÅŸarÄ±lÄ± olursa:

### V1.6: Genetic Algorithm Optimization
- Grid search yerine daha akÄ±llÄ± param search
- 1000+ kombinasyon iÃ§in 10x hÄ±z artÄ±ÅŸÄ±

### V1.7: Real-Time Backtest Streaming
- WebSocket Ã¼zerinden progress bar
- Ä°ptal/durdur desteÄŸi

### V1.8: ML-Based Strategy Generation
- GPT-4 ile strateji Ã¶nerisi
- Automatic code generation

---

**Sprint Plan Tarihi**: 10 Ekim 2025  
**HazÄ±rlayan**: Cursor (Claude 3.5 Sonnet)  
**Proje**: Spark Trading Platform  
**Sprint**: V1.5 - Backtest Optimization & Visualization

