# V1.5 Cache Layer - Test & Verification Guide

**Feature**: DuckDB/Parquet Cache Layer  
**Sprint**: V1.5  
**Status**: ‚úÖ Implemented  
**Test Date**: 10 Ekim 2025  

---

## üìã Implementation Summary

### Files Created
1. `services/analytics/src/backtest/duckdb-init.sql` - Database schema
2. `services/analytics/src/backtest/cache.ts` - Cache interface
3. `services/analytics/src/backtest/cache-metrics.ts` - Prometheus metrics

### Files Updated
1. `services/executor/src/routes/backtest-simple.ts` - Cache integration
2. `services/executor/package.json` - Added `duckdb@^0.9.0`

### New Endpoints
- `GET /backtest/cache/stats` - Cache statistics
- `POST /backtest/cache/cleanup` - Manual cleanup (admin)

### New Metrics
```
spark_backtest_cache_hit_total{exchange, symbol, timeframe}
spark_backtest_cache_miss_total{exchange, symbol, timeframe}
spark_backtest_cache_size_bytes
spark_backtest_cached_candles_total
spark_backtest_cache_insert_total{exchange, symbol}
spark_backtest_cache_cleanup_total
```

---

## üß™ Test Plan

### Test 1: Cold Start (First Run)
**Objective**: Verify cache miss ‚Üí API fetch ‚Üí insert

**Steps**:
```powershell
# 1. Clear cache (if exists)
Remove-Item .cache/backtest.duckdb -ErrorAction SilentlyContinue

# 2. First backtest (should be SLOW - ~5s)
$body = @{
  symbol = "BTCUSDT"
  timeframe = "15m"
  start = "2024-01-01"
  end = "2024-01-15"
  exchange = "binance"
  useCache = $true
} | ConvertTo-Json

Measure-Command {
  Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $body
}
```

**Expected**:
- Time: 3-7 seconds (Binance API fetch)
- Response: `"cached": true` but data fetched from API
- Metrics: `spark_backtest_cache_miss_total` +1

---

### Test 2: Warm Start (Cache Hit)
**Objective**: Verify cache hit ‚Üí fast response

**Steps**:
```powershell
# Run same backtest again (should be FAST - <500ms)
Measure-Command {
  Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $body
}
```

**Expected**:
- Time: < 500ms (10x faster!)
- Response: `"cached": true`
- Metrics: `spark_backtest_cache_hit_total` +1

---

### Test 3: Cache Stats
**Objective**: Verify cache statistics endpoint

**Steps**:
```powershell
Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/cache/stats `
  -UseBasicParsing | Select-Object -ExpandProperty Content | ConvertFrom-Json
```

**Expected Output**:
```json
{
  "ok": true,
  "stats": {
    "totalCandles": 1344,
    "exchanges": 1,
    "symbols": 1
  }
}
```

---

### Test 4: Multiple Symbols (Cache Efficiency)
**Objective**: Verify cache works across different symbols

**Steps**:
```powershell
# Test with ETHUSDT
$body2 = @{
  symbol = "ETHUSDT"
  timeframe = "15m"
  start = "2024-01-01"
  end = "2024-01-15"
  exchange = "binance"
  useCache = $true
} | ConvertTo-Json

# First run (cold)
Measure-Command {
  Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $body2
}

# Second run (warm)
Measure-Command {
  Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $body2
}
```

**Expected**:
- First run: ~5s (miss)
- Second run: <500ms (hit)
- Cache stats: `symbols: 2`

---

### Test 5: Cache Cleanup
**Objective**: Verify cleanup functionality

**Steps**:
```powershell
# Manual cleanup (retention: 0 days = delete all)
Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/cache/cleanup `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"retentionDays": 0}'

# Check stats (should be empty)
Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/cache/stats `
  -UseBasicParsing | Select-Object -ExpandProperty Content
```

**Expected**:
- Response: `"message": "Cleaned up data older than 0 days"`
- Stats: `totalCandles: 0`

---

### Test 6: Fallback (Cache Disabled)
**Objective**: Verify fallback to direct API when cache disabled

**Steps**:
```powershell
$bodyNoCache = @{
  symbol = "BTCUSDT"
  timeframe = "15m"
  start = "2024-01-01"
  end = "2024-01-15"
  exchange = "binance"
  useCache = $false
} | ConvertTo-Json

Measure-Command {
  Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $bodyNoCache
}
```

**Expected**:
- Time: ~5s (always API fetch)
- Response: `"cached": false`
- No metrics change (cache not used)

---

## üìä Performance Benchmarks

### Target vs Actual

| Metric | Target (Plan) | Actual | Status |
|--------|---------------|--------|--------|
| Cold start (1k bars) | < 5s | ‚è≥ TBD | üîú Test |
| Warm start (1k bars) | < 100ms | ‚è≥ TBD | üîú Test |
| Cache hit ratio (week) | > 80% | ‚è≥ TBD | üîú Monitor |
| Disk usage (1M bars) | < 500MB | ‚è≥ TBD | üîú Monitor |

---

## üêõ Troubleshooting

### Error: "DB not initialized"
**Cause**: DuckDB failed to open  
**Fix**: Check `.cache/` directory permissions

```powershell
# Create cache dir manually
New-Item -ItemType Directory -Path .cache -Force
```

### Error: "Schema init failed"
**Cause**: SQL syntax error in duckdb-init.sql  
**Fix**: Verify SQL file exists and is valid

```powershell
Test-Path services/analytics/src/backtest/duckdb-init.sql
```

### Error: "Module not found: duckdb"
**Cause**: Package not installed  
**Fix**: Install dependencies

```powershell
cd services/executor
pnpm install
```

### Performance: Cache not faster
**Cause**: DuckDB I/O bottleneck or small dataset  
**Fix**: 
1. Test with larger datasets (50k+ bars)
2. Check disk speed (SSD recommended)
3. Monitor `spark_backtest_cache_hit_total`

---

## ‚úÖ Acceptance Criteria

Cache layer is **ACCEPTED** if:

1. ‚úÖ Cold start completes in < 10s (1k bars)
2. ‚úÖ Warm start completes in < 500ms (1k bars)
3. ‚úÖ Cache hit ratio > 50% (initial sprint)
4. ‚úÖ `/backtest/cache/stats` returns valid data
5. ‚úÖ Prometheus metrics are exposed
6. ‚úÖ Cleanup works without errors
7. ‚úÖ Fallback mode (useCache=false) works
8. ‚úÖ No memory leaks (monitor over time)

---

## üîú Next Steps

1. Run all 6 tests above
2. Document actual performance numbers
3. Monitor cache hit ratio over 1 week
4. Optimize slow queries if P95 > 500ms
5. Implement automated cleanup job (cron)

---

**Test Author**: Cursor (Claude 3.5 Sonnet)  
**Sprint**: V1.5 - Task 1 (DuckDB Cache Layer)  
**Date**: 10 Ekim 2025

