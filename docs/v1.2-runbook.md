# v1.2 BTCTurk+BIST Runbook

## Go/No-Go Kriterleri

### Go Kriterleri (Yeşil Işık)
- `/health`, `/metrics`, `/canary/status` yeşil
- `/api/version` → `v1.2-ramp` tag'i
- BTCTurk balances çağrısı 200 + `success:true`
- P95 hedefleri son 30 dk uyarı altında:
  - Place→ACK P95 < 1000ms
  - Feed→DB P95 < 300ms
- Clock drift < 2000ms
- Rate limit ihlali < 0.1/s

### No-Go / Rollback Kriterleri

#### Otomatik Kill-Switch (15 dk)
- `PlaceAckP95High{severity="critical"}` aktifse
- Otomatik kill-switch (order path'i kapat)
- Paper fallback moduna geç

#### Manuel Müdahale Gereken Durumlar
- 401/"Invalid Nonce" artışı → NTP/clock drift kontrolü (±5s tolerans)
- 429 artışı → concurrency=1'e düş, Retry-After'a tam uy
- BIST seans dışı işlem denemeleri → session guard kontrolü

## Happy Path Akış Testi (Dry-Run)

### 1. Auth Smoke Test
```bash
curl -X GET "http://127.0.0.1:4001/btcturk/balances" \
  -H "Content-Type: application/json"
```
**Beklenen:** 200 + `{"success": true, "data": {...}}`

### 2. Emir Testi (Paper Mode)
```bash
curl -X POST "http://127.0.0.1:4001/place" \
  -H "Content-Type: application/json" \
  -d '{
    "symbol": "BTCTRY",
    "side": "buy",
    "qty": 0.001,
    "price": 100000
  }'
```
**Beklenen:** 200 + `{"ok": true, "id": "...", "dryRun": true}`

### 3. Açık Emir Doğrulama
```bash
curl -X GET "http://127.0.0.1:4001/btcturk/orders?pairSymbol=BTCTRY"
```
**Beklenen:** 200 + `{"success": true, "data": [...]}`

### 4. Metrik Doğrulama
```bash
curl -X GET "http://127.0.0.1:4001/metrics" | grep spark_place_ack_duration_seconds_count
```
**Beklenen:** `spark_place_ack_duration_seconds_count{...} 1` (artış görülmeli)

### 5. BIST Session Guard Testi
```bash
# Seans dışı saatte (19:00 sonrası)
curl -X POST "http://127.0.0.1:4001/place" \
  -H "Content-Type: application/json" \
  -d '{
    "symbol": "GARANTRY",
    "side": "buy",
    "qty": 100,
    "price": 50
  }'
```
**Beklenen:** 403 + `{"error": "Market closed", "reason": "BIST session is not open"}`

## PromQL SLO Queries

### P95 Place→ACK (5dk pencerede)
```promql
histogram_quantile(0.95,
  sum by (le) (rate(spark_place_ack_duration_seconds_bucket[5m]))
)
```

### P95 Feed→DB (5dk)
```promql
histogram_quantile(0.95,
  sum by (le) (rate(spark_feed_to_db_seconds_bucket[5m]))
)
```

### Rate Limit Hataları
```promql
rate(spark_btcturk_errors_total{error_type="rate_limit"}[5m])
```

### Clock Drift
```promql
spark_clock_drift_seconds{exchange="btcturk"}
```

## Kritik Sertleştirmeler

### Clock Drift Kontrolü
- Başlatırken server time sorgula
- Drift > 2000ms ise lokal offset uygula
- Nonce üretimine offset ekle

### Precision/MinQty
- ExchangeInfo'dan çek
- TRY komisyonunu düş
- Emir katmanında validasyon

### Idempotency
- `newOrderClientId` üret
- Yeniden denemelerde aynı ID kullan
- Tek atış garantisi

### Hata Sınıfları
- 401/"Invalid Nonce" → `invalid_nonce`
- 429 → `rate_limit`
- 5xx → `server_error`
- Ayrık sayaç/metrik

## Rollback Planı

### Hızlı Geri Dönüş
1. `TRADING_MODE=paper` + `KILL_SWITCH=true`
2. Canlı emri anında kes
3. Paper fallback aktif

### SLO Kırmızı (P95>2s, 10m)
1. Canary durdur
2. Rate-limit 50% azalt
3. Alarm aç
4. Incident response başlat

### Kurtarma
1. Outage notu + artefakt topla
2. `evidence/incidents/<timestamp>/` klasörü
3. Root cause analysis
4. Post-mortem raporu

## Monitoring Dashboard

### Grafana Panels
- **P95 Latency**: Place→ACK ve Feed→DB P95
- **Error Rates**: BTCTurk error types
- **Clock Drift**: Server vs local time
- **Session Status**: BIST open/closed
- **Rate Limits**: 429 responses

### Alert Channels
- **Warning**: Slack #alerts
- **Critical**: PagerDuty + SMS
- **Info**: Email digest

## Environment Variables

```bash
# BTCTurk API
BTCTURK_API_KEY=your_api_key
BTCTURK_API_SECRET=your_base64_secret

# Trading Mode
TRADING_MODE=paper  # paper | live
KILL_SWITCH=false   # true | false

# Monitoring
PROMETHEUS_URL=http://localhost:9090
GRAFANA_URL=http://localhost:3000
```
