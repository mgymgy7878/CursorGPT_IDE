# V1.5 Canary Deployment Guide

**Version**: V1.5 - Streams & Observability (Backtest Optimization)  
**Status**: READY FOR PRODUCTION  
**Risk Level**: LOW (read-only features)  
**Date**: 10 Ekim 2025

---

## 🎯 Deployment Overview

**What's Being Deployed**:
- DuckDB cache layer (50x speedup)
- Walk-forward optimization (overfitting prevention)
- Multi-asset portfolio backtests
- Grid search optimizer
- UI charts & visualization

**Impact**:
- ✅ Read-only operations (no trading)
- ✅ Viewer RBAC (safe access)
- ✅ Rate limited (5 req/min UI, 2 job/min optimizer)
- ✅ Rollback time: <5 minutes

**Priority**: Güvenlik > Doğruluk > Hız

---

## 📋 Preflight Checklist (Local/Staging)

### 1. Services Health Check

```powershell
# Start services
.\basla.ps1

# Wait 20 seconds
Start-Sleep -Seconds 20

# Health check
Invoke-WebRequest -Uri http://127.0.0.1:4001/health -UseBasicParsing

# Expected: Status 200, {"ok": true}
```

### 2. Cache Smoke Test

```powershell
.\scripts\quick-cache-smoke.ps1
```

**Acceptance**:
- ✅ Cold run: ~5s
- ✅ Warm run: <1s
- ✅ Speedup: >5x
- ✅ Evidence: `evidence/cache/cache_smoke_*.txt`

### 3. Performance Benchmarks

```powershell
.\scripts\bench-backtest.ps1
.\scripts\bench-optimizer.ps1
```

**Acceptance**:
- ✅ P95 (50k bars): <8s
- ✅ Throughput: >100 backtest/hour
- ✅ Optimizer (200 combos): <30s

### 4. Metrics Validation

```powershell
(Invoke-WebRequest http://127.0.0.1:4001/metrics).Content | Select-String "spark_backtest"
```

**Expected**: 29 metrics exposed
- Cache: 6 metrics
- Walk-forward: 5 metrics
- Portfolio: 5 metrics
- Optimizer: 5 metrics
- Others: 8 metrics

---

## 🧪 Canary Deployment (Dry-Run)

### Scenarios to Test

#### Scenario 1: Single Asset Backtest
```powershell
$body1 = @{
    symbol = "BTCUSDT"
    timeframe = "1h"
    start = "2024-01-01"
    end = "2024-01-15"
    exchange = "binance"
    useCache = $true
} | ConvertTo-Json

Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/run `
    -Method POST -ContentType "application/json" -Body $body1
```

**Expected**:
- Response time: <2s (cache warm)
- Metrics: `spark_backtest_cache_hit_total` increases

#### Scenario 2: Walk-Forward Validation
```powershell
$body2 = @{
    symbol = "ETHUSDT"
    timeframe = "1h"
    start = "2024-01-01"
    end = "2024-03-01"
    exchange = "binance"
    useCache = $true
    config = @{
        trainRatio = 0.6
        testRatio = 0.4
    }
    strategy = @{
        params = @{ emaFast = 20; emaSlow = 50; atr = 14 }
    }
} | ConvertTo-Json -Depth 10

Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/walkforward `
    -Method POST -ContentType "application/json" -Body $body2
```

**Expected**:
- Overfitting detection working
- Test/train sharpe ratio calculated

#### Scenario 3: Portfolio Backtest
```powershell
$body3 = @{
    symbols = @("BTCUSDT", "ETHUSDT", "BNBUSDT")
    timeframe = "1h"
    start = "2024-01-01"
    end = "2024-01-15"
    exchange = "binance"
    useCache = $true
} | ConvertTo-Json -Depth 10

Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/portfolio `
    -Method POST -ContentType "application/json" -Body $body3
```

**Expected**:
- Correlation matrix (3x3)
- Diversification benefit calculated

#### Scenario 4: Optimizer
```powershell
$body4 = @{
    symbol = "BTCUSDT"
    timeframe = "1h"
    start = "2024-01-01"
    end = "2024-02-01"
    exchange = "binance"
    useCache = $true
    grid = @{
        emaFast = @(16, 20, 24)
        emaSlow = @(45, 50, 55)
        atr = @(12, 14)
    }
    objective = "sharpe"
} | ConvertTo-Json -Depth 10

Invoke-WebRequest -Uri http://127.0.0.1:4001/backtest/optimize `
    -Method POST -ContentType "application/json" -Body $body4
```

**Expected**:
- 18 combinations tested
- Best params returned
- Latency <10s

---

## 🔐 Security & Guardrails

### Rate Limits

**UI Endpoints** (Viewer):
- `/backtest/run`: 5 req/min
- `/backtest/walkforward`: 5 req/min
- `/backtest/portfolio`: 5 req/min

**Heavy Jobs** (Trader/Admin):
- `/backtest/optimize`: 2 job/min
- `/backtest/cache/cleanup`: Admin only

### RBAC

All endpoints accessible by **Viewer** role (read-only).

### Data Validation

- Symbols: 1-10 assets
- Date range: Max 2 years
- Grid size: Max 500 combinations (recommended)
- Weights: Sum = 1.0 ± 1e-6

---

## 📊 Monitoring (İlk 24 Saat)

### Critical Metrics

#### 1. Latency (P95)

```promql
# Backtest P95
histogram_quantile(0.95, sum by (le)(rate(spark_backtest_latency_ms_bucket[5m])))

# Optimizer P95
histogram_quantile(0.95, sum by (le,combinations)(rate(spark_backtest_opt_latency_ms_bucket[5m])))

# Portfolio P95
histogram_quantile(0.95, sum by (le,symbols_count)(rate(spark_backtest_portfolio_latency_ms_bucket[5m])))
```

**Thresholds**:
- Backtest: <8s (50k bars)
- Optimizer: <30s (200 combos)
- Portfolio: <5s (3 assets)

#### 2. Cache Health

```promql
# Cache hit ratio
rate(spark_backtest_cache_hit_total[5m])
  /
(rate(spark_backtest_cache_hit_total[5m]) + rate(spark_backtest_cache_miss_total[5m]))

# Cached candles
spark_backtest_cached_candles_total
```

**Thresholds**:
- Hit ratio: >50% (initial), >80% (after warm-up)
- Cached candles: <100M (disk space)

#### 3. Quality Guardrails

```promql
# Overfitting rate
rate(spark_backtest_overfitting_detected_total[1h])

# Diversification benefit (should be positive)
spark_backtest_portfolio_diversification_benefit
```

**Thresholds**:
- Overfitting: <3 detections/hour (stable)
- Diversification: Usually >0 (warning if consistently negative)

---

## 🚨 Önerilen Alarmlar (Prometheus)

### 1. High Latency (P95 > 8s for 15 minutes)

```yaml
- alert: BacktestLatencyHighP95
  expr: histogram_quantile(0.95, sum by (le)(rate(spark_backtest_latency_ms_bucket[5m]))) > 8000
  for: 15m
  labels:
    severity: warning
  annotations:
    summary: "Backtest P95 latency yüksek"
    description: "P95 > 8s for 15 minutes"
```

### 2. Optimizer Timeout (>30s for ~200 combos)

```yaml
- alert: OptimizerLatencyHigh
  expr: |
    histogram_quantile(0.95, 
      sum by (le,combinations)(rate(spark_backtest_opt_latency_ms_bucket{combinations=~"18.*"}[5m]))
    ) > 30000
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "Optimizer P95 > 30s"
    description: "Grid search yavaş, cache kontrol et"
```

### 3. Overfitting Spike (>3/hour)

```yaml
- alert: OverfittingRateHigh
  expr: rate(spark_backtest_overfitting_detected_total[1h]) > 3
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Overfitting detection oranı yüksek"
    description: "Saatte 3'ten fazla overfitting (veri kalitesi kontrol et)"
```

### 4. Cache Miss Rate High (>50%)

```yaml
- alert: CacheMissRateHigh
  expr: |
    rate(spark_backtest_cache_miss_total[5m])
      /
    (rate(spark_backtest_cache_hit_total[5m]) + rate(spark_backtest_cache_miss_total[5m]))
    > 0.5
  for: 15m
  labels:
    severity: info
  annotations:
    summary: "Cache miss rate yüksek"
    description: "Cache warm-up devam ediyor veya yeni semboller test ediliyor"
```

---

## 📦 Evidence Package Creation

```powershell
# Create evidence ZIP
cd C:\dev\CursorGPT_IDE

# Collect all V1.5 artifacts
$evidenceFiles = @(
    "V1.5_FINAL_EVIDENCE.md",
    "V1.5_SPRINT_COMPLETE.md",
    "V1.5_TASK1_TASK2_COMPLETE.md",
    "V1.5_TASK3_COMPLETE.md",
    "docs\backtest\*GUIDE.md",
    "docs\sprints\V1.5_*.md"
)

$evidenceDirs = @(
    "evidence\cache",
    "evidence\portfolio",
    "evidence\perf"
)

# Create ZIP
Compress-Archive -Path $evidenceFiles -DestinationPath V1.5_EVIDENCE.zip -Force

Write-Host "Evidence package created: V1.5_EVIDENCE.zip" -ForegroundColor Green
```

---

## ✅ Canary Approval Checklist

### Pre-Deployment
- [ ] Preflight tests passed (local)
- [ ] Cache smoke test: Speedup >5x
- [ ] Benchmarks: P95<8s, throughput>100/hr
- [ ] Metrics: All 29 exposed
- [ ] Evidence ZIP created
- [ ] Rollback script tested

### Deployment
- [ ] Canary dry-run (3 scenarios)
- [ ] Metrics monitored (first 1 hour)
- [ ] No errors in logs
- [ ] Rate limits active
- [ ] RBAC enforced (viewer only)

### Post-Deployment (24h)
- [ ] P95 latency stable (<8s)
- [ ] Cache hit ratio >50%
- [ ] No overfitting spikes
- [ ] UI responsive (<500ms)
- [ ] No memory leaks

---

## 🔄 Rollback Procedure

**If issues detected**:

```powershell
# 1. Stop services
.\durdur.ps1

# 2. Checkout previous version (V1.4)
git-safe checkout v1.4

# 3. Restart
.\basla.ps1

# Rollback time: <5 minutes
```

**Rollback Triggers**:
- P95 latency >15s (sustained 30min)
- Error rate >5% (sustained 10min)
- Memory leak (heap >2GB)
- Critical security issue

---

## 📈 Success Criteria (SLO)

### Performance SLOs

| Metric | Target | Measurement Window |
|--------|--------|-------------------|
| P95 Latency (50k bars) | <8s | 5m |
| Optimizer (200 combos) | <30s | Per job |
| Cache hit ratio | >50% initial, >80% steady | 1h / 24h |
| Throughput | >100 backtest/hour | 1h |
| UI render time | <500ms | Per page load |

### Quality SLOs

| Metric | Target | Measurement Window |
|--------|--------|-------------------|
| Overfitting alarm rate | ≤1/hour | 1h (stable datasets) |
| Diversification benefit | Usually >0 | Per portfolio run |
| Correlation accuracy | ±0.05 vs manual | Spot check |
| Error rate | <1% | 5m |

---

## 🚀 V1.6 Roadmap (1 Hafta, Odaklı)

### Hedefler

1. **Genetic/Bayesian Optimizer** (Grid üstüne)
   - Arama alanını 10-50x daraltma
   - Intelligent parameter exploration
   - **Effort**: 2 days

2. **Rebalance Maliyet Modeli**
   - Fee + slippage + minTrade
   - Daily/weekly rebalance modes
   - **Effort**: 1 day

3. **Scenario Presets (UI)**
   - localStorage save/load
   - "Best params → WFO doğrula" tek-tık
   - **Effort**: 4 hours

4. **Live Streams (Paper Signals)**
   - Optimizer'dan seçili params ile paper sinyal
   - WebSocket real-time feed
   - **Effort**: 1 day

5. **Export@Scale**
   - CSV+JSON export (10k+ satır)
   - Signed exports (audit trail)
   - **Effort**: 1 day

### Success Criteria

- ✅ Latency P95 < 8s (korunmalı)
- ✅ Optimizer 500+ kombinasyonda ≤45s
- ✅ Overfitting alarm oranı ≤1/saat
- ✅ UI presets çalışıyor
- ✅ Paper signals real-time stream

---

## 📝 Canary Action Templates

### 1. Canary Run (Dry-Run)

```json
{
  "action": "/canary/run",
  "params": {
    "scope": [
      "backtest.run",
      "backtest.walkforward",
      "backtest.portfolio",
      "backtest.optimize"
    ],
    "samples": 3,
    "evidencePath": "evidence/canary/v1.5/"
  },
  "dryRun": true,
  "confirm_required": false,
  "reason": "Prod öncesi kanıt seti (read-only) oluşturma"
}
```

### 2. Canary Confirm (Production)

```json
{
  "action": "/canary/confirm",
  "params": {
    "changeSet": "v1.5-backtest-suite",
    "guardrails": [
      "rate-limit",
      "rbac-viewer",
      "read-only"
    ]
  },
  "dryRun": false,
  "confirm_required": true,
  "reason": "Prod üzerinde read-only uçların açılması"
}
```

### 3. Daily Risk Report Integration

```json
{
  "action": "/fusion/risk.report.daily",
  "params": {
    "include": ["metrics", "bench", "canary"],
    "out": "evidence/daily/"
  },
  "dryRun": false,
  "confirm_required": false,
  "reason": "Günlük kanıt ve anomali taraması"
}
```

### 4. Create Alert (Optimizer Latency)

```json
{
  "action": "/alerts/create",
  "params": {
    "metric": "spark_backtest_opt_latency_ms",
    "threshold": 30000,
    "window": "5m",
    "severity": "warning"
  },
  "dryRun": false,
  "confirm_required": false,
  "reason": "Optimizer toplam süre guardrail"
}
```

---

## 🎯 Deployment Timeline

### Day 1 (Preflight)
- ✅ Run all smoke tests
- ✅ Run benchmarks
- ✅ Create evidence ZIP
- ✅ Review documentation

### Day 2 (Canary)
- 09:00: Deploy to canary environment
- 09:30: Run 4 test scenarios
- 10:00: Monitor metrics (1 hour)
- 11:00: Decision point (proceed or rollback)

### Day 3-7 (Production Monitoring)
- Monitor SLOs (24/7)
- Daily metrics review
- Weekly performance report

---

## 📚 Reference Documentation

- [V1.5 Final Evidence](../../V1.5_FINAL_EVIDENCE.md)
- [V1.5 Sprint Complete](../../V1.5_SPRINT_COMPLETE.md)
- [Cache Layer Test Guide](../backtest/V1.5_CACHE_LAYER_TEST.md)
- [Walk-Forward Guide](../backtest/WALK_FORWARD_GUIDE.md)
- [Portfolio Guide](../backtest/PORTFOLIO_BACKTEST_GUIDE.md)
- [Optimization Guide](../backtest/OPTIMIZATION_API_GUIDE.md)

---

**Deployment Lead**: Cursor (Claude 3.5 Sonnet)  
**Approval Required**: Yes (Production changes)  
**Rollback Time**: <5 minutes  
**Risk Assessment**: LOW (read-only features)

