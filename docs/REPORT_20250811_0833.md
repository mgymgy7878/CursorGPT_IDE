## İçindekiler
- [Yürütücü Özet](#yürütücü-özet)
- [Mimari](#mimari)
- [Veri Akışı](#veri-akışı)
- [Modüller](#modüller)
- [Telemetri ve Metrikler](#telemetri-ve-metrikler)
- [Performans Optimizasyonları](#performans-optimizasyonları)
- [Güvenlik](#güvenlik)
- [Konfigürasyon](#konfigürasyon)
- [Scriptler](#scriptler)
- [Test/Doğrulama](#testdoğrulama)
- [Riskler ve Açık Sorular](#riskler-ve-açık-sorular)
- [Önerilen Sonraki Adımlar](#önerilen-sonraki-adımlar)

## Yürütücü Özet
Proje, Next.js 14 + TypeScript 5 monorepo içinde çoklu borsa (Binance, Bybit, OKX) portföy yönetimi, strateji laboratuvarı, optimizasyon, gözlem/telemetri özellikleriyle gerçek zamanlı bir al-sat otomasyon platformudur. WS tabanlı hub (Bybit/OKX private WS, exponential backoff) ve REST fallback ile Portföy UI canlı güncellenir. Prometheus uyumlu metrikler, JSON/SSE akışları ve Gözlem paneli ile operasyonel görünürlük yüksektir. Bu rapor mimariyi, veri akışını, metrikleri, performans ve güvenlik yaklaşımlarını, doğrulama sonuçlarını ve yol haritasını özetler.

## Mimari
- Frontend: `apps/web-next` (Next.js 14, Tailwind), sayfalar: `index`, `StratejiJeneratoru`, `Stratejilerim`, `PortfoyYonetimi`, `Ayarlar`, `Gozlem`.
- Server/Hub: `apps/web-next/server/portfolioHub.ts` WS istemcileri (Bybit/OKX), diff-based publish, metrik snapshot üretimi.
- Services/Adapters: `services/*` (Binance/Bybit/OKX REST imzalama, retry/backoff), `apps/web-next/server/ws/*` (BybitWS/OKXWS).
- API Uçları: `/api/broker/{exchange}/positions|balance|orders|close|cancel|creds`, `/api/portfolio/stream` (SSE), `/api/metrics`, `/api/metrics/stream`, `/api/metrics/prom`.

## Veri Akışı
- WS → Hub: Özel kanallar (positions/orders) → parse → telemetry + snapshot update.
- Hub → SSE: JSON diff ile minimal publish; UI yalnızca değişen alanları işler.
- REST Fallback: WS yoksa periyodik REST poll (withRetry, exponential backoff). UI 5 sn’de bir fallback yenileme ile tutarlı kalır.

## Modüller
- Strateji Jeneratörü/Laboratuvarı: Parametre düzenleme, kayıt/yükleme (`SaveLoadBar.tsx`), geri test tetikleme.
- Stratejilerim: Kayıtlı strateji listesi, sil/yükle.
- Portföy Yönetimi: Çoklu borsa bakiye/pozisyon/emir görünümü; market/limit kapatma, emir iptali, otomatik yenileme; latans ve render sayaçları.
- Ayarlar: Binance/Bybit/OKX API anahtarları; Bybit/OKX testnet toggle; görsel kayıt geribildirimi.
- Observability: `Gozlem.tsx` canlı metrik kartları, renk kodları, mini trend grafiği (canvas), SSE ile 1 Hz güncelleme.

## Telemetri ve Metrikler
- Endpoints: `/api/metrics` (JSON), `/api/metrics/stream` (SSE), `/api/metrics/prom` (Prometheus text).
- Ana metrikler:
  - ws_uptime_ratio (gauge), publish_skip_ratio (gauge), error_budget_miss_count (counter), error_budget_miss_rate_5m (gauge).
  - last_message_delay_ms (gauge) + EMA’lar: last_message_delay_ms_ema_1m/5m/15m (gauges).
  - *_last_updated zaman damgaları (gauge) ve exchange kırılımları için publish/skip sayaçları.
- UI renk eşikleri: uptime < 0.8 kırmızı, 0.8–0.9 sarı; delay1m > 1000 ms sarı, > 2000 ms kırmızı; error_budget_miss_rate_5m > 5 kırmızı.

## Performans Optimizasyonları
- Hub’da JSON diff ile gereksiz publish engeli (publish/skip sayacı ve diff kontrolü).
- UI’da conditional setState ve shallow eşitlik kullanımı; mini grafik canvas ile düşük maliyetli.
- WS reconnect exponential backoff; fallback REST poll oranı telemetriye işleniyor.

## Güvenlik
- Kimlik bilgileri: `.env` öncelikli; yoksa `.secrets/{exchange}.json` (git-ignore). Sunucu tarafında erişim; istemciye sızdırılmaz.
- İmzalama: HMAC-SHA256 (Bybit/OKX), canlı endpoint seçimi testnet toggles ile; retry/backoff 429 için structured logging ile birlikte.

## Konfigürasyon
- next.config.js: Türkçe rotalar ve rewrites; gerekli durumlarda `LEGACY_FORWARD` opsiyonu.
- tailwind.config.js: `apps/web-next` içerik yolları ekli; uyarılar giderildi.
- TS path/alias’lar: monorepo baz tsconfig üzerinden.

## Scriptler
- Geliştirme: `scripts/dev.ps1` (port kill + next dev). `npm --prefix apps/web-next run dev`.
- Güvenli Yedek: `scripts/safe-backup.ps1 -Tag <etiket> -NoLint -SkipBuild`.
- Port Temizliği: `scripts/kill-port.ps1 -Ports 3003`.

## Test/Doğrulama
- Typecheck: OK (tsc --noEmit).
- Build: Windows’ta EPERM (dosya kilidi) hatası görüldü. Çözüm: dev sunucuyu durdurup `.next` silin, antivirüs kilitlerini kapatın, tekrar deneyin. Gerekirse `NEXT_IGNORE_ESLINT=1` ile lint bypass.
- Smoke: `/`, `/Gozlem`, `/PortfoyYonetimi`, `/Ayarlar`, `/api/metrics`, `/api/metrics/prom` yanıt veriyor.

## Riskler ve Açık Sorular
- WS kimlik doğrulama hataları ve borsa kesintileri; fallback yeterli ancak gecikme artar.
- Windows FS kilitlenmeleri (EPERM); CI/CD’de Linux runner önerilir.
- Testnet/Live karışıklığı: UI’da belirgin mod göstergesi sürdürülmeli.
- Rate-limit (429) tepe anlarında error budget artışı; geri kazanım süresi izlenmeli.

## Önerilen Sonraki Adımlar
- Grafana dashboard JSON’unu ekle ve import rehberi (panel eşikleri dahil).
- Alertmanager entegrasyonunu üretimde doğrula (Telegram kritik, Discord uyarı).
- WS mesaj gecikmesi için per-exchange breakdown ve p95/p99 ölçümleri.
- Portföy UI’da satır bazlı delta highlight ve skeleton yüklenme durumu.
- CI pipeline (typecheck + build + prom format lint) ve Windows dışı runner. 