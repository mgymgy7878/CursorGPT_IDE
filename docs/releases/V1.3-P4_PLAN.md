# V1.3-P4 â€¢ HEALTH VISUALIZATION â€” OPERASYONEL PLAN

**Durum:** ğŸŸ¡ Planning  
**BaÅŸlangÄ±Ã§:** TBD (P3 merge sonrasÄ±)  
**Tahmini SÃ¼re:** 3-4 gÃ¼n  
**Branch:** `feature/v1.3-p4-health-viz`

---

## ğŸ¯ HEDEFLER

1. **StatusBadge Migration** â†’ TÃ¼m eski chip/badge/pill bileÅŸenlerini deÄŸiÅŸtir
2. **Health Status Logic** â†’ Metriklerden otomatik durum belirleme
3. **Canary/Health Integration** â†’ Kartlara StatusBadge renk sistemi
4. **WS Layer Cleanup** â†’ Reconnect/log gÃ¼rÃ¼ltÃ¼sÃ¼ azaltma

---

## ğŸ“¦ SPRINT KIRILIMI

### P4-A: StatusBadge Migration (0.5 gÃ¼n)

**Hedef:** Eski chip/badge bileÅŸenlerini StatusBadge'e dÃ¶nÃ¼ÅŸtÃ¼r

**Dosyalar:**
- `apps/web-next/src/components/common/SLOChip.tsx` â†’ StatusBadge
- `apps/web-next/src/components/ui/DataModeBadge.tsx` â†’ StatusBadge
- `apps/web-next/src/components/dashboard/DraftsBadge.tsx` â†’ StatusBadge
- `apps/web-next/src/components/layout/StatusChip.tsx` â†’ StatusBadge (veya kaldÄ±r)

**Renk EÅŸlemesi:**
```typescript
const statusMap: Record<string, Status> = {
  healthy: 'success',
  degraded: 'warn',
  outage: 'error',
  unknown: 'neutral',
  online: 'success',
  offline: 'error',
  active: 'success',
  paused: 'warn',
};
```

**Test:**
```bash
# Her sayfa iÃ§in manuel kontrol
http://localhost:3003/dashboard   # SLOChip â†’ StatusBadge
http://localhost:3003/portfolio    # DataModeBadge â†’ StatusBadge
http://localhost:3003/alerts       # DraftsBadge â†’ StatusBadge
```

**Commit:** `refactor(ui): migrate SLOChip, DataModeBadge, DraftsBadge to StatusBadge`

---

### P4-B: Health Status Logic (1 gÃ¼n)

**Hedef:** Metriklerden otomatik durum belirleme fonksiyonu

**Yeni Dosya:** `apps/web-next/src/lib/health.ts`

```typescript
export type HealthStatus = 'success' | 'warn' | 'error' | 'neutral';

export interface HealthMetrics {
  error_rate_p95?: number;
  staleness_s?: number;
  uptime_pct?: number;
}

export interface HealthThresholds {
  error_rate_p95: number;    // 0.01 (1%)
  staleness_s: number;        // 60 seconds
  uptime_pct: number;         // 99%
}

const DEFAULT_THRESHOLDS: HealthThresholds = {
  error_rate_p95: 0.01,
  staleness_s: 60,
  uptime_pct: 99.0,
};

export function getHealthStatus(
  metrics: HealthMetrics,
  thresholds: HealthThresholds = DEFAULT_THRESHOLDS
): HealthStatus {
  // Error rate check
  if (metrics.error_rate_p95 !== undefined) {
    if (metrics.error_rate_p95 > thresholds.error_rate_p95 * 2) return 'error';
    if (metrics.error_rate_p95 > thresholds.error_rate_p95) return 'warn';
  }
  
  // Staleness check
  if (metrics.staleness_s !== undefined) {
    if (metrics.staleness_s > thresholds.staleness_s * 2) return 'error';
    if (metrics.staleness_s > thresholds.staleness_s) return 'warn';
  }
  
  // Uptime check
  if (metrics.uptime_pct !== undefined) {
    if (metrics.uptime_pct < thresholds.uptime_pct - 5) return 'error';
    if (metrics.uptime_pct < thresholds.uptime_pct) return 'warn';
  }
  
  // All checks passed
  return 'success';
}
```

**Canary/Health Entegrasyonu:**
```typescript
// apps/web-next/src/components/dashboard/CanaryCard.tsx
import { getHealthStatus } from '@/lib/health';
import StatusBadge from '@/components/ui/StatusBadge';

const metrics = { error_rate_p95: 0.005, staleness_s: 30, uptime_pct: 99.8 };
const status = getHealthStatus(metrics);

<StatusBadge status={status} label={t(`status.${status}`)} />
```

**Test:**
```typescript
// apps/web-next/src/lib/health.test.ts
import { getHealthStatus } from './health';

describe('getHealthStatus', () => {
  test('returns success for healthy metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.001,
      staleness_s: 10,
      uptime_pct: 99.9
    })).toBe('success');
  });
  
  test('returns warn for degraded metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.015,
      staleness_s: 80,
    })).toBe('warn');
  });
  
  test('returns error for outage metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.05,
      uptime_pct: 90.0
    })).toBe('error');
  });
});
```

**Commit:** `feat(health): add metric-based health status logic`

---

### P4-C: WS Layer Cleanup (1 gÃ¼n)

**Hedef:** Reconnect gÃ¼rÃ¼ltÃ¼sÃ¼nÃ¼ azalt, exponential backoff

**Dosya:** `apps/web-next/src/app/api/marketdata/stream/route.ts`

**DeÄŸiÅŸiklikler:**
```typescript
// Exponential backoff helper
function getBackoffDelay(attempt: number, baseMs = 500, maxMs = 15000): number {
  const delay = Math.min(baseMs * Math.pow(2, attempt), maxMs);
  const jitter = delay * 0.1 * Math.random();
  return delay + jitter;
}

// Coalesced logging
let lastLogTime = 0;
function logWs(level: 'info' | 'warn' | 'error', message: string) {
  const now = Date.now();
  if (now - lastLogTime > 2000) { // 2s throttle
    console[level](message);
    lastLogTime = now;
  }
}

// Reconnect logic
let reconnectAttempt = 0;
ws.on('close', () => {
  const delay = getBackoffDelay(reconnectAttempt++);
  logWs('warn', `WS closed, reconnecting in ${delay}ms (attempt ${reconnectAttempt})`);
  setTimeout(() => connectWs(), delay);
});
```

**Type Safety:**
```typescript
// Fix existing TS errors
import WS from 'ws';

let ws: WS.WebSocket | null = null;

ws = new WS.WebSocket(url, { handshakeTimeout: 5000 });

if (ws) {
  ws.on("open", () => { /* ... */ });
}
```

**Commit:** `fix(ws): exponential backoff + coalesced logging`

---

### P4-D: Visual QA & Storybook (0.5 gÃ¼n - Opsiyonel)

**Hedef:** GÃ¶rsel regresyon baseline

**Storybook Stories:**
```typescript
// apps/web-next/src/components/ui/StatusBadge.stories.tsx
import StatusBadge from './StatusBadge';

export default {
  title: 'UI/StatusBadge',
  component: StatusBadge,
};

export const Success = () => <StatusBadge status="success" label="SaÄŸlÄ±klÄ±" />;
export const Warn = () => <StatusBadge status="warn" label="BozulmuÅŸ" />;
export const Error = () => <StatusBadge status="error" label="Ã‡alÄ±ÅŸmÄ±yor" />;
export const Info = () => <StatusBadge status="info" label="Bilgi" />;
export const Neutral = () => <StatusBadge status="neutral" label="Belirsiz" />;
```

**Chromatic Snapshot:**
- StatusBadge (5 variant)
- KPI Card with StatusBadge
- Canary Card with health status

**Commit:** `chore(storybook): add StatusBadge stories + Chromatic baseline`

---

## âœ… DOÄRULAMA & SMOKE TEST

### Manuel QA Checklist

**Dashboard** (<http://localhost:3003/dashboard>)
- [ ] Canary kartÄ± â†’ StatusBadge, renk metriklere gÃ¶re
- [ ] Health Ã¶zeti â†’ StatusBadge, eÅŸik kontrolÃ¼
- [ ] SLO chip'leri â†’ StatusBadge

**Portfolio** (<http://localhost:3003/portfolio>)
- [ ] DataModeBadge â†’ StatusBadge
- [ ] BaÄŸlantÄ± durumu â†’ StatusBadge

**Alerts** (<http://localhost:3003/alerts>)
- [ ] DraftsBadge â†’ StatusBadge

**Responsive**
- [ ] 1024-1440 px â†’ taÅŸma yok
- [ ] Mobile/iOS â†’ safe-area Ã§alÄ±ÅŸÄ±yor

**Theme & i18n**
- [ ] Dark/Light â†’ kontrast korunuyor
- [ ] TRâ†”EN â†’ tÃ¼m label'lar doÄŸru

### Regresyon Matrisi

| Test | Hedef | Kontrol |
|------|-------|---------|
| **StatusBadge kullanÄ±mÄ±** | %100 (eski chip yok) | grep ile scan |
| **Health logic** | 3+ test geÃ§iyor | Jest |
| **WS log azalma** | %50â†“ | Dev console |
| **TypeCheck** | 0 error | `pnpm typecheck` |
| **Build** | SUCCESS | `pnpm build` |

---

## ğŸ”§ HEMEN UYGULANACAKLAR

### 1. Jest Types Kurulumu
```bash
cd apps/web-next
pnpm add -D @types/jest jest
pnpm test  # format.test.ts Ã§alÄ±ÅŸtÄ±r
```

### 2. StatusBadge Migration (Ä°lk 3 dosya)
```bash
# SLOChip
rg -n "SLOChip" apps/web-next/src --files-with-matches
# â†’ StatusBadge'e Ã§evir

# DataModeBadge
rg -n "DataModeBadge" apps/web-next/src --files-with-matches
# â†’ StatusBadge'e Ã§evir

# DraftsBadge
rg -n "DraftsBadge" apps/web-next/src --files-with-matches
# â†’ StatusBadge'e Ã§evir
```

### 3. Health Logic Skeleton
```bash
# Dosya oluÅŸtur
touch apps/web-next/src/lib/health.ts
touch apps/web-next/src/lib/health.test.ts

# YukarÄ±daki kod'u yapÄ±ÅŸtÄ±r
# Test Ã§alÄ±ÅŸtÄ±r
pnpm test health.test.ts
```

---

## ğŸ“Š BAÅARI KRÄ°TERLERÄ°

| Kriter | Hedef | Ã–lÃ§Ã¼m |
|--------|-------|-------|
| Eski chip bileÅŸeni | 0 | grep scan |
| StatusBadge kullanÄ±mÄ± | 10+ yer | grep scan |
| Health logic test | 3+ | Jest pass |
| WS log azalma | %50â†“ | Console count |
| TypeCheck | 0 error | `pnpm typecheck` |
| Build time | <30s | `pnpm build` |

---

## âš ï¸ RÄ°SKLER & AZALTMA

| Risk | OlasÄ±lÄ±k | Etki | Azaltma |
|------|----------|------|---------|
| Eski chip kullanÄ±mÄ± kaldÄ± | Orta | Orta | grep scan + deprecation warning |
| Health eÅŸikleri yanlÄ±ÅŸ | DÃ¼ÅŸÃ¼k | YÃ¼ksek | Test suite + manuel QA |
| WS backoff Ã§ok agresif | DÃ¼ÅŸÃ¼k | Orta | Ayarlanabilir parametreler |

---

## ğŸ”— BAÄIMLILIKLAR

- **P3 Ã‡Ä±ktÄ±sÄ±:** StatusBadge component, `status.*` tokens
- **Jest Setup:** @types/jest, jest.config.js
- **Health Metrics:** Backend API `/api/health` endpoint (varsa)

---

## ğŸ“ COMMIT & PR STRATEJÄ°SÄ°

### Commit SÄ±rasÄ±
1. `test(jest): add @types/jest dependency`
2. `refactor(ui): migrate SLOChip to StatusBadge`
3. `refactor(ui): migrate DataModeBadge to StatusBadge`
4. `refactor(ui): migrate DraftsBadge to StatusBadge`
5. `feat(health): add metric-based health status logic`
6. `feat(health): integrate StatusBadge with Canary/Health cards`
7. `fix(ws): exponential backoff + coalesced logging`
8. `chore(storybook): add StatusBadge stories` (opsiyonel)

### PR BaÅŸlÄ±ÄŸÄ±
`V1.3-P4 â€¢ Health Visualization - StatusBadge Migration + Health Logic`

### PR AÃ§Ä±klamasÄ±
- **Migration:** SLOChip, DataModeBadge, DraftsBadge â†’ StatusBadge
- **Health Logic:** `getHealthStatus()` metrik eÅŸikleriyle
- **Canary/Health:** Kartlara StatusBadge entegrasyonu
- **WS Cleanup:** Exponential backoff, log throttle
- **Screenshots:** Ã–nce/Sonra (Canary kartÄ±, Health Ã¶zeti)

---

## ğŸ¯ SONRAKÄ° ADIM (P5 Ã–n PlanÄ±)

**P5: Dynamic Thresholds & Settings Panel**
- Guardrails/health eÅŸiklerini Settings'ten dÃ¼zenle
- Real-time eÅŸik gÃ¼ncelleme
- Threshold history & audit trail

---

**Durum:** DRAFT â†’ P3 merge sonrasÄ± ACTIVE  
**Atanan:** TBD  
**Milestone:** V1.3-P4
