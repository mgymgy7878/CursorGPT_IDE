# V1.3-P4 • HEALTH VISUALIZATION — OPERASYONEL PLAN

**Durum:** 🟡 Planning  
**Başlangıç:** TBD (P3 merge sonrası)  
**Tahmini Süre:** 3-4 gün  
**Branch:** `feature/v1.3-p4-health-viz`

---

## 🎯 HEDEFLER

1. **StatusBadge Migration** → Tüm eski chip/badge/pill bileşenlerini değiştir
2. **Health Status Logic** → Metriklerden otomatik durum belirleme
3. **Canary/Health Integration** → Kartlara StatusBadge renk sistemi
4. **WS Layer Cleanup** → Reconnect/log gürültüsü azaltma

---

## 📦 SPRINT KIRILIMI

### P4-A: StatusBadge Migration (0.5 gün)

**Hedef:** Eski chip/badge bileşenlerini StatusBadge'e dönüştür

**Dosyalar:**
- `apps/web-next/src/components/common/SLOChip.tsx` → StatusBadge
- `apps/web-next/src/components/ui/DataModeBadge.tsx` → StatusBadge
- `apps/web-next/src/components/dashboard/DraftsBadge.tsx` → StatusBadge
- `apps/web-next/src/components/layout/StatusChip.tsx` → StatusBadge (veya kaldır)

**Renk Eşlemesi:**
```typescript
const statusMap: Record<string, Status> = {
  healthy: 'success',
  degraded: 'warn',
  outage: 'error',
  unknown: 'neutral',
  online: 'success',
  offline: 'error',
  active: 'success',
  paused: 'warn',
};
```

**Test:**
```bash
# Her sayfa için manuel kontrol
http://localhost:3003/dashboard   # SLOChip → StatusBadge
http://localhost:3003/portfolio    # DataModeBadge → StatusBadge
http://localhost:3003/alerts       # DraftsBadge → StatusBadge
```

**Commit:** `refactor(ui): migrate SLOChip, DataModeBadge, DraftsBadge to StatusBadge`

---

### P4-B: Health Status Logic (1 gün)

**Hedef:** Metriklerden otomatik durum belirleme fonksiyonu

**Yeni Dosya:** `apps/web-next/src/lib/health.ts`

```typescript
export type HealthStatus = 'success' | 'warn' | 'error' | 'neutral';

export interface HealthMetrics {
  error_rate_p95?: number;
  staleness_s?: number;
  uptime_pct?: number;
}

export interface HealthThresholds {
  error_rate_p95: number;    // 0.01 (1%)
  staleness_s: number;        // 60 seconds
  uptime_pct: number;         // 99%
}

const DEFAULT_THRESHOLDS: HealthThresholds = {
  error_rate_p95: 0.01,
  staleness_s: 60,
  uptime_pct: 99.0,
};

export function getHealthStatus(
  metrics: HealthMetrics,
  thresholds: HealthThresholds = DEFAULT_THRESHOLDS
): HealthStatus {
  // Error rate check
  if (metrics.error_rate_p95 !== undefined) {
    if (metrics.error_rate_p95 > thresholds.error_rate_p95 * 2) return 'error';
    if (metrics.error_rate_p95 > thresholds.error_rate_p95) return 'warn';
  }
  
  // Staleness check
  if (metrics.staleness_s !== undefined) {
    if (metrics.staleness_s > thresholds.staleness_s * 2) return 'error';
    if (metrics.staleness_s > thresholds.staleness_s) return 'warn';
  }
  
  // Uptime check
  if (metrics.uptime_pct !== undefined) {
    if (metrics.uptime_pct < thresholds.uptime_pct - 5) return 'error';
    if (metrics.uptime_pct < thresholds.uptime_pct) return 'warn';
  }
  
  // All checks passed
  return 'success';
}
```

**Canary/Health Entegrasyonu:**
```typescript
// apps/web-next/src/components/dashboard/CanaryCard.tsx
import { getHealthStatus } from '@/lib/health';
import StatusBadge from '@/components/ui/StatusBadge';

const metrics = { error_rate_p95: 0.005, staleness_s: 30, uptime_pct: 99.8 };
const status = getHealthStatus(metrics);

<StatusBadge status={status} label={t(`status.${status}`)} />
```

**Test:**
```typescript
// apps/web-next/src/lib/health.test.ts
import { getHealthStatus } from './health';

describe('getHealthStatus', () => {
  test('returns success for healthy metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.001,
      staleness_s: 10,
      uptime_pct: 99.9
    })).toBe('success');
  });
  
  test('returns warn for degraded metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.015,
      staleness_s: 80,
    })).toBe('warn');
  });
  
  test('returns error for outage metrics', () => {
    expect(getHealthStatus({
      error_rate_p95: 0.05,
      uptime_pct: 90.0
    })).toBe('error');
  });
});
```

**Commit:** `feat(health): add metric-based health status logic`

---

### P4-C: WS Layer Cleanup (1 gün)

**Hedef:** Reconnect gürültüsünü azalt, exponential backoff

**Dosya:** `apps/web-next/src/app/api/marketdata/stream/route.ts`

**Değişiklikler:**
```typescript
// Exponential backoff helper
function getBackoffDelay(attempt: number, baseMs = 500, maxMs = 15000): number {
  const delay = Math.min(baseMs * Math.pow(2, attempt), maxMs);
  const jitter = delay * 0.1 * Math.random();
  return delay + jitter;
}

// Coalesced logging
let lastLogTime = 0;
function logWs(level: 'info' | 'warn' | 'error', message: string) {
  const now = Date.now();
  if (now - lastLogTime > 2000) { // 2s throttle
    console[level](message);
    lastLogTime = now;
  }
}

// Reconnect logic
let reconnectAttempt = 0;
ws.on('close', () => {
  const delay = getBackoffDelay(reconnectAttempt++);
  logWs('warn', `WS closed, reconnecting in ${delay}ms (attempt ${reconnectAttempt})`);
  setTimeout(() => connectWs(), delay);
});
```

**Type Safety:**
```typescript
// Fix existing TS errors
import WS from 'ws';

let ws: WS.WebSocket | null = null;

ws = new WS.WebSocket(url, { handshakeTimeout: 5000 });

if (ws) {
  ws.on("open", () => { /* ... */ });
}
```

**Commit:** `fix(ws): exponential backoff + coalesced logging`

---

### P4-D: Visual QA & Storybook (0.5 gün - Opsiyonel)

**Hedef:** Görsel regresyon baseline

**Storybook Stories:**
```typescript
// apps/web-next/src/components/ui/StatusBadge.stories.tsx
import StatusBadge from './StatusBadge';

export default {
  title: 'UI/StatusBadge',
  component: StatusBadge,
};

export const Success = () => <StatusBadge status="success" label="Sağlıklı" />;
export const Warn = () => <StatusBadge status="warn" label="Bozulmuş" />;
export const Error = () => <StatusBadge status="error" label="Çalışmıyor" />;
export const Info = () => <StatusBadge status="info" label="Bilgi" />;
export const Neutral = () => <StatusBadge status="neutral" label="Belirsiz" />;
```

**Chromatic Snapshot:**
- StatusBadge (5 variant)
- KPI Card with StatusBadge
- Canary Card with health status

**Commit:** `chore(storybook): add StatusBadge stories + Chromatic baseline`

---

## ✅ DOĞRULAMA & SMOKE TEST

### Manuel QA Checklist

**Dashboard** (<http://localhost:3003/dashboard>)
- [ ] Canary kartı → StatusBadge, renk metriklere göre
- [ ] Health özeti → StatusBadge, eşik kontrolü
- [ ] SLO chip'leri → StatusBadge

**Portfolio** (<http://localhost:3003/portfolio>)
- [ ] DataModeBadge → StatusBadge
- [ ] Bağlantı durumu → StatusBadge

**Alerts** (<http://localhost:3003/alerts>)
- [ ] DraftsBadge → StatusBadge

**Responsive**
- [ ] 1024-1440 px → taşma yok
- [ ] Mobile/iOS → safe-area çalışıyor

**Theme & i18n**
- [ ] Dark/Light → kontrast korunuyor
- [ ] TR↔EN → tüm label'lar doğru

### Regresyon Matrisi

| Test | Hedef | Kontrol |
|------|-------|---------|
| **StatusBadge kullanımı** | %100 (eski chip yok) | grep ile scan |
| **Health logic** | 3+ test geçiyor | Jest |
| **WS log azalma** | %50↓ | Dev console |
| **TypeCheck** | 0 error | `pnpm typecheck` |
| **Build** | SUCCESS | `pnpm build` |

---

## 🔧 HEMEN UYGULANACAKLAR

### 1. Jest Types Kurulumu
```bash
cd apps/web-next
pnpm add -D @types/jest jest
pnpm test  # format.test.ts çalıştır
```

### 2. StatusBadge Migration (İlk 3 dosya)
```bash
# SLOChip
rg -n "SLOChip" apps/web-next/src --files-with-matches
# → StatusBadge'e çevir

# DataModeBadge
rg -n "DataModeBadge" apps/web-next/src --files-with-matches
# → StatusBadge'e çevir

# DraftsBadge
rg -n "DraftsBadge" apps/web-next/src --files-with-matches
# → StatusBadge'e çevir
```

### 3. Health Logic Skeleton
```bash
# Dosya oluştur
touch apps/web-next/src/lib/health.ts
touch apps/web-next/src/lib/health.test.ts

# Yukarıdaki kod'u yapıştır
# Test çalıştır
pnpm test health.test.ts
```

---

## 📊 BAŞARI KRİTERLERİ

| Kriter | Hedef | Ölçüm |
|--------|-------|-------|
| Eski chip bileşeni | 0 | grep scan |
| StatusBadge kullanımı | 10+ yer | grep scan |
| Health logic test | 3+ | Jest pass |
| WS log azalma | %50↓ | Console count |
| TypeCheck | 0 error | `pnpm typecheck` |
| Build time | <30s | `pnpm build` |

---

## ⚠️ RİSKLER & AZALTMA

| Risk | Olasılık | Etki | Azaltma |
|------|----------|------|---------|
| Eski chip kullanımı kaldı | Orta | Orta | grep scan + deprecation warning |
| Health eşikleri yanlış | Düşük | Yüksek | Test suite + manuel QA |
| WS backoff çok agresif | Düşük | Orta | Ayarlanabilir parametreler |

---

## 🔗 BAĞIMLILIKLAR

- **P3 Çıktısı:** StatusBadge component, `status.*` tokens
- **Jest Setup:** @types/jest, jest.config.js
- **Health Metrics:** Backend API `/api/health` endpoint (varsa)

---

## 📝 COMMIT & PR STRATEJİSİ

### Commit Sırası
1. `test(jest): add @types/jest dependency`
2. `refactor(ui): migrate SLOChip to StatusBadge`
3. `refactor(ui): migrate DataModeBadge to StatusBadge`
4. `refactor(ui): migrate DraftsBadge to StatusBadge`
5. `feat(health): add metric-based health status logic`
6. `feat(health): integrate StatusBadge with Canary/Health cards`
7. `fix(ws): exponential backoff + coalesced logging`
8. `chore(storybook): add StatusBadge stories` (opsiyonel)

### PR Başlığı
`V1.3-P4 • Health Visualization - StatusBadge Migration + Health Logic`

### PR Açıklaması
- **Migration:** SLOChip, DataModeBadge, DraftsBadge → StatusBadge
- **Health Logic:** `getHealthStatus()` metrik eşikleriyle
- **Canary/Health:** Kartlara StatusBadge entegrasyonu
- **WS Cleanup:** Exponential backoff, log throttle
- **Screenshots:** Önce/Sonra (Canary kartı, Health özeti)

---

## 🎯 SONRAKİ ADIM (P5 Ön Planı)

**P5: Dynamic Thresholds & Settings Panel**
- Guardrails/health eşiklerini Settings'ten düzenle
- Real-time eşik güncelleme
- Threshold history & audit trail

---

**Durum:** DRAFT → P3 merge sonrası ACTIVE  
**Atanan:** TBD  
**Milestone:** V1.3-P4
