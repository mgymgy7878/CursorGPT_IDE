# V1.3-P6 Implementation Plan: Core Completions

**Tarih:** 2025-10-18  
**Sprint:** V1.3-P6 (Core Completions)  
**Süre:** 1-2 hafta  
**Durum:** 🟢 READY TO START

---

## 📋 SPRINT GOAL

**3 Ana Hedef:**
1. **Strategies Page** - Full CRUD implementation (placeholder → production)
2. **Component Library** - Unified Input/Select/Form components
3. **Audit Log Viewer** - `/audit` sayfası (yeni)

**Bonus (time allowing):**
4. AI Optimizer UI polish
5. Strategy Editor syntax highlighting

---

## 1. STRATEGIES PAGE - FULL IMPLEMENTATION

### 1.1 Mevcut Durum

**Dosya:** `apps/web-next/src/app/strategies/page.tsx`

```typescript
// ❌ Static mock data
const strategies = [
  { id: 1, name: "EMA Crossover BTC", status: "draft", createdAt: "2024-01-15" },
  { id: 2, name: "RSI Oversold ETH", status: "active", createdAt: "2024-01-14" },
  { id: 3, name: "MACD Divergence", status: "paused", createdAt: "2024-01-13" },
];
```

### 1.2 Backend API Endpoints

```typescript
GET    /api/strategies/list          // List all strategies
POST   /api/strategies/create        // Create new strategy
POST   /api/strategies/delete        // Delete strategy
POST   /api/strategy/control         // Start/Stop/Pause strategy
GET    /api/strategy/preview         // Preview strategy config
```

### 1.3 Implementation Tasks

#### Task 1.1: API Integration
- [ ] `useStrategies` hook oluştur (`src/hooks/useStrategies.ts`)
- [ ] `GET /api/strategies/list` entegrasyonu
- [ ] Real-time refresh (polling veya WebSocket)
- [ ] Error handling + loading states

#### Task 1.2: CRUD Operations
- [ ] Create Strategy modal
  - Name, symbol, timeframe inputs
  - Strategy type selection (EMA, RSI, MACD, etc.)
  - Parameter configuration
- [ ] Delete confirmation modal
- [ ] Edit strategy (inline veya modal)

#### Task 1.3: Strategy Detail Panel
- [ ] Strategy metadata (name, created, status)
- [ ] Performance metrics (sharpe, PnL, trades)
- [ ] Last backtest result
- [ ] Control buttons (Start/Stop/Pause/Delete)

#### Task 1.4: Strategy Controls
- [ ] Start/Stop/Pause buttons
- [ ] Status indicator (StatusBadge entegrasyonu)
- [ ] Live control via `/api/strategy/control`

#### Task 1.5: UI Polish
- [ ] Skeleton loading states
- [ ] Empty state ("Henüz strateji yok" + create button)
- [ ] Sort/filter controls (name, status, created date)
- [ ] Mobile responsive

### 1.4 Component Structure

```
apps/web-next/src/
├── app/strategies/
│   └── page.tsx (main page)
├── components/strategies/
│   ├── StrategyList.tsx (list + table)
│   ├── StrategyDetailPanel.tsx (detail view)
│   ├── CreateStrategyModal.tsx (creation flow)
│   ├── StrategyControls.tsx (start/stop/pause)
│   └── StrategyStatusBadge.tsx (status indicator)
├── hooks/
│   └── useStrategies.ts (API integration)
└── lib/
    └── strategies.ts (types + helpers)
```

### 1.5 Design Mockup (Text)

```
┌─────────────────────────────────────────────────────────────────┐
│ Stratejilerim                                    [+ Yeni Strateji]│
│ Tüm stratejilerinizi görüntüleyin ve yönetin                      │
├─────────────────────┬───────────────────────────────────────────┤
│ Stratejilerim       │ Detay                                     │
│ ┌─────────────────┐ │ ┌───────────────────────────────────────┐│
│ │ EMA Cross BTC   │ │ │ EMA Crossover BTC                     ││
│ │ 🟢 Active       │ │ │ ┌─────────────────────────────────────┐│
│ │ 2024-01-15      │ │ │ │ Strateji Adı: EMA Crossover BTC     ││
│ └─────────────────┘ │ │ │ Durum: 🟢 Active                    ││
│ ┌─────────────────┐ │ │ │ Oluşturulma: 2024-01-15 14:30       ││
│ │ RSI ETH         │ │ │ │ Son Backtest: 2024-01-15 16:45      ││
│ │ ⚪ Draft         │ │ │ └─────────────────────────────────────┘│
│ │ 2024-01-14      │ │ │ ┌───────────────────────────────────  ││
│ └─────────────────┘ │ │ │ Performans                          ││
│                     │ │ │ Sharpe: 1.45  Max DD: 12%           ││
│                     │ │ │ PnL: +$245.50  Trades: 23           ││
│                     │ │ └─────────────────────────────────────┘│
│                     │ │ [Backtest] [Optimize] [Delete]        ││
│                     │ │ [⏸️ Duraklat]                           ││
└─────────────────────┴───────────────────────────────────────────┘
```

### 1.6 Acceptance Criteria

- [ ] `/api/strategies/list` gerçek veri gösteriyor
- [ ] Yeni strateji oluşturma çalışıyor
- [ ] Strateji silme çalışıyor (confirmation ile)
- [ ] Start/Stop/Pause kontrolleri çalışıyor
- [ ] StatusBadge entegre
- [ ] Mobile responsive
- [ ] Loading/error states handled
- [ ] TypeCheck PASS
- [ ] i18n keys added (TR/EN parity)

---

## 2. COMPONENT LIBRARY - PHASE 1

### 2.1 Unified Input Component

**Dosya:** `apps/web-next/src/components/ui/Input.tsx`

```typescript
import { forwardRef } from 'react';

export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ label, error, helperText, className, ...props }, ref) => {
    return (
      <div className="space-y-1">
        {label && (
          <label className="block text-sm font-medium text-neutral-300">
            {label}
          </label>
        )}
        <input
          ref={ref}
          className={`w-full px-3 py-2 bg-neutral-800 border ${
            error ? 'border-red-500' : 'border-neutral-700'
          } rounded-lg text-white placeholder-neutral-500 focus:border-blue-500 focus:outline-none ${className || ''}`}
          {...props}
        />
        {error && <p className="text-xs text-red-400">{error}</p>}
        {helperText && !error && <p className="text-xs text-neutral-400">{helperText}</p>}
      </div>
    );
  }
);
```

### 2.2 Unified Select Component

**Dosya:** `apps/web-next/src/components/ui/Select.tsx`

```typescript
export interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  error?: string;
  helperText?: string;
  options: { value: string; label: string }[];
}

export const Select = forwardRef<HTMLSelectElement, SelectProps>(
  ({ label, error, helperText, options, className, ...props }, ref) => {
    return (
      <div className="space-y-1">
        {label && (
          <label className="block text-sm font-medium text-neutral-300">
            {label}
          </label>
        )}
        <select
          ref={ref}
          className={`w-full px-3 py-2 bg-neutral-800 border ${
            error ? 'border-red-500' : 'border-neutral-700'
          } rounded-lg text-white focus:border-blue-500 focus:outline-none ${className || ''}`}
          {...props}
        >
          {options.map(opt => (
            <option key={opt.value} value={opt.value}>{opt.label}</option>
          ))}
        </select>
        {error && <p className="text-xs text-red-400">{error}</p>}
        {helperText && !error && <p className="text-xs text-neutral-400">{helperText}</p>}
      </div>
    );
  }
);
```

### 2.3 Unified Textarea Component

**Dosya:** `apps/web-next/src/components/ui/Textarea.tsx`

```typescript
export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

export const Textarea = forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ label, error, helperText, className, ...props }, ref) => {
    return (
      <div className="space-y-1">
        {label && (
          <label className="block text-sm font-medium text-neutral-300">
            {label}
          </label>
        )}
        <textarea
          ref={ref}
          className={`w-full px-3 py-2 bg-neutral-800 border ${
            error ? 'border-red-500' : 'border-neutral-700'
          } rounded-lg text-white placeholder-neutral-500 focus:border-blue-500 focus:outline-none resize-none ${className || ''}`}
          {...props}
        />
        {error && <p className="text-xs text-red-400">{error}</p>}
        {helperText && !error && <p className="text-xs text-neutral-400">{helperText}</p>}
      </div>
    );
  }
);
```

### 2.4 React Hook Form Integration

**Install:**
```bash
pnpm add react-hook-form
```

**Example Usage:**
```typescript
import { useForm } from 'react-hook-form';
import { Input, Select } from '@/components/ui';

function CreateStrategyForm() {
  const { register, handleSubmit, formState: { errors } } = useForm();
  
  const onSubmit = async (data) => {
    // API call
  };
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Input
        label="Strategy Name"
        error={errors.name?.message}
        {...register('name', { required: 'Name is required' })}
      />
      <Select
        label="Symbol"
        options={[
          { value: 'BTCUSDT', label: 'BTCUSDT' },
          { value: 'ETHUSDT', label: 'ETHUSDT' }
        ]}
        {...register('symbol')}
      />
      <button type="submit">Create</button>
    </form>
  );
}
```

### 2.5 Migration Plan

**Phase 1 (P6):**
- [ ] Create Input, Select, Textarea components
- [ ] Integrate React Hook Form
- [ ] Migrate: Strategies page, AI Optimizer, Strategy Editor

**Phase 2 (P7):**
- [ ] Migrate: Backtest Lab, Strategy Lab, Settings

### 2.6 Acceptance Criteria

- [ ] Input, Select, Textarea components oluşturuldu
- [ ] React Hook Form entegre edildi
- [ ] Strategies page form migration tamamlandı
- [ ] TypeCheck PASS
- [ ] Test coverage: Input, Select, Textarea unit tests

---

## 3. AUDIT LOG VIEWER

### 3.1 Backend API

```typescript
GET /api/audit/list?limit=50&offset=0&filter[user]=...&filter[action]=...
POST /api/audit/push (internal - log creation)
```

### 3.2 New Page

**Dosya:** `apps/web-next/src/app/audit/page.tsx`

```typescript
"use client";
import { useState, useEffect } from 'react';

export default function AuditLogPage() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState({ user: '', action: '' });
  
  async function loadLogs() {
    setLoading(true);
    try {
      const q = new URLSearchParams({ limit: '50', offset: '0', ...filters });
      const r = await fetch(`/api/audit/list?${q.toString()}`);
      const j = await r.json();
      setLogs(j.items || []);
    } finally {
      setLoading(false);
    }
  }
  
  useEffect(() => { loadLogs(); }, [filters]);
  
  return (
    <div className="p-6 space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold">📜 Audit Log</h1>
          <p className="text-sm opacity-70">Sistem aktivitesi ve kullanıcı işlemleri</p>
        </div>
        <button onClick={loadLogs} disabled={loading} className="px-3 py-2 rounded-lg border border-neutral-700 hover:bg-neutral-800">
          {loading ? '⏳' : '↻'} Yenile
        </button>
      </div>
      
      {/* Filters */}
      <div className="flex gap-2">
        <Input
          placeholder="User filter"
          value={filters.user}
          onChange={e => setFilters(f => ({ ...f, user: e.target.value }))}
        />
        <Select
          options={[
            { value: '', label: 'All actions' },
            { value: 'create', label: 'Create' },
            { value: 'update', label: 'Update' },
            { value: 'delete', label: 'Delete' }
          ]}
          value={filters.action}
          onChange={e => setFilters(f => ({ ...f, action: e.target.value }))}
        />
      </div>
      
      {/* Table */}
      <div className="overflow-x-auto border border-neutral-800 rounded-xl">
        <table className="w-full text-sm">
          <thead className="text-left text-neutral-300 bg-neutral-900/50">
            <tr className="border-b border-neutral-800">
              <th className="py-3 px-4">Timestamp</th>
              <th className="py-3 px-4">User</th>
              <th className="py-3 px-4">Action</th>
              <th className="py-3 px-4">Resource</th>
              <th className="py-3 px-4">Details</th>
            </tr>
          </thead>
          <tbody>
            {logs.map((log, i) => (
              <tr key={i} className="border-b border-neutral-900 hover:bg-neutral-900/30">
                <td className="py-3 px-4 text-xs">{new Date(log.ts).toLocaleString('tr-TR')}</td>
                <td className="py-3 px-4">{log.user || '-'}</td>
                <td className="py-3 px-4">
                  <span className={`px-2 py-1 rounded text-xs ${
                    log.action === 'create' ? 'bg-green-900/30 text-green-400' :
                    log.action === 'delete' ? 'bg-red-900/30 text-red-400' :
                    'bg-neutral-800 text-neutral-300'
                  }`}>{log.action}</span>
                </td>
                <td className="py-3 px-4">{log.resource}</td>
                <td className="py-3 px-4 text-xs opacity-70">{log.details || '-'}</td>
              </tr>
            ))}
            {logs.length === 0 && (
              <tr>
                <td colSpan={5} className="py-12 text-center opacity-60">
                  Henüz audit log kaydı yok
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
      
      {/* Pagination (future) */}
      {/* <Pagination total={totalCount} current={page} onChange={setPage} /> */}
    </div>
  );
}
```

### 3.3 Component Structure

```
apps/web-next/src/
├── app/audit/
│   ├── page.tsx (main page)
│   ├── loading.tsx (skeleton)
│   └── error.tsx (error boundary)
├── components/audit/
│   ├── AuditTable.tsx (table component)
│   ├── AuditFilters.tsx (filter controls)
│   └── AuditTimeline.tsx (alternative view - bonus)
└── hooks/
    └── useAuditLogs.ts (API integration)
```

### 3.4 Acceptance Criteria

- [ ] `/audit` sayfası oluşturuldu
- [ ] `/api/audit/list` entegre edildi
- [ ] Filtreleme çalışıyor (user, action)
- [ ] Loading/error states handled
- [ ] Mobile responsive
- [ ] TypeCheck PASS
- [ ] i18n keys added

---

## 4. BONUS TASKS (Time Allowing)

### 4.1 AI Optimizer - UI Polish

**Mevcut:** `apps/web-next/src/app/ai-optimizer/page.tsx`

**İyileştirmeler:**
- [ ] Parameter grid (range sliders)
- [ ] Result visualization (line chart - best params over iterations)
- [ ] AppShell integration (şu an yok)
- [ ] Better loading state (progress bar)
- [ ] Multi-objective optimization support (sharpe + max DD)

### 4.2 Strategy Editor - Syntax Highlighting

**Mevcut:** Plain textarea

**Hedef:** Monaco Editor integration

```bash
pnpm add @monaco-editor/react
```

```typescript
import Editor from '@monaco-editor/react';

function StrategyEditor() {
  const [code, setCode] = useState('...');
  
  return (
    <Editor
      height="400px"
      defaultLanguage="javascript"
      theme="vs-dark"
      value={code}
      onChange={(value) => setCode(value || '')}
      options={{
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
      }}
    />
  );
}
```

---

## 5. IMPLEMENTATION WORKFLOW

### Day 1-2: Component Library

1. Create Input, Select, Textarea components
2. Install React Hook Form
3. Write unit tests for components
4. Update component exports (`src/components/ui/index.ts`)

### Day 3-5: Strategies Page

1. Create `useStrategies` hook
2. Implement StrategyList component
3. Implement CreateStrategyModal
4. Implement StrategyDetailPanel
5. Implement StrategyControls
6. Integrate StatusBadge
7. Mobile responsive polish
8. i18n keys (TR/EN)

### Day 6-7: Audit Log

1. Create `/audit` page structure
2. Implement `useAuditLogs` hook
3. Implement AuditTable component
4. Implement AuditFilters component
5. Mobile responsive
6. i18n keys

### Day 8 (Optional): Bonus Tasks

1. AI Optimizer UI polish
2. Strategy Editor Monaco integration

---

## 6. TESTING STRATEGY

### Unit Tests

```typescript
// Input.test.tsx
import { render, screen } from '@testing-library/react';
import { Input } from './Input';

describe('Input', () => {
  test('renders with label', () => {
    render(<Input label="Test Label" />);
    expect(screen.getByText('Test Label')).toBeInTheDocument();
  });
  
  test('shows error message', () => {
    render(<Input error="Error message" />);
    expect(screen.getByText('Error message')).toBeInTheDocument();
  });
  
  // ... more tests
});
```

### Integration Tests

```typescript
// CreateStrategyModal.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import CreateStrategyModal from './CreateStrategyModal';

describe('CreateStrategyModal', () => {
  test('creates strategy with valid inputs', async () => {
    const onSubmit = jest.fn();
    render(<CreateStrategyModal onSubmit={onSubmit} />);
    
    fireEvent.change(screen.getByLabelText('Strategy Name'), {
      target: { value: 'Test Strategy' }
    });
    
    fireEvent.click(screen.getByText('Create'));
    
    expect(onSubmit).toHaveBeenCalledWith(
      expect.objectContaining({ name: 'Test Strategy' })
    );
  });
  
  // ... more tests
});
```

---

## 7. i18n KEYS

### New Keys (TR)

```json
{
  "strategies": {
    "title": "Stratejilerim",
    "subtitle": "Tüm stratejilerinizi görüntüleyin ve yönetin",
    "create": "Yeni Strateji",
    "delete_confirm": "Bu stratejiyi silmek istediğinizden emin misiniz?",
    "detail": "Detay",
    "performance": "Performans",
    "status": {
      "draft": "Taslak",
      "active": "Aktif",
      "paused": "Duraklatıldı",
      "stopped": "Durduruldu"
    },
    "actions": {
      "start": "Başlat",
      "stop": "Durdur",
      "pause": "Duraklat",
      "backtest": "Backtest",
      "optimize": "Optimize Et",
      "delete": "Sil"
    }
  },
  "audit": {
    "title": "Audit Log",
    "subtitle": "Sistem aktivitesi ve kullanıcı işlemleri",
    "filters": {
      "user": "Kullanıcı filtresi",
      "action": "İşlem filtresi"
    },
    "actions": {
      "create": "Oluşturma",
      "update": "Güncelleme",
      "delete": "Silme"
    }
  }
}
```

---

## 8. CI/CD GATES

### Pre-commit

```bash
pnpm --filter web-next typecheck
pnpm --filter web-next test
pnpm --filter web-next run i18n:check
```

### PR Gates (Blocker)

- [ ] TypeCheck = 0 errors
- [ ] Jest tests PASS
- [ ] i18n parity OK
- [ ] Build succeeds

---

## 9. ROLLBACK PLAN

### Before Starting

```bash
git checkout -b feature/v1.3-p6-core-completions
```

### Component Isolation

- Yeni componentler ayrı dosyalarda → kolay rollback
- Existing pages migration → incremental (sayfa sayfa)

### Feature Flags (optional)

```typescript
const FEATURE_NEW_STRATEGIES = process.env.NEXT_PUBLIC_FEATURE_NEW_STRATEGIES === 'true';

if (FEATURE_NEW_STRATEGIES) {
  return <NewStrategiesPage />;
} else {
  return <OldStrategiesPage />;
}
```

---

## 10. SUCCESS CRITERIA

### Must Have

- [ ] Strategies page - gerçek veri, CRUD çalışıyor
- [ ] Component library (Input, Select, Textarea) oluşturuldu
- [ ] Audit log viewer çalışıyor
- [ ] TypeCheck PASS
- [ ] i18n parity OK
- [ ] Mobile responsive (all 3 features)

### Nice to Have

- [ ] AI Optimizer UI polish
- [ ] Strategy Editor Monaco integration
- [ ] Component unit tests (>80% coverage for new components)
- [ ] E2E test (Playwright - Strategies CRUD flow)

---

## 11. NEXT SPRINT (P7)

After P6 completes:

1. **Copilot Enhancement** (chat panel, history)
2. **AI Optimizer Advanced** (multi-objective, grid visualization)
3. **ML Dashboard** (model health, signal scoring)

---

## 12. RESOURCES

### Documentation

- [React Hook Form Docs](https://react-hook-form.com/)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Next.js 14](https://nextjs.org/docs)
- [Monaco Editor](https://microsoft.github.io/monaco-editor/)

### Design Reference

- Current Dashboard (`/dashboard`) - layout pattern
- Current Alerts (`/alerts`) - table pattern
- Current Settings (`/settings`) - form pattern

---

**Sonraki Doküman:** `V1.3-P6_COMMIT.md` (implementation tamamlandığında)

