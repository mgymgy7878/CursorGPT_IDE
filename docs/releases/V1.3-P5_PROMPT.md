# V1.3-P5 • StatusBadge Migration + Health Wiring + WS Cleanup

**Cursor Prompt (Kopyala-Yapıştır)**

---

mehmet:

chatgpt:
# V1.3-P5 • StatusBadge Migration + Health Wiring + WS Cleanup
# FORMAT: PATCH → SMOKE TEST → SUMMARY (tek çıktı)

PATCH:

1) SLOChip migration (display → StatusBadge)
   - Dosya: apps/web-next/src/components/common/SLOChip.tsx
   - Mantık korunur; sadece durum gösterimi:
     overall → map: { ok:'success', warning:'warn', offline:'error', unknown:'neutral' }
     <StatusBadge status={mapped} label={t(`status.${mapped}`)} />

2) Canary/Health wiring
   - Dosya(lar): apps/web-next/src/components/dashboard/CanaryCard.tsx, HealthSummary.tsx (veya mevcut karşılıklar)
   - Kullan:
     import { getHealthStatus } from "@/lib/health";
     const s = getHealthStatus(metrics);
     <StatusBadge status={s} label={t(`status.${s}`)} />

3) WS cleanup (exponential backoff + log throttle)
   - Dosya: apps/web-next/src/app/api/marketdata/stream/route.ts
   - Backoff (base=500ms, max=15000ms, factor=2, jitter=true), log throttle 2000ms
   - TS hatalarını suppress etmeden tiplerle düzelt.

SMOKE TEST:
- Komutlar:
  pnpm --filter web-next typecheck
  pnpm --filter web-next test
  pnpm --filter web-next run i18n:check
  pnpm --filter web-next build || true
  pnpm --filter web-next dev --port 3003

- Doğrula:
  /dashboard → SLOChip artık StatusBadge (renkler metriklere göre)
  /dashboard → Canary/Health kartlarında StatusBadge
  WS loglarında reconnect uyarıları önceye göre azaldı (≈%50↓)
  TR↔EN parity yine OK, 1024–1440 px + Dark/Light stabil

SUMMARY (tek blok):
- Başlık: V1.3-P5 • StatusBadge Migration + Health Wiring + WS Cleanup
- Durum: GREEN/AMBER/RED
- Komutlar, değişen dosyalar, test/build çıktıları
- Hatalar/Uyarılar
- Sonraki adımlar (max 3 madde)

---

## Definition of Done

- [ ] Migration coverage: Eski chip/badge kullanım sayısı 0 (grep ile doğrulanmış)
- [ ] Health wiring: Canary & Health kartları getHealthStatus() + StatusBadge ile canlı renkleniyor
- [ ] WS stabilite: Reconnect uyarıları %50↓, TS hatası 0
- [ ] Kontroller: typecheck=0, i18n parity OK, build PASS

## Kabul Kriterleri

| Kriter | Hedef | Ölçüm |
|--------|-------|-------|
| Eski chip/badge | 0 kullanım | `rg -n "class.*bg-(green\|red\|yellow)-9" --type tsx` |
| StatusBadge kullanımı | 10+ yer | `rg -n "StatusBadge" --type tsx` |
| Health tests | 13+ PASS | `pnpm test health` |
| WS log azalma | %50↓ | Dev console count |
| TypeCheck | 0 error | `pnpm typecheck` |

## Risk & Rollback

| Risk | Etki | Azaltma |
|------|------|---------|
| SLOChip display bozulması | Orta | Metrik logic ayrıştır, test kapsamı |
| WS backoff çok agresif | Düşük | Parametreler ayarlanabilir |
| Health eşik yanlış | Yüksek | Test suite + manuel QA |

