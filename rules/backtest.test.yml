groups:
- name: backtest.rules
  rules:
  - alert: BacktestRuntimeP95High
    expr: histogram_quantile(0.95, sum by (le) (rate(backtest_runtime_ms_bucket[10m]))) > 4000
    for: 10m
    labels: {severity: warning}
    annotations: {summary: "Backtest runtime P95 > 4s (10m)"}

  - alert: BacktestQueueWaitHigh
    expr: histogram_quantile(0.95, sum by (le) (rate(backtest_queue_wait_ms_bucket[10m]))) > 800
    for: 10m
    labels: {severity: warning}
    annotations: {summary: "Queue wait P95 > 800ms (10m)"}

  - alert: BacktestDeterminismBroken
    expr: increase(backtest_golden_diff_fail_total[30m]) > 0
    for: 0m
    labels: {severity: critical}
    annotations: {summary: "Golden diff failure detected"}
