name: Canary Smoke v1.11.3

on:
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: canary-smoke
  cancel-in-progress: true

jobs:
  canary-smoke:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Metrics Warmup (dynamic)
        shell: pwsh
        run: |
          $ok=$false; for($i=0;$i -lt 5 -and -not $ok;$i++){
            try{
              $r=Invoke-WebRequest -UseBasicParsing http://127.0.0.1:4001/metrics -TimeoutSec 5
              if($r.StatusCode -eq 200){ $ok=$true } else { Start-Sleep -Seconds 1 }
            } catch { Start-Sleep -Seconds 1 }
          }
          if(-not $ok){ Write-Host "Warmup did not confirm 200 after 5 tries (continuing)" }

      - name: Install Dependencies
        shell: pwsh
        run: |
          pnpm -v
          pnpm -w install --frozen-lockfile
      
      - name: Run Canary Smoke
        id: smoke
        shell: pwsh
        env:
          SMOKE_TOKEN: ${{ secrets.SMOKE_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"
          Write-Output "::group::Canary Smoke Execution"
          try {
            powershell -ExecutionPolicy Bypass -File scripts/canary-smoke-v1.11.2.ps1
            Write-Output "::endgroup::"
            Write-Output "âœ… Canary smoke PASS"
          } catch {
            Write-Output "::endgroup::"
            Write-Output "::error title=Canary Smoke Failed::$($_.Exception.Message)"
            exit 1
          }

      - name: Upload Smoke Evidence
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.smoke.outputs.artifact_name }}
          path: evidence/local/smoke/smoke_*/
          retention-days: 14
