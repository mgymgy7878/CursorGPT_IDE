name: PR Smoke

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch:

jobs:
  pr-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths (docs vs code)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            docs:
              - 'docs/**'
              - 'README.md'
              - '.github/workflows/**'
            code:
              - 'apps/**'
              - 'services/**'
              - 'packages/**'
              - 'tools/**'

      - name: Setup Node & pnpm (corepack)
        if: steps.changes.outputs.code == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack & pin pnpm
        if: steps.changes.outputs.code == 'true'
        run: |
          set -e
          corepack enable
          corepack prepare pnpm@10.18.3 --activate
          pnpm -v && which pnpm || command -v pnpm

      - name: Print workspace info
        if: steps.changes.outputs.code == 'true'
        run: |
          echo "=== Environment ==="
          node -v
          pnpm -v
          echo "PNPM_HOME=$PNPM_HOME"
          echo "Store: $(pnpm store path || echo 'N/A')"
          echo "================"

      - name: Install deps (force, verbose)
        if: steps.changes.outputs.code == 'true'
        run: |
          set -euxo pipefail
          test -f pnpm-lock.yaml || (echo '⚠️ pnpm-lock.yaml kökte yok' && ls -la)
          echo "Starting workspace install..."
          pnpm -w install --frozen-lockfile --reporter=ndjson || pnpm -w install --reporter=ndjson
          echo "Starting web-next install..."
          pnpm --filter web-next install --reporter=ndjson || true
          echo "✓ Install completed"
          pnpm -w list --depth 1 | head -200 || true

      - name: Verify critical deps
        if: steps.changes.outputs.code == 'true'
        run: |
          set -e
          echo "Verifying critical dependencies..."
          pnpm --filter web-next exec node -e "require.resolve('react-hook-form')" || (echo "react-hook-form NOT FOUND" && exit 1)
          pnpm --filter web-next exec node -e "require.resolve('swr')" || (echo "swr NOT FOUND" && exit 1)
          echo "✓ All critical deps verified"

      - name: Build web-next (standalone)
        if: steps.changes.outputs.code == 'true'
        run: |
          set -e
          echo "[pr-smoke] Building web-next (standalone mode)"
          echo "[pr-smoke] Command: pnpm --filter web-next build"
          pnpm --filter web-next build 2>&1 | tee build.log
          echo "[pr-smoke] Build completed. Checking for copy-standalone-assets markers..."
          if grep -q "\[copy-standalone-assets\] START" build.log; then
            echo "✅ [copy-standalone-assets] START marker found in build log"
          else
            echo "⚠️  [copy-standalone-assets] START marker NOT found in build log"
            echo "   This may indicate the postbuild script did not run"
          fi
          if grep -q "\[copy-standalone-assets\] styled-jsx OK" build.log; then
            echo "✅ [copy-standalone-assets] styled-jsx OK marker found in build log"
          else
            echo "⚠️  [copy-standalone-assets] styled-jsx OK marker NOT found in build log"
            echo "   This may indicate styled-jsx copy failed"
          fi
        env:
          NODE_ENV: production

      - name: Docs-only smoke (skip build)
        if: steps.changes.outputs.docs == 'true' && steps.changes.outputs.code != 'true'
        run: |
          echo '✅ Docs-only değişim tespit edildi; build/typecheck atlandı.'

      - name: Verify build output exists
        if: steps.changes.outputs.code == 'true'
        run: |
          echo "[pr-smoke] Checking standalone server.js locations..."
          if [ -f "apps/web-next/.next/standalone/apps/web-next/server.js" ]; then
            echo "✅ Standalone server.js found (nested): apps/web-next/.next/standalone/apps/web-next/server.js"
            ls -la apps/web-next/.next/standalone/apps/web-next/ | head -10
          elif [ -f "apps/web-next/.next/standalone/server.js" ]; then
            echo "✅ Standalone server.js found (root): apps/web-next/.next/standalone/server.js"
            ls -la apps/web-next/.next/standalone/ | head -10
          else
            echo "⚠️  No standalone server.js found, will rely on next start"
            echo "Checking standalone structure:"
            find apps/web-next/.next/standalone -name "server.js" 2>/dev/null || echo "No server.js found"
          fi

      - name: Assert styled-jsx in standalone (fail-fast)
        if: steps.changes.outputs.code == 'true'
        run: |
          set -e
          echo "[pr-smoke] Assert styled-jsx in standalone (fail-fast)"
          echo "[pr-smoke] Current working directory: $(pwd)"

          # Try both paths: repo-root and app-cwd
          PATH_REPO_ROOT="apps/web-next/.next/standalone/node_modules/styled-jsx/package.json"
          PATH_APP_CWD=".next/standalone/node_modules/styled-jsx/package.json"

          FOUND_PATH=""
          if [ -f "$PATH_REPO_ROOT" ]; then
            FOUND_PATH="$PATH_REPO_ROOT"
            echo "✅ styled-jsx found (repo-root path): $FOUND_PATH"
          elif [ -f "$PATH_APP_CWD" ]; then
            FOUND_PATH="$PATH_APP_CWD"
            echo "✅ styled-jsx found (app-cwd path): $FOUND_PATH"
          fi

          if [ -n "$FOUND_PATH" ]; then
            echo "[pr-smoke] styled-jsx package.json content (first 5 lines):"
            head -5 "$FOUND_PATH" || true
            echo "[pr-smoke] styled-jsx directory listing:"
            if [ "$FOUND_PATH" = "$PATH_REPO_ROOT" ]; then
              ls -la apps/web-next/.next/standalone/node_modules/styled-jsx/ | head -10
            else
              ls -la .next/standalone/node_modules/styled-jsx/ | head -10
            fi
          else
            echo "❌ styled-jsx NOT found in standalone"
            echo "[pr-smoke] Tried paths:"
            echo "  - Repo-root: $PATH_REPO_ROOT (exists: $([ -f "$PATH_REPO_ROOT" ] && echo 'YES' || echo 'NO'))"
            echo "  - App-cwd: $PATH_APP_CWD (exists: $([ -f "$PATH_APP_CWD" ] && echo 'YES' || echo 'NO'))"
            echo "[pr-smoke] Current directory structure:"
            echo "  - pwd: $(pwd)"
            echo "  - apps/web-next exists: $([ -d "apps/web-next" ] && echo 'YES' || echo 'NO')"
            echo "  - .next exists: $([ -d ".next" ] && echo 'YES' || echo 'NO')"
            echo "[pr-smoke] Checking standalone structure:"
            if [ -d "apps/web-next/.next/standalone" ]; then
              echo "Standalone root (repo-root):"
              ls -la apps/web-next/.next/standalone/ | head -20 || true
              echo "Standalone node_modules (repo-root):"
              ls -la apps/web-next/.next/standalone/node_modules/ 2>/dev/null | head -20 || echo "node_modules not found"
            elif [ -d ".next/standalone" ]; then
              echo "Standalone root (app-cwd):"
              ls -la .next/standalone/ | head -20 || true
              echo "Standalone node_modules (app-cwd):"
              ls -la .next/standalone/node_modules/ 2>/dev/null | head -20 || echo "node_modules not found"
            else
              echo "Standalone directory not found in either location"
            fi
            echo "[pr-smoke] Build log should contain '[copy-standalone-assets] START' and '[copy-standalone-assets] styled-jsx OK' markers"
            exit 1
          fi

      - name: Isolate standalone to temp (prevent ancestor node_modules leakage)
        if: steps.changes.outputs.code == 'true'
        shell: bash
        run: |
          set -euo pipefail
          SOURCE="${GITHUB_WORKSPACE}/apps/web-next/.next/standalone"
          TARGET="${RUNNER_TEMP}/standalone-web-next"

          echo "[pr-smoke] Isolating standalone to temp directory (prevents pnpm-store next selection)"
          echo "[pr-smoke] Source: $SOURCE"
          echo "[pr-smoke] Target: $TARGET"

          # Clean target
          rm -rf "$TARGET"
          mkdir -p "$TARGET"

          # Copy standalone server tree with symlink dereference (prevents broken symlinks in temp)
          # Use rsync -aL (dereference symlinks) if available, fallback to cp -aL
          echo "[pr-smoke] Copying standalone tree (dereferencing symlinks)..."
          if command -v rsync >/dev/null 2>&1; then
            # rsync -aL: -a = archive mode, -L = dereference symlinks
            rsync -aL "$SOURCE/" "$TARGET/"
          else
            # cp -aL: -a = archive mode, -L = dereference symlinks (GNU cp)
            cp -aL "$SOURCE/." "$TARGET/"
          fi

          # Find server.js in isolated standalone first
          SERVER_JS="$(find "$TARGET" -type f -name server.js | head -n 1)"
          if [ -z "$SERVER_JS" ]; then
            echo "❌ server.js not found in isolated standalone"
            exit 1
          fi

          SERVER_DIR="$(dirname "$SERVER_JS")"
          APP_ROOT="$SERVER_DIR"
          echo "[pr-smoke] Found server.js at: $SERVER_JS"
          echo "[pr-smoke] App root (server.js directory): $APP_ROOT"
          
          # Copy .next/static and public to app root (next to server.js)
          # This works for both old structure ($TARGET/server.js) and nested structure ($TARGET/apps/web-next/server.js)
          if [ -d "${GITHUB_WORKSPACE}/apps/web-next/.next/static" ]; then
            mkdir -p "$APP_ROOT/.next"
            echo "[pr-smoke] Copying .next/static to app root (dereferencing symlinks)..."
            if command -v rsync >/dev/null 2>&1; then
              rsync -aL "${GITHUB_WORKSPACE}/apps/web-next/.next/static/" "$APP_ROOT/.next/static/" || true
            else
              cp -aL "${GITHUB_WORKSPACE}/apps/web-next/.next/static" "$APP_ROOT/.next/static" || true
            fi
          fi
          
          if [ -d "${GITHUB_WORKSPACE}/apps/web-next/public" ]; then
            echo "[pr-smoke] Copying public to app root (dereferencing symlinks)..."
            if command -v rsync >/dev/null 2>&1; then
              rsync -aL "${GITHUB_WORKSPACE}/apps/web-next/public/" "$APP_ROOT/public/" || true
            else
              cp -aL "${GITHUB_WORKSPACE}/apps/web-next/public" "$APP_ROOT/public" || true
            fi
          fi

          echo "ISOLATED_SERVER_JS=$SERVER_JS" >> "$GITHUB_ENV"
          echo "ISOLATED_SERVER_DIR=$SERVER_DIR" >> "$GITHUB_ENV"
          echo "ISOLATED_STANDALONE_ROOT=$TARGET" >> "$GITHUB_ENV"

          # Build NODE_PATH from isolated standalone (no ancestor node_modules)
          NODE_PATH_VAL="$TARGET/node_modules"
          if [ -d "$TARGET/apps/web-next/node_modules" ]; then
            NODE_PATH_VAL="$NODE_PATH_VAL:$TARGET/apps/web-next/node_modules"
          fi
          echo "NODE_PATH=$NODE_PATH_VAL" >> "$GITHUB_ENV"

          echo "✅ Isolated standalone ready"
          echo "✅ SERVER_JS=$SERVER_JS"
          echo "✅ SERVER_DIR=$SERVER_DIR"
          echo "✅ NODE_PATH=$NODE_PATH_VAL"

      - name: Start standalone server (with runtime preflight)
        if: steps.changes.outputs.code == 'true'
        shell: bash
        working-directory: ${{ env.ISOLATED_SERVER_DIR }}
        env:
          PORT: "3003"
          HOSTNAME: "127.0.0.1"
          NODE_ENV: "production"
          NODE_PATH: ${{ env.NODE_PATH }}
        run: |
          set -euo pipefail
          echo "[pr-smoke] Starting standalone server from isolated temp directory"
          echo "[pr-smoke] Working directory: $(pwd)"
          echo "[pr-smoke] NODE_PATH=$NODE_PATH"

          # Runtime preflight: verify module resolution in isolated environment
          echo "[pr-smoke] Runtime preflight: checking module resolution..."
          node -e "console.log('NODE_PATH=',process.env.NODE_PATH); console.log('globalPaths=',require('module').globalPaths)"

          # Critical: Check which next instance is being loaded
          # Good: .../.next/standalone/.../node_modules/next/package.json
          # Bad: .../apps/web-next/node_modules/.pnpm/next@.../node_modules/next/package.json
          echo "[pr-smoke] Checking which next instance is loaded..."
          node -e "console.log('next=', require.resolve('next/package.json'))" || {
            echo "❌ next resolution failed"
            exit 1
          }

          # Verify styled-jsx resolution under require-hook
          node -e "require('next/dist/server/require-hook'); console.log('✅ styled-jsx resolved:', require.resolve('styled-jsx/package.json'))" || {
            echo "❌ styled-jsx resolution failed under require-hook (runtime preflight)"
            echo "[pr-smoke] Checking node_modules structure:"
            ls -la node_modules/ 2>/dev/null | head -20 || echo "node_modules not found in server dir"
            exit 1
          }

          # Start server (same step, same environment, isolated from repo)
          LOG_PATH="${GITHUB_WORKSPACE}/pr-smoke-server.log"
          # NODE_DEBUG=module is verbose; only enable if needed for debugging
          # For now, keep it off to reduce log size
          nohup node server.js > "$LOG_PATH" 2>&1 &
          echo "[pr-smoke] Server started in background (PID: $!)"
          echo "[pr-smoke] Server log: $LOG_PATH"
          echo "[pr-smoke] Server should be listening on http://127.0.0.1:3003"

      - name: Wait for health (bash, 120s)
        if: steps.changes.outputs.code == 'true'
        run: |
          set -e
          URL="http://127.0.0.1:3003/api/health"
          for i in $(seq 1 120); do
            if curl -fsS "$URL" >/dev/null 2>&1; then
              echo "Health is up on attempt $i ✅"
              exit 0
            fi
            sleep 1
          done
          echo "Health endpoint did not respond in 120s ❌"
          echo "---- pr-smoke-server.log (tail, last 400 lines) ----"
          tail -n 400 pr-smoke-server.log || true

          # If styled-jsx error detected, enable NODE_DEBUG and retry once
          if grep -q "styled-jsx" pr-smoke-server.log 2>/dev/null; then
            echo "---- styled-jsx error detected, enabling NODE_DEBUG and retrying ----"
            echo "---- styled-jsx path verification ----"
            if [ -n "${{ env.ISOLATED_STANDALONE_ROOT }}" ]; then
              ls -la "${{ env.ISOLATED_STANDALONE_ROOT }}/node_modules/styled-jsx" 2>/dev/null || echo "styled-jsx not found in isolated standalone root"
              if [ -d "${{ env.ISOLATED_STANDALONE_ROOT }}/apps/web-next/node_modules" ]; then
                ls -la "${{ env.ISOLATED_STANDALONE_ROOT }}/apps/web-next/node_modules/styled-jsx" 2>/dev/null || echo "styled-jsx not found in nested isolated standalone"
              fi
            fi

            # Kill existing server and restart with NODE_DEBUG
            pkill -f "node server.js" || true
            sleep 2
            cd "${{ env.ISOLATED_SERVER_DIR }}"
            PORT=3003 HOSTNAME=127.0.0.1 NODE_ENV=production NODE_PATH="${{ env.NODE_PATH }}" NODE_DEBUG=module nohup node server.js > "${GITHUB_WORKSPACE}/pr-smoke-server-debug.log" 2>&1 &
            echo "Server restarted with NODE_DEBUG=module (PID: $!)"
            echo "Waiting 10s for server to start..."
            sleep 10
            echo "---- pr-smoke-server-debug.log (tail, last 200 lines) ----"
            tail -n 200 "${GITHUB_WORKSPACE}/pr-smoke-server-debug.log" || true
          fi
          exit 1

      - name: Extra health poll (curl)
        if: steps.changes.outputs.code == 'true'
        run: |
          for i in $(seq 1 10); do
            if curl -fsS http://127.0.0.1:3003/api/health >/dev/null; then exit 0; fi
            sleep 2
          done
          echo "Extra health poll failed ❌"; exit 1

      - name: Curl health
        if: steps.changes.outputs.code == 'true'
        run: |
          curl -fsS -D - http://127.0.0.1:3003/api/health -o health.json
          cat health.json

      - name: Curl metrics (JSON)
        if: steps.changes.outputs.code == 'true'
        run: |
          curl -fsS -D - http://127.0.0.1:3003/api/public/metrics -o metrics.json
          cat metrics.json

      - name: Curl metrics (Prometheus)
        if: steps.changes.outputs.code == 'true'
        run: |
          curl -fsS -D headers.txt http://127.0.0.1:3003/api/public/metrics.prom -o metrics.prom
          cat headers.txt
          grep -E "^content-type:\s*text/plain;\s*version=0\.0\.4" -i headers.txt

      - name: Upload debug artefacts on failure
        if: failure() && steps.changes.outputs.code == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-smoke-debug
          if-no-files-found: warn
          path: |
            pr-smoke-server.log
            apps/web-next/.next/**
            pnpm-lock.yaml
            pnpm-workspace.yaml
            **/package.json
            **/tsconfig.json
            **/next.config.*
            apps/web-next/logs/**
          retention-days: 1

      - name: Upload artifacts
        if: steps.changes.outputs.code == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-smoke-artifacts
          path: |
            pr-smoke-server.log
            apps/web-next/.next/**/*
            health.json
            metrics.json
            metrics.prom
            headers.txt
