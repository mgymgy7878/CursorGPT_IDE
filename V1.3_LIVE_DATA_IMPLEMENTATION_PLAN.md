# SPARK V1.3 - LIVE DATA IMPLEMENTATION PLAN

**Version:** v1.3.0  
**Start:** 2025-01-18  
**Target:** 2025-01-25  
**Status:** 📋 PLANNED

---

## 🎯 Objectives

1. **BTCTurk WebSocket Integration** - Real-time ticker/orderbook
2. **BIST Feed Polling** - Market data from BIST
3. **Live UI Updates** - MarketCard with real data
4. **Performance Optimized** - RAF throttling, no unnecessary renders
5. **Ops Dashboard** - Quick metrics in UI

---

## 🏗️ Architecture Decisions

### Store: Zustand
**Why:** Lightweight, TypeScript-friendly, no boilerplate

```typescript
// src/stores/marketStore.ts
import { create } from 'zustand';

interface Ticker {
  symbol: string;
  price: number;
  change24h: number;
  volume24h: number;
  updatedAt: number;
}

interface MarketState {
  tickers: Record<string, Ticker>;
  setTicker: (symbol: string, data: Ticker) => void;
  staleness: (symbol: string) => 'ok' | 'warn' | 'stale';
}

export const useMarketStore = create<MarketState>((set, get) => ({
  tickers: {},
  
  setTicker: (symbol, data) =>
    set((state) => ({
      tickers: { ...state.tickers, [symbol]: data },
    })),
  
  staleness: (symbol) => {
    const ticker = get().tickers[symbol];
    if (!ticker) return 'stale';
    
    const age = Date.now() - ticker.updatedAt;
    if (age < 10000) return 'ok';      // < 10s: OK
    if (age < 30000) return 'warn';    // 10-30s: WARN
    return 'stale';                    // > 30s: STALE
  },
}));
```

### Update Model: RAF Throttling
**Why:** Prevent excessive renders (16-24 Hz max)

```typescript
// src/lib/ws/throttle.ts
let rafId: number | null = null;
let pending: Map<string, any> = new Map();

export function scheduleUpdate(symbol: string, data: any, callback: (updates: Map<string, any>) => void) {
  pending.set(symbol, data);
  
  if (rafId === null) {
    rafId = requestAnimationFrame(() => {
      callback(new Map(pending));
      pending.clear();
      rafId = null;
    });
  }
}
```

### Staleness/TTL
**Implementation:**
```typescript
// MarketCard component
const ticker = useMarketStore(s => s.tickers[symbol]);
const staleness = useMarketStore(s => s.staleness(symbol));

const stalenessColor = {
  ok: 'text-green-400',
  warn: 'text-amber-400',
  stale: 'text-red-400',
}[staleness];
```

---

## 📦 Implementation Steps

### Step 1: Zustand Store (30 min)
**Files:**
- `src/stores/marketStore.ts` - Market data store
- `src/stores/opsStore.ts` - Health/metrics store

**Tasks:**
1. Create store with ticker interface
2. Add setTicker action
3. Add staleness calculator
4. Export hooks

**Acceptance:**
- ✅ useMarketStore hook works
- ✅ TypeScript autocomplete
- ✅ No runtime errors

---

### Step 2: WS Client Integration (1 hour)
**Files:**
- `src/lib/ws/btcturk-client.ts` - WebSocket client wrapper
- `src/lib/ws/throttle.ts` - RAF throttling utility

**Tasks:**
1. Import BTCTurkWSClient from `services/marketdata/src/ws/btcturk.ts`
2. Add RAF throttle wrapper
3. Connect to marketStore.setTicker
4. Add auto-resubscribe on reconnect

**Example:**
```typescript
// src/lib/ws/btcturk-client.ts
import { BTCTurkWSClient } from '@spark/marketdata/ws/btcturk';
import { useMarketStore } from '@/stores/marketStore';
import { scheduleUpdate } from './throttle';
import { normalizeBtcturkTicker } from '@spark/marketdata-common';

let client: BTCTurkWSClient | null = null;

export function initBTCTurkWS() {
  client = new BTCTurkWSClient();
  
  client.subscribe('ticker', (data) => {
    const normalized = normalizeBtcturkTicker(data);
    
    scheduleUpdate(normalized.symbol, normalized, (updates) => {
      updates.forEach((ticker, symbol) => {
        useMarketStore.getState().setTicker(symbol, ticker);
      });
    });
  });
  
  client.connect();
  return client;
}
```

**Acceptance:**
- ✅ WS connects successfully
- ✅ Ticker updates flow to store
- ✅ RAF throttling active (max 60 FPS)
- ✅ No memory leaks

---

### Step 3: MarketCard Live Updates (45 min)
**Files:**
- `src/components/marketdata/MarketCard.tsx` - Connect to store

**Tasks:**
1. Replace mock data with useMarketStore
2. Add staleness indicator
3. Add loading/error states
4. Add last update timestamp

**Example:**
```typescript
// MarketCard.tsx
import { useMarketStore } from '@/stores/marketStore';

export function MarketCard({ symbol = 'BTCUSDT' }) {
  const ticker = useMarketStore(s => s.tickers[symbol]);
  const staleness = useMarketStore(s => s.staleness(symbol));
  
  if (!ticker) {
    return <Card>Yükleniyor...</Card>;
  }
  
  const stalenessColor = {
    ok: 'bg-green-500/15 text-green-300',
    warn: 'bg-amber-500/15 text-amber-300',
    stale: 'bg-red-500/15 text-red-300',
  }[staleness];
  
  return (
    <Card>
      <div className="flex justify-between">
        <h3>{symbol}</h3>
        <span className={`px-2 py-1 text-xs rounded ${stalenessColor}`}>
          {staleness === 'ok' ? 'Canlı' : 'Gecikme'}
        </span>
      </div>
      <div className="mono tabular text-2xl">
        {formatCurrency(ticker.price, 'tr-TR', 'USD')}
      </div>
      {/* ... rest of card */}
    </Card>
  );
}
```

**Acceptance:**
- ✅ Card updates in real-time
- ✅ Staleness indicator correct
- ✅ No flickering/jank
- ✅ CPU usage < 10%

---

### Step 4: Dashboard Health Metrics (30 min)
**Files:**
- `src/app/dashboard/page.tsx` - Add mini metrics

**Tasks:**
1. Fetch `/api/healthz` from executor
2. Show in small Metric cards
3. Color code by status
4. Auto-refresh every 30s

**Example:**
```typescript
// Dashboard page
const [health, setHealth] = useState({ status: 'ok', latency: 0 });

useEffect(() => {
  const fetchHealth = async () => {
    const res = await fetch('http://127.0.0.1:4001/healthz');
    const data = await res.json();
    setHealth(data);
  };
  
  fetchHealth();
  const interval = setInterval(fetchHealth, 30000);
  return () => clearInterval(interval);
}, []);

// In JSX
<Metric 
  label="Executor Health" 
  value={health.status} 
  hint={`${health.latency}ms`}
/>
```

**Acceptance:**
- ✅ Health status visible
- ✅ Auto-refresh working
- ✅ Color coded (green/amber/red)

---

### Step 5: Command Palette Actions (30 min)
**Files:**
- `src/lib/command-palette.ts` - Add quick actions

**Tasks:**
1. Add "Uyarı Taslağı Oluştur"
2. Add "Kanıtı Aç"
3. Add "Health Check"
4. Link to existing handlers

**Example:**
```typescript
// command-palette.ts
const commands = [
  {
    id: 'create-alert-draft',
    name: 'Uyarı Taslağı Oluştur',
    icon: '🔔',
    handler: () => createAlertDraft(),
  },
  {
    id: 'open-evidence',
    name: 'Kanıtı Aç',
    icon: '📊',
    handler: () => window.open('/evidence', '_blank'),
  },
  {
    id: 'health-check',
    name: 'Health Check',
    icon: '💊',
    handler: async () => {
      const health = await fetch('/api/healthz').then(r => r.json());
      toast.info(`Health: ${health.status}`);
    },
  },
];
```

**Acceptance:**
- ✅ Commands show in palette
- ✅ Keyboard shortcuts work
- ✅ Actions execute correctly

---

## 🧪 Testing Strategy

### Mock WS Test (Performance)
```typescript
// tests/performance/ws-mock.spec.ts
import { test } from '@playwright/test';

test('WS performance - 60s random ticks', async ({ page }) => {
  await page.goto('/dashboard');
  
  // Inject mock WS
  await page.evaluate(() => {
    const mockTicker = () => ({
      symbol: 'BTCUSDT',
      price: 42000 + Math.random() * 1000,
      change24h: Math.random() * 5 - 2.5,
      volume24h: 1000000,
      updatedAt: Date.now(),
    });
    
    setInterval(() => {
      window.marketStore.setTicker('BTCUSDT', mockTicker());
    }, 100); // 10 Hz
  });
  
  // Wait 60 seconds
  await page.waitForTimeout(60000);
  
  // Check metrics
  const metrics = await page.evaluate(() => performance.getEntriesByType('measure'));
  console.log('Render count:', metrics.length);
  console.log('FPS:', metrics.length / 60);
  
  // Assert < 24 FPS (throttled)
  expect(metrics.length / 60).toBeLessThan(24);
});
```

### Visual Test (Staleness Colors)
```typescript
// tests/ui/staleness.spec.ts
test('staleness color transitions', async ({ page }) => {
  await page.goto('/dashboard');
  
  // Fresh data (< 10s)
  await expect(page.locator('.staleness-indicator')).toHaveClass(/green/);
  
  // Simulate 15s delay
  await page.evaluate(() => {
    const ticker = marketStore.getState().tickers['BTCUSDT'];
    ticker.updatedAt = Date.now() - 15000;
  });
  
  // Should be amber
  await expect(page.locator('.staleness-indicator')).toHaveClass(/amber/);
  
  // Simulate 35s delay
  await page.evaluate(() => {
    ticker.updatedAt = Date.now() - 35000;
  });
  
  // Should be red
  await expect(page.locator('.staleness-indicator')).toHaveClass(/red/);
});
```

---

## 📊 Performance Targets

### CPU Usage
- ✅ Idle: < 1%
- ✅ WS active (10 symbols): < 10%
- ✅ WS active (50 symbols): < 20%

### Memory
- ✅ Initial load: < 100 MB
- ✅ After 1 hour: < 150 MB
- ✅ No memory leaks (stable after 24h)

### Render Performance
- ✅ RAF throttled: ≤ 24 FPS
- ✅ CLS: < 0.1
- ✅ No layout thrashing

---

## 🎨 UI Integration Points

### Dashboard
```typescript
import { useMarketStore } from '@/stores/marketStore';

const btcTicker = useMarketStore(s => s.tickers['BTCUSDT']);
const ethTicker = useMarketStore(s => s.tickers['ETHUSDT']);

<MarketCard symbol="BTCUSDT" ticker={btcTicker} />
<MarketCard symbol="ETHUSDT" ticker={ethTicker} />
```

### Top Bar Status
```typescript
const wsStatus = useMarketStore(s => s.connectionStatus);

<StatusPills 
  env="Mock"
  feed={wsStatus === 'connected' ? 'Healthy' : 'Degraded'}
  broker="Offline"
/>
```

---

## 🛡️ Error Handling

### WS Disconnect
```typescript
// Auto-retry with exponential backoff (already in BTCTurkWSClient)
// UI shows: "Veri Akışı: Bozulmuş" (amber)
// Toast: "Bağlantı kesildi, yeniden deneniyor..."
```

### Stale Data
```typescript
// If updatedAt > 30s ago:
// Show amber/red indicator
// Optional: Show "X sn önce güncellendi" tooltip
```

### Network Errors
```typescript
// Graceful degradation
// Keep last known values
// Show "Son bilinen: 12:34:56" timestamp
```

---

## 🚀 Rollout Plan

### Phase 1: Mock WS (Day 1)
- ✅ Zustand store ready
- ✅ RAF throttling tested
- ✅ MarketCard connected
- ✅ Performance profiled

### Phase 2: Real BTCTurk WS (Day 2-3)
- ⬜ BTCTurkWSClient integrated
- ⬜ Ticker + Orderbook streams
- ⬜ Auto-reconnect verified
- ⬜ Staleness indicators working

### Phase 3: BIST Feed (Day 4-5)
- ⬜ Polling service (10s interval)
- ⬜ Normalize BIST → common format
- ⬜ Cache layer (Redis or in-memory)
- ⬜ UI integration

### Phase 4: Ops Dashboard (Day 6)
- ⬜ Health metrics mini-cards
- ⬜ Command palette actions
- ⬜ Quick diagnostics panel

### Phase 5: Testing & Polish (Day 7)
- ⬜ Playwright performance tests
- ⬜ Visual regression update
- ⬜ Load testing (50 symbols)
- ⬜ Documentation

---

## 📝 File Structure

```
apps/web-next/src/
  stores/
    marketStore.ts         (NEW)
    opsStore.ts            (NEW)
  
  lib/
    ws/
      btcturk-client.ts    (NEW)
      bist-poller.ts       (NEW)
      throttle.ts          (NEW)
  
  components/
    marketdata/
      MarketCard.tsx       (UPDATE - connect to store)
      LiveTicker.tsx       (NEW)
  
  app/
    dashboard/
      page.tsx             (UPDATE - add health metrics)

services/marketdata/src/
  ws/
    btcturk.ts             (EXISTING - reuse)
  
packages/marketdata-common/src/
  normalize.ts             (EXISTING - reuse)
```

---

## 🎯 Acceptance Criteria

### BTCTurk WS
- ⬜ Connection stable 24h+ without manual restart
- ⬜ Reconnect on disconnect < 5s
- ⬜ Data latency < 100ms
- ⬜ RAF throttling keeps FPS ≤ 24

### BIST Feed
- ⬜ Polling interval ≤ 10s
- ⬜ Cache hit rate > 80%
- ⬜ Data staleness < 30s
- ⬜ No blocking on main thread

### UI Performance
- ⬜ CPU usage < 10% (10 symbols)
- ⬜ Memory stable after 1 hour
- ⬜ No layout shifts (CLS < 0.1)
- ⬜ Smooth animations (60 FPS)

### Quality
- ⬜ TypeScript: 0 errors
- ⬜ Build: SUCCESS
- ⬜ All tests: PASS
- ⬜ Visual snapshots: Updated

---

## 🔧 Performance Optimizations

### RAF Coalescing
```typescript
// Batch all ticker updates in single RAF
const updates = new Map<string, Ticker>();

ws.on('ticker', (data) => {
  updates.set(data.symbol, normalize(data));
  
  if (!rafPending) {
    rafPending = true;
    requestAnimationFrame(() => {
      flushUpdates(updates);
      updates.clear();
      rafPending = false;
    });
  }
});
```

### Selective Re-renders
```typescript
// Only subscribe to specific symbol
const btcPrice = useMarketStore(s => s.tickers['BTCUSDT']?.price);
// Not: const tickers = useMarketStore(s => s.tickers); // Re-renders on ANY ticker
```

### Memoization
```typescript
// Expensive calculations
const formattedPrice = useMemo(
  () => formatCurrency(ticker.price, 'tr-TR', 'USD'),
  [ticker.price]
);
```

---

## 📋 Next Session Kickoff

**Ready to start V1.3?** Copy this command:

```bash
cd C:\dev

# Create V1.3 branch
git checkout -b feat/v1.3-live-data

# Install Zustand
cd apps/web-next
pnpm add zustand

# Create stores directory
mkdir -p src/stores
mkdir -p src/lib/ws

# Start implementation
# → marketStore.ts
# → btcturk-client.ts
# → throttle.ts
```

---

*Spark Trading Platform - V1.3 Live Data Plan*  
*"Real-time • Performant • Observable • Production-grade"* 🔴📊⚡🎯

